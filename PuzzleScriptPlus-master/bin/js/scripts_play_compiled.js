function storage_has(e){return null!==localStorage.getItem(e)}function storage_get(e){return localStorage.getItem(e)}function storage_set(e,n){return localStorage.setItem(e,n)}function storage_remove(e){localStorage.removeItem(e)}var unitTesting=!1,curlevel=0,solvedSections=[],curlevelTarget=null,hasUsedCheckpoint=!1,levelEditorOpened=!1,muted=0,runrulesonlevelstart_phase=!1,ignoreNotJustPressedAction=!0;function doSetupTitleScreenLevelContinue(){try{if(storage_has(document.URL)){if(storage_has(document.URL+"_checkpoint")){var e=storage_get(document.URL+"_checkpoint");curlevelTarget=JSON.parse(e);var n=[];for(var t in Object.keys(curlevelTarget.dat))n[t]=curlevelTarget.dat[t];curlevelTarget.dat=new Int32Array(n)}curlevel=storage_get(document.URL),void 0!==localStorage[document.URL+"_sections"]&&(solvedSections=JSON.parse(localStorage.getItem(document.URL+"_sections")))}}catch(e){}}doSetupTitleScreenLevelContinue();var verbose_logging=!1,throttle_movement=!1,cache_console_messages=!1,quittingTitleScreen=!1,quittingMessageScreen=!1,deltatime=17,timer=0,repeatinterval=150,autotick=0,autotickinterval=0,winning=!1,againing=!1,againinterval=150,norepeat_action=!1,oldflickscreendat=[],keybuffer=[],tweeninterval=0,tweentimer=0,restarting=!1,messageselected=!1,textImages={},initLevel={width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[],colCellContents:[],rowCellContents:[],colCellContents_Movements:[],rowCellContents_Movements:[]},level=initLevel;solving=!1;var canSetHTMLColors=!0,canDump=!1,canOpenEditor=!1,canYoutube=!0,IDE=!1;const diffToVisualize=null;function stripTags(e){var n=document.createElement("div");return n.innerHTML=e,n.textContent||n.innerText||""}function consolePrint(e,n){}function consolePrintFromRule(e,n,t){}function consoleCacheDump(e){}function consoleError(e,n){var t=document.getElementById("errormessage");t?(e=stripTags(e),t.innerHTML+=e+"<br>"):console.error(e,n)}function logErrorNoLine(e){var n=document.getElementById("errormessage");e=stripTags(e),n.innerHTML+=e+"<br>"}function logBetaMessage(e){var n=document.getElementById("errormessage");e=stripTags(e),n.innerHTML+=e+"<br>"}function clearInputHistory(){}function pushInput(e){}for(var font={0:"\n00000\n00000\n00000\n01110\n10001\n10011\n10101\n11001\n10001\n01110\n00000\n00000",1:"\n00000\n00000\n00000\n11100\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000",2:"\n00000\n00000\n00000\n11110\n00001\n00001\n01110\n10000\n10000\n11111\n00000\n00000",3:"\n00000\n00000\n00000\n11110\n00001\n00110\n00001\n00001\n00001\n11110\n00000\n00000",4:"\n00000\n00000\n00000\n10000\n10000\n10000\n10010\n11111\n00010\n00010\n00000\n00000",5:"\n00000\n00000\n00000\n11111\n10000\n11110\n00001\n00001\n00001\n11110\n00000\n00000",6:"\n00000\n00000\n00000\n01110\n10000\n11110\n10001\n10001\n10001\n01110\n00000\n00000",7:"\n00000\n00000\n00000\n11111\n00001\n00010\n00100\n00100\n00100\n00100\n00000\n00000",8:"\n00000\n00000\n00000\n01110\n10001\n01110\n10001\n10001\n10001\n01110\n00000\n00000",9:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n01111\n00001\n01110\n00000\n00000",a:"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000",b:"\n00000\n00000\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n01110\n00000\n00000",c:"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000",d:"\n00000\n00000\n00000\n00001\n00001\n01111\n10001\n10001\n10001\n01111\n00000\n00000",e:"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000",f:"\n00000\n00000\n00000\n00011\n00100\n11111\n00100\n00100\n00100\n00100\n00000\n00000",g:"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110",h:"\n00000\n00000\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n10001\n00000\n00000",i:"\n00000\n00000\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000",j:"\n00000\n00000\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n00100\n10100\n01000",k:"\n00000\n00000\n00000\n10000\n10000\n10001\n10010\n11100\n10010\n10001\n00000\n00000",l:"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00000",m:"\n00000\n00000\n00000\n00000\n00000\n01010\n10101\n10101\n10101\n10101\n00000\n00000",n:"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000",o:"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000",p:"\n00000\n00000\n00000\n00000\n00000\n11110\n10001\n10001\n10001\n11110\n10000\n10000",q:"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n00001",r:"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n00000\n00000",s:"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000",t:"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00100\n00011\n00000\n00000",u:"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000",v:"\n00000\n00000\n00000\n00000\n00000\n10001\n10010\n10100\n11000\n10000\n00000\n00000",w:"\n00000\n00000\n00000\n00000\n00000\n10101\n10101\n10101\n10101\n01010\n00000\n00000",x:"\n00000\n00000\n00000\n00000\n00000\n10001\n01010\n00100\n01010\n10001\n00000\n00000","×":"\n00000\n00000\n00000\n00000\n00000\n10001\n01010\n00100\n01010\n10001\n00000\n00000",y:"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00001\n11110",z:"\n00000\n00000\n00000\n00000\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000",A:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000",B:"\n00000\n00000\n00000\n11110\n10001\n11110\n10001\n10001\n10001\n11110\n00000\n00000",C:"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000",D:"\n00000\n00000\n00000\n11110\n10001\n10001\n10001\n10001\n10001\n11110\n00000\n00000",E:"\n00000\n00000\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000",F:"\n00000\n00000\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n10000\n00000\n00000",G:"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000",H:"\n00000\n00000\n00000\n10001\n10001\n11111\n10001\n10001\n10001\n10001\n00000\n00000",I:"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000",J:"\n00000\n00000\n00000\n01111\n00001\n00001\n00001\n00001\n00001\n01110\n00000\n00000",K:"\n00000\n00000\n00000\n10001\n10010\n10100\n11000\n10100\n10010\n10001\n00000\n00000",L:"\n00000\n00000\n00000\n10000\n10000\n10000\n10000\n10000\n10000\n11111\n00000\n00000",M:"\n00000\n00000\n00000\n11111\n10101\n10101\n10101\n10101\n10101\n10101\n00000\n00000",N:"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000",O:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000",P:"\n00000\n00000\n00000\n11110\n10001\n10001\n10001\n11110\n10000\n10000\n00000\n00000",Q:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n10101\n01110\n00100\n00000",R:"\n00000\n00000\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00000\n00000",S:"\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000",T:"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n00100\n00000\n00000",U:"\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000",V:"\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n10001\n01010\n00100\n00000\n00000",W:"\n00000\n00000\n00000\n10101\n10101\n10101\n10101\n10101\n10101\n01010\n00000\n00000",X:"\n00000\n00000\n00000\n10001\n10001\n01010\n00100\n01010\n10001\n10001\n00000\n00000",Y:"\n00000\n00000\n00000\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000",Z:"\n00000\n00000\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000",".":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000","·":"\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000\n00000\n00000\n00000","•":"\n00000\n00000\n00000\n00000\n00000\n01110\n01110\n01110\n00000\n00000\n00000\n00000","…":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n10101\n00000\n00000","†":"\n00000\n00100\n00100\n01110\n00100\n00100\n00100\n00100\n00100\n00100\n00000\n00000","‡":"\n00000\n00100\n00100\n01110\n00100\n00100\n00100\n00100\n01110\n00100\n00000\n00000","ƒ":"\n00000\n00000\n00000\n00011\n00100\n11111\n00100\n00100\n00100\n00100\n01000\n00000","‚":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n01100\n00000\n00000","„":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n01001\n11011\n00000\n00000",",":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n01100\n00000\n00000",";":"\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000\n00100\n01100\n00000\n00000",":":"\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000\n00000\n00100\n00000\n00000","?":"\n00000\n00000\n00000\n01110\n10001\n00001\n00001\n00110\n00000\n00100\n00000\n00000","¿":"\n00000\n00000\n00000\n00100\n00000\n01100\n10000\n10000\n10001\n01110\n00000\n00000","!":"\n00000\n00000\n00000\n00100\n00100\n00100\n00100\n00100\n00000\n00100\n00000\n00000","¡":"\n00000\n00000\n00000\n00100\n00000\n00100\n00100\n00100\n00100\n00100\n00000\n00000","@":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10111\n10000\n01110\n00000\n00000","£":"\n00000\n00000\n00000\n00000\n00000\n01110\n01001\n11100\n01000\n11111\n00000\n00000",$:"\n00000\n00000\n00000\n00000\n00100\n01111\n10100\n01110\n00101\n11110\n00100\n00000","%":"\n00000\n00000\n00000\n00000\n00000\n11001\n11010\n00100\n01011\n10011\n00000\n00000","‰":"\n00000\n00000\n00000\n00000\n11001\n11010\n00100\n01011\n10011\n00000\n00011\n00011","^":"\n00000\n00000\n00000\n00100\n01010\n00000\n00000\n00000\n00000\n00000\n00000\n00000","&":"\n00000\n00000\n00000\n00000\n00000\n01100\n10000\n01011\n10010\n01100\n00000\n00000","*":"\n00000\n00000\n00000\n00000\n00000\n01010\n00100\n01010\n00000\n00000\n00000\n00000","(":"\n00000\n00000\n00000\n00010\n00100\n00100\n00100\n00100\n00100\n00010\n00000\n00000",")":"\n00000\n00000\n00000\n01000\n00100\n00100\n00100\n00100\n00100\n01000\n00000\n00000","+":"\n00000\n00000\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00000\n00000","÷":"\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n11111\n00000\n00100\n00000\n00000","±":"\n00000\n00000\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n11111\n00000\n00000","-":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n01110\n00000\n00000\n00000\n00000","–":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n11110\n00000\n00000\n00000\n00000","—":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n11111\n00000\n00000\n00000\n00000",_:"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n11111\n00000\n00000","=":"\n00000\n00000\n00000\n00000\n00000\n00000\n11111\n00000\n11111\n00000\n00000\n00000"," ":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000","{":"\n00000\n00000\n00000\n00110\n00100\n00100\n01100\n00100\n00100\n00110\n00000\n00000","}":"\n00000\n00000\n00000\n01100\n00100\n00100\n00110\n00100\n00100\n01100\n00000\n00000","[":"\n00000\n00000\n00000\n00110\n00100\n00100\n00100\n00100\n00100\n00110\n00000\n00000","]":"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01100\n00000\n00000","'":"\n00000\n00000\n00000\n00100\n00100\n00100\n00000\n00000\n00000\n00000\n00000\n00000","‘":"\n00000\n00000\n00000\n00110\n00100\n00000\n00000\n00000\n00000\n00000\n00000\n00000","’":"\n00000\n00000\n00000\n00100\n01100\n00000\n00000\n00000\n00000\n00000\n00000\n00000","“":"\n00000\n00000\n00000\n11011\n10010\n00000\n00000\n00000\n00000\n00000\n00000\n00000","”":"\n00000\n00000\n00000\n01001\n11011\n00000\n00000\n00000\n00000\n00000\n00000\n00000",'"':"\n00000\n00000\n00000\n01010\n01010\n01010\n00000\n00000\n00000\n00000\n00000\n00000","/":"\n00000\n00000\n00000\n00000\n00000\n00001\n00010\n00100\n01000\n10000\n00000\n00000","\\":"\n00000\n00000\n00000\n00000\n00000\n10000\n01000\n00100\n00010\n00001\n00000\n00000","|":"\n00100\n00100\n00100\n00100\n00100\n00100\n00100\n00100\n00100\n00100\n00100\n00100","¦":"\n00000\n00000\n00000\n00000\n00100\n00100\n00000\n00100\n00100\n00100\n00000\n00000","<":"\n00000\n00000\n00000\n00000\n00000\n00010\n00100\n01000\n00100\n00010\n00000\n00000","‹":"\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n01000\n00100\n00000\n00000\n00000","«":"\n00000\n00000\n00000\n00000\n00000\n00000\n01001\n10010\n01001\n00000\n00000\n00000",">":"\n00000\n00000\n00000\n00000\n00000\n01000\n00100\n00010\n00100\n01000\n00000\n00000","›":"\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n00010\n00100\n00000\n00000\n00000","»":"\n00000\n00000\n00000\n00000\n00000\n00000\n10010\n01001\n10010\n00000\n00000\n00000","~":"\n00000\n00000\n00000\n00000\n00000\n00000\n01000\n10101\n00010\n00000\n00000\n00000","˜":"\n00000\n00000\n00000\n00000\n00000\n01010\n10100\n00000\n00000\n00000\n00000\n00000","`":"\n00000\n00000\n00000\n00000\n00000\n01000\n00100\n00000\n00000\n00000\n00000\n00000","#":"\n00000\n00000\n00000\n00000\n00000\n01010\n11111\n01010\n11111\n01010\n00000\n00000","À":"\n01000\n00100\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Á":"\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Â":"\n00100\n01010\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Ã":"\n01000\n10101\n00010\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Ä":"\n00000\n01010\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Å":"\n00100\n01010\n00100\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Æ":"\n00000\n00000\n00000\n01111\n10100\n10100\n10100\n11111\n10100\n10111\n00000\n00000","Ç":"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00100\n01000","È":"\n01000\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","É":"\n00010\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","Ê":"\n00100\n01010\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","Ë":"\n00000\n01010\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","Ì":"\n01000\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Í":"\n00010\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Î":"\n00100\n01010\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Ï":"\n00000\n01010\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Ð":"\n00000\n00000\n00000\n01110\n01001\n01001\n11101\n01001\n01001\n01110\n00000\n00000","Ñ":"\n01001\n10110\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000","Ò":"\n01000\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ó":"\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ô":"\n00100\n01010\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Õ":"\n01001\n10110\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ö":"\n00000\n01010\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ø":"\n00000\n00010\n00100\n01110\n10101\n10101\n10101\n10101\n10101\n01110\n00100\n01000","Ù":"\n00000\n01000\n00100\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ú":"\n00000\n00010\n00100\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Û":"\n00100\n01010\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ü":"\n00000\n01010\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ý":"\n\t00000\n\t00000\n\t00000\n\t00000\n\t00000\n\t10001\n\t10010\n\t10100\n\t11000\n\t10000\n\t00000\n\t00000","Þ":"\n00000\n00000\n10000\n11110\n10001\n10001\n10001\n10001\n10001\n11110\n10000\n00000","ß":"\n00000\n00000\n00000\n01110\n10001\n10110\n10001\n10001\n10001\n10110\n10000\n00000","ẞ":"\n00000\n00000\n00000\n01110\n10001\n10110\n10001\n10001\n10001\n10110\n00000\n00000","à":"\n00000\n00000\n01000\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","á":"\n00000\n00000\n00010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","â":"\n00000\n00000\n00100\n01010\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","ã":"\n00000\n00000\n01001\n10110\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","ä":"\n00000\n00000\n00000\n01010\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","å":"\n00000\n00100\n01010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","æ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10101\n10110\n10100\n01111\n00000\n00000","ç":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n01111\n00100\n01000","è":"\n00000\n00000\n01000\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","é":"\n00000\n00000\n00010\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","ê":"\n00000\n00000\n00100\n01010\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","ë":"\n00000\n00000\n00000\n01010\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","ì":"\n00000\n00000\n01000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","í":"\n00000\n00000\n00010\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","î":"\n00000\n00000\n00100\n01010\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","ï":"\n00000\n00000\n00000\n01010\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","ð":"\n00000\n00000\n00010\n00111\n00010\n01110\n10010\n10010\n10010\n01110\n00000\n00000","ñ":"\n\t00000\n\t00000\n\t00000\n\t00000\n\t00000\n\t01010\n\t10101\n\t10101\n\t10101\n\t10101\n\t00000\n\t00000","ò":"\n00000\n00000\n01000\n00100\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ó":"\n00000\n00000\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ô":"\n00000\n00000\n00100\n01010\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","õ":"\n00000\n00000\n01001\n10110\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ö":"\n00000\n00000\n00000\n01010\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ø":"\n00000\n00000\n00000\n00010\n00100\n01110\n10101\n10101\n10101\n01110\n00100\n01000","ù":"\n00000\n00000\n00000\n01000\n00100\n10001\n10001\n10001\n10001\n01111\n00000\n00000","ú":"\n00000\n00000\n00000\n00010\n00100\n10001\n10001\n10001\n10001\n01111\n00000\n00000","û":"\n00000\n00000\n00100\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","ü":"\n00000\n00000\n00000\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","ý":"\n00000\n00000\n00000\n00010\n00100\n10001\n10001\n10001\n10001\n01111\n00001\n11110","þ":"\n00000\n00000\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n11110\n10000\n10000","ÿ":"\n00000\n00000\n00000\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00001\n11110","Ā":"\n00000\n01110\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","ā":"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","Ă":"\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","ă":"\n00000\n00000\n01010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","Ą":"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00010\n00001","ą":"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00010\n00001","Ć":"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","ć":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Ĉ":"\n00100\n01010\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","ĉ":"\n00000\n00000\n00100\n01010\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Ċ":"\n00000\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","ċ":"\n00000\n00000\n00000\n00100\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Č":"\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","č":"\n00000\n00000\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Ď":"\n01010\n00100\n00000\n11110\n10001\n10001\n10001\n10001\n10001\n11110\n00000\n00000","ď":"\n\t00000\n\t00000\n\t00000\n\t00001\n\t00001\n\t01111\n\t10001\n\t10001\n\t10001\n\t01111\n\t00000\n\t00000","Đ":"\n00000\n00000\n00000\n01110\n01001\n01001\n11101\n01001\n01001\n01110\n00000\n00000","đ":"\n00000\n00000\n00010\n00111\n00010\n01110\n10010\n10010\n10010\n01110\n00000\n00000","Ē":"\n00000\n01110\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","ē":"\n00000\n00000\n00000\n01110\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ĕ":"\n01010\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","ĕ":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ė":"\n00000\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","ė":"\n00000\n00000\n00000\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ę":"\n00000\n00000\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00010\n00001","ę":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n11111\n10000\n01110\n00010\n00001","Ě":"\n01010\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11110\n00000\n00000","ě":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ĝ":"\n00100\n01010\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","ĝ":"\n00000\n00000\n00100\n01010\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110","Ğ":"\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","ğ":"\n00000\n00000\n01010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110","Ġ":"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","ġ":"\n00000\n00000\n00000\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110","Ģ":"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n01100","ģ":"\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","Ĥ":"\n00100\n01010\n00000\n10001\n10001\n11111\n10001\n10001\n10001\n10001\n00000\n00000","ĥ":"\n00100\n01010\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n10001\n00000\n00000","Ħ":"\n00000\n00000\n01010\n11111\n01010\n01110\n01010\n01010\n01010\n01010\n00000\n00000","ħ":"\n00000\n00000\n01000\n11100\n01000\n01110\n01001\n01001\n01001\n01001\n00000\n00000","Ĩ":"\n01001\n10110\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ĩ":"\n01010\n10100\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Ī":"\n00000\n01110\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ī":"\n00000\n00000\n00000\n01110\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Ĭ":"\n01010\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ĭ":"\n00000\n00000\n01010\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Į":"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00010\n00001","į":"\n00000\n00000\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","İ":"\n00000\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ı":"\n00000\n00000\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Ĳ":"\n00000\n00000\n00000\n10010\n10010\n10010\n10010\n10010\n10010\n10110\n00000\n00000","ĳ":"\n00000\n00000\n00000\n01001\n00000\n11001\n01001\n01001\n01001\n11101\n00001\n00010","Ĵ":"\n00010\n00101\n00000\n01111\n00001\n00001\n00001\n00001\n00001\n01110\n00000\n00000","ĵ":"\n00000\n00000\n00100\n01010\n00000\n01100\n00100\n00100\n00100\n00100\n10100\n01000","Ķ":"\n00000\n00000\n00000\n10001\n10010\n10100\n11000\n10100\n10010\n10001\n00100\n01000","ķ":"\n00000\n00000\n00000\n10000\n10000\n10001\n10010\n11100\n10010\n10001\n00000\n00000","ĸ":"\n00000\n00000\n00000\n00000\n00000\n10001\n10010\n11100\n10010\n10001\n00000\n00000","Ĺ":"\n00000\n00000\n00000\n10000\n10000\n10000\n10000\n10000\n10000\n11111\n00000\n00000","ĺ":"\n00010\n00100\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00000","Ļ":"\n00000\n00000\n00000\n10000\n10000\n10000\n10000\n10000\n10000\n11111\n00000\n00100","ļ":"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00100","Ľ":"\n00000\n00000\n00000\n10010\n10010\n10000\n10000\n10000\n10000\n11111\n00000\n00000","ľ":"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00000","Ŀ":"\n00000\n00000\n00000\n10000\n10000\n10100\n10000\n10000\n10000\n11111\n00000\n00000","ŀ":"\n00000\n00000\n00000\n01100\n00100\n00100\n00101\n00100\n00100\n01110\n00000\n00000","Ł":"\n00000\n00000\n00000\n01000\n01010\n01100\n11000\n01000\n01000\n01111\n00000\n00000","ł":"\n00000\n00000\n00000\n01100\n00100\n00100\n00110\n01100\n00100\n01110\n00000\n00000","Ń":"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000","ń":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000","Ņ":"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00100\n01000","ņ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00100\n01000","Ň":"\n00000\n01010\n00100\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000","ň":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000","ŉ":"\n00000\n00000\n00000\n10000\n10000\n00110\n01001\n01001\n01001\n01001\n00000\n00000","Ŋ":"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00001\n00010","ŋ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00001\n00010","Ō":"\n00000\n01110\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ō":"\n00000\n00000\n00000\n01110\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","Ŏ":"\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ŏ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","Ő":"\n01001\n10010\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ő":"\n00000\n00000\n01001\n10010\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","Œ":"\n00000\n00000\n00000\n01111\n10100\n10100\n10111\n10100\n10100\n01111\n00000\n00000","œ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10101\n10110\n10100\n01111\n00000\n00000","Ŕ":"\n00010\n00100\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00000\n00000","ŕ":"\n00000\n00000\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n00000\n00000","Ŗ":"\n00000\n00000\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00100\n01000","ŗ":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n00100\n01000","Ř":"\n01010\n00100\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00000\n00000","ř":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n00000\n00000","Ś":"\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000","ś":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000","Ŝ":"\n00100\n01010\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000","ŝ":"\n00000\n00000\n00100\n01010\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000","Ş":"\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00100\n00000","ş":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n11110\n00100\n01000","Š":"\n01010\n00100\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000","š":"\n00000\n00000\n01010\n00100\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000","Ţ":"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n00100\n00010\n00100","ţ":"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00100\n00011\n00000\n01100","Ť":"\n01010\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n00100\n00000\n00000","ť":"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00100\n00011\n00000\n00000","Ŧ":"\n00000\n00000\n00000\n11111\n00100\n00100\n01110\n00100\n00100\n00100\n00000\n00000","ŧ":"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n01110\n00100\n00011\n00000\n00000","Ũ":"\n01001\n10110\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ũ":"\n00000\n00000\n01001\n10110\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ū":"\n00000\n01110\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ū":"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ŭ":"\n01010\n00100\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ŭ":"\n00000\n00000\n01010\n00100\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ů":"\n00100\n01010\n00100\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ů":"\n00000\n00000\n00100\n01010\n00100\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ű":"\n01001\n10010\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ű":"\n00000\n00000\n01001\n10010\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ų":"\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00100\n00010","ų":"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00010\n00001","Ŵ":"\n00100\n01010\n00000\n10101\n10101\n10101\n10101\n10101\n10101\n01010\n00000\n00000","ŵ":"\n00000\n00000\n00000\n00000\n00000\n10101\n10101\n10101\n10101\n01010\n00000\n00000","Ŷ":"\n00100\n01010\n00000\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000","ŷ":"\n00000\n00000\n00100\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00001\n11110","Ÿ":"\n00000\n01010\n00000\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000","Ź":"\n00010\n00100\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000","ź":"\n00000\n00000\n00010\n00100\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000","Ż":"\n00000\n00100\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000","ż":"\n00000\n00000\n00000\n00100\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000","Ž":"\n01010\n00100\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000","ž":"\n00000\n00000\n01010\n00100\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000","€":"\n00000\n00000\n00000\n00111\n01000\n11110\n01000\n11110\n01000\n00111\n00000\n00000","™":"\n00000\n11111\n00100\n00100\n00100\n00000\n01010\n10101\n10101\n10101\n00000\n00000","¢":"\n00000\n00000\n00000\n00010\n00100\n01111\n10100\n10100\n10100\n01111\n00100\n01000","¤":"\n00000\n00000\n00000\n00000\n10001\n01110\n10001\n10001\n01110\n10001\n00000\n00000","¥":"\n00000\n00000\n10001\n01010\n00100\n01110\n00100\n01110\n00100\n00000\n00000","§":"\n00000\n00000\n00000\n01110\n10000\n01110\n10001\n01110\n00001\n01110\n00000\n00000","¨":"\n00000\n00000\n00000\n01010\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000","©":"\n00000\n00000\n00000\n01110\n10001\n10111\n10101\n10111\n10001\n01110\n00000\n00000","®":"\n00000\n00000\n00000\n01110\n10001\n10111\n10101\n10101\n10001\n01110\n00000\n00000","ª":"\n00000\n01110\n00010\n01110\n01010\n01110\n00000\n00000\n00000\n00000\n00000\n00000","º":"\n00000\n00100\n01010\n01010\n01010\n00100\n00000\n00000\n00000\n00000\n00000\n00000","¬":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n01110\n00010\n00000\n00000\n00000","¯":"\n00000\n00000\n00000\n01110\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000","°":"\n00000\n00000\n00100\n01010\n00100\n00000\n00000\n00000\n00000\n00000\n00000\n00000","✓":"\n00000\n00000\n00000\n00000\n00000\n00001\n00010\n10100\n01000\n00000\n00000\n00000"},fontKeys=Object.keys(font),fontIndex={},i=0;i<fontKeys.length;i++)fontIndex[fontKeys[i]]=i;function RC4(e){this.s=new Array(256),this.i=0,this.j=0;for(var n=0;n<256;n++)this.s[n]=n;e&&this.mix(e)}function print_call_stack(){var e=(new Error).stack;console.log(e)}function RNG(e){this.seed=e,null==e?e=(Math.random()+Date.now()).toString():"function"==typeof e?(this.uniform=e,this.nextByte=function(){return~~(256*this.uniform())},e=null):"[object String]"!==Object.prototype.toString.call(e)&&(e=JSON.stringify(e)),this._normal=null,this._state=e?new RC4(e):null}
/**
 * Seedable random number generator functions.
 * @version 1.0.0
 * @license Public Domain
 *
 * @example
 * var rng = new RNG('Example');
 * rng.random(40, 50);  // =>  42
 * rng.uniform();       // =>  0.7972798995050903
 * rng.normal();        // => -0.6698504543216376
 * rng.exponential();   // =>  1.0547367609131555
 * rng.poisson(4);      // =>  2
 * rng.gamma(4);        // =>  2.781724687386858
 */
String.prototype.getBytes=function(){for(var e=[],n=0;n<this.length;n++){var t=this.charCodeAt(n),r=[];do{r.push(255&t),t>>=8}while(t>0);e=e.concat(r.reverse())}return e},RC4.prototype._swap=function(e,n){var t=this.s[e];this.s[e]=this.s[n],this.s[n]=t},RC4.prototype.mix=function(e){for(var n=e.getBytes(),t=0,r=0;r<this.s.length;r++)t+=this.s[r]+n[r%n.length],t%=256,this._swap(r,t)},RC4.prototype.next=function(){return this.i=(this.i+1)%256,this.j=(this.j+this.s[this.i])%256,this._swap(this.i,this.j),this.s[(this.s[this.i]+this.s[this.j])%256]},RNG.prototype.nextByte=function(){return this._state.next()},RNG.prototype.uniform=function(){for(var e=0,n=0;n<7;n++)e*=256,e+=this.nextByte();return e/(Math.pow(2,56)-1)},RNG.prototype.random=function(e,n){return null==e?this.uniform():(null==n&&(n=e,e=0),e+Math.floor(this.uniform()*(n-e)))},RNG.prototype.normal=function(){if(null!==this._normal){var e=this._normal;return this._normal=null,e}var n=this.uniform()||Math.pow(2,-53),t=this.uniform();return this._normal=Math.sqrt(-2*Math.log(n))*Math.sin(2*Math.PI*t),Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*t)},RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))},RNG.prototype.poisson=function(e){var n=Math.exp(-(e||1)),t=0,r=1;do{t++,r*=this.uniform()}while(r>n);return t-1},RNG.prototype.gamma=function(e){var n=(e<1?1+e:e)-1/3,t=1/Math.sqrt(9*n);do{do{var r=this.normal(),o=Math.pow(t*r+1,3)}while(o<=0);var a=this.uniform(),i=Math.pow(r,2)}while(a>=1-.0331*i*i&&Math.log(a)>=.5*i+n*(1-o+Math.log(o)));return e<1?n*o*Math.exp(this.exponential()/-e):n*o},RNG.roller=function(e,n){var t=e.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),r=parseFloat(t[0])||1,o=parseFloat(t[1]),a=parseFloat(t[2])||0;return n=n||new RNG,function(){for(var e=r+a,t=0;t<r;t++)e+=n.random(o);return e}};var FastBase64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",FastBase64_encLookup=[];function FastBase64_Init(){for(var e=0;e<4096;e++)FastBase64_encLookup[e]=FastBase64_chars[e>>6]+FastBase64_chars[63&e]}function FastBase64_Encode(e){for(var t=e.length,r="",o=0;t>2;)n=e[o]<<16|e[o+1]<<8|e[o+2],r+=FastBase64_encLookup[n>>12]+FastBase64_encLookup[4095&n],t-=3,o+=3;if(t>0){var a=(252&e[o])>>2,i=(3&e[o])<<4;if(t>1&&(i|=(240&e[++o])>>4),r+=FastBase64_chars[a],r+=FastBase64_chars[i],2==t){var l=(15&e[o++])<<2;l|=(192&e[o])>>6,r+=FastBase64_chars[l]}1==t&&(r+="="),r+="="}return r}function u32ToArray(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function u16ToArray(e){return[255&e,e>>8&255]}function MakeRiff(e,n,t){var r,o={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:e,byteRate:0,blockAlign:0,bitsPerSample:n,subChunk2Id:[100,97,116,97],subChunk2Size:0};return o.byteRate=o.sampleRate*o.numChannels*o.bitsPerSample>>3,o.blockAlign=o.numChannels*o.bitsPerSample>>3,o.subChunk2Size=t.length,o.chunkSize=36+o.subChunk2Size,{dat:[],wav:r=o.chunkId.concat(u32ToArray(o.chunkSize),o.format,o.subChunk1Id,u32ToArray(o.subChunk1Size),u16ToArray(o.audioFormat),u16ToArray(o.numChannels),u32ToArray(o.sampleRate),u32ToArray(o.byteRate),u16ToArray(o.blockAlign),u16ToArray(o.bitsPerSample),o.subChunk2Id,u32ToArray(o.subChunk2Size),t),header:o,dataURI:"data:audio/wav;base64,"+FastBase64_Encode(r)}}FastBase64_Init(),"undefined"!=typeof exports&&(exports.RIFFWAVE=RIFFWAVE);var AUDIO_CONTEXT,SOUND_VOL=.25,QUIET_SOUND_VOL=.1,SAMPLE_RATE=5512,BIT_DEPTH=8,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,TRIANGLE=4,BREAKER=5,SHAPES=["square","sawtooth","sine","noise","triangle","breaker"];function checkAudioContextExists(){try{null==AUDIO_CONTEXT&&("undefined"!=typeof AudioContext?AUDIO_CONTEXT=new AudioContext:"undefined"!=typeof webkitAudioContext&&(AUDIO_CONTEXT=new webkitAudioContext))}catch(e){window.console.log(e)}}checkAudioContextExists();var rng,masterVolume=1;function Params(){var e={};return e.wave_type=SQUARE,e.p_env_attack=0,e.p_env_sustain=.3,e.p_env_punch=0,e.p_env_decay=.4,e.p_base_freq=.3,e.p_freq_limit=0,e.p_freq_ramp=0,e.p_freq_dramp=0,e.p_vib_strength=0,e.p_vib_speed=0,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=0,e.p_duty_ramp=0,e.p_repeat_speed=0,e.p_pha_offset=0,e.p_pha_ramp=0,e.p_lpf_freq=1,e.p_lpf_ramp=0,e.p_lpf_resonance=0,e.p_hpf_freq=0,e.p_hpf_ramp=0,e.sound_vol=.5,e.sample_rate=44100,e.bit_depth=8,e}var seeded=!1;function frnd(e){return seeded?rng.uniform()*e:Math.random()*e}function rnd(e){return seeded?Math.floor(rng.uniform()*(e+1)):Math.floor(Math.random()*(e+1))}pickupCoin=function(){var e=Params();if(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=0),e.p_base_freq=.4+frnd(.5),e.p_env_attack=0,e.p_env_sustain=frnd(.1),e.p_env_decay=.1+frnd(.4),e.p_env_punch=.3+frnd(.3),rnd(1)){e.p_arp_speed=.5+frnd(.2);var n=1+(1|frnd(7)),t=n+(1|frnd(7))+2;e.p_arp_mod=+n/+t}return e},laserShoot=function(){var e=Params();return e.wave_type=rnd(2),e.wave_type===SINE&&rnd(1)&&(e.wave_type=rnd(1)),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_base_freq=.5+frnd(.5),e.p_freq_limit=e.p_base_freq-.2-frnd(.6),e.p_freq_limit<.2&&(e.p_freq_limit=.2),e.p_freq_ramp=-.15-frnd(.2),0===rnd(2)&&(e.p_base_freq=.3+frnd(.6),e.p_freq_limit=frnd(.1),e.p_freq_ramp=-.35-frnd(.3)),rnd(1)?(e.p_duty=frnd(.5),e.p_duty_ramp=frnd(.2)):(e.p_duty=.4+frnd(.5),e.p_duty_ramp=-frnd(.7)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.2),e.p_env_decay=frnd(.4),rnd(1)&&(e.p_env_punch=frnd(.3)),0===rnd(2)&&(e.p_pha_offset=frnd(.2),e.p_pha_ramp=-frnd(.2)),rnd(1)&&(e.p_hpf_freq=frnd(.3)),e},explosion=function(){var e=Params();return rnd(1)?(e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=-.1+frnd(.4)):(e.p_base_freq=.2+frnd(.7),e.p_freq_ramp=-.2-frnd(.2)),e.p_base_freq*=e.p_base_freq,0===rnd(4)&&(e.p_freq_ramp=0),0===rnd(2)&&(e.p_repeat_speed=.3+frnd(.5)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.3),e.p_env_decay=frnd(.5),0===rnd(1)&&(e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3)),e.p_env_punch=.2+frnd(.6),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6)),0===rnd(2)&&(e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6)),e},birdSound=function(){var e=Params();return frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,frnd(1)<.5&&(e.p_freq_ramp=.1+frnd(.15)),e.p_freq_dramp=.004598608156964473+frnd(.1)-.05,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.601486018931999+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.5277795946672003+frnd(.2)-.1,e.p_env_sustain=.18243733568468432+frnd(.2)-.1,e.p_env_punch=-.020159754546840117+frnd(.2)-.1,e.p_env_decay=.1561353422051903+frnd(.2)-.1,e.p_base_freq=.9028855606533718+frnd(.2)-.1,e.p_freq_limit=-.008842787837148716,e.p_freq_ramp=-.1,e.p_freq_dramp=-.012891241489551925,e.p_vib_strength=-.17923136138403065+frnd(.2)-.1,e.p_vib_speed=.908263385610142+frnd(.2)-.1,e.p_arp_mod=.41690153355414894+frnd(.2)-.1,e.p_arp_speed=.0010766233195860704+frnd(.2)-.1,e.p_duty=-.8735363011184684+frnd(.2)-.1,e.p_duty_ramp=-.7397985366747507+frnd(.2)-.1,e.p_repeat_speed=.0591789344172107+frnd(.2)-.1,e.p_pha_offset=-.9961184222777699+frnd(.2)-.1,e.p_pha_ramp=-.08234769395850523+frnd(.2)-.1,e.p_lpf_freq=.9412475115697335+frnd(.2)-.1,e.p_lpf_ramp=-.18261358925834958+frnd(.2)-.1,e.p_lpf_resonance=.24541438107389477+frnd(.2)-.1,e.p_hpf_freq=-.01831940280978611+frnd(.2)-.1,e.p_hpf_ramp=-.03857383633171346+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,e.p_freq_dramp=.004598608156964473+frnd(.2)-.1,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=-.46410459213693644+frnd(.2)-.1,e.p_arp_speed=-.10955361249587248+frnd(.2)-.1,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.7014860189319991+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(5)>1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_arp_mod=.2697849293151393+frnd(.2)-.1,e.p_arp_speed=-.3131172257760948+frnd(.2)-.1,e.p_base_freq=.8090588299313949+frnd(.2)-.1,e.p_duty=-.6210022920964955+frnd(.2)-.1,e.p_duty_ramp=-.00043441813553182567+frnd(.2)-.1,e.p_env_attack=.004321877246874195+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.061737781504416146+frnd(.2)-.1,e.p_env_sustain=.4987252564798832+frnd(.2)-.1,e.p_freq_dramp=.31700340314222614+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.163380391341416+frnd(.2)-.1,e.p_hpf_freq=.4709005021145149+frnd(.2)-.1,e.p_hpf_ramp=.6924667290539194+frnd(.2)-.1,e.p_lpf_freq=.8351398631384511+frnd(.2)-.1,e.p_lpf_ramp=.36616557192873134+frnd(.2)-.1,e.p_lpf_resonance=-.08685777111664439+frnd(.2)-.1,e.p_pha_offset=-.036084571580025544+frnd(.2)-.1,e.p_pha_ramp=-.014806445085568108+frnd(.2)-.1,e.p_repeat_speed=-.8094368475518489+frnd(.2)-.1,e.p_vib_speed=.4496665457171294+frnd(.2)-.1,e.p_vib_strength=.23413762515532424+frnd(.2)-.1):(e.p_arp_mod=-.35697118026766184+frnd(.2)-.1,e.p_arp_speed=.3581140690559588+frnd(.2)-.1,e.p_base_freq=1.3260897696157528+frnd(.2)-.1,e.p_duty=-.30984900436710694+frnd(.2)-.1,e.p_duty_ramp=-.0014374759133411626+frnd(.2)-.1,e.p_env_attack=.3160357835682254+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.24323114016870148+frnd(.2)-.1,e.p_env_sustain=.4+frnd(.2)-.1,e.p_freq_dramp=.2866475886237244+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.10956352368742976+frnd(.2)-.1,e.p_hpf_freq=.20772718017889846+frnd(.2)-.1,e.p_hpf_ramp=.1564090637378835+frnd(.2)-.1,e.p_lpf_freq=.6021372770637031+frnd(.2)-.1,e.p_lpf_ramp=.24016227139979027+frnd(.2)-.1,e.p_lpf_resonance=-.08787383821160144+frnd(.2)-.1,e.p_pha_offset=-.381597686151701+frnd(.2)-.1,e.p_pha_ramp=-.0002481687661373495+frnd(.2)-.1,e.p_repeat_speed=.07812112809425686+frnd(.2)-.1,e.p_vib_speed=-.13648848579133943+frnd(.2)-.1,e.p_vib_strength=.0018874158972302657+frnd(.2)-.1),e):(e.wave_type=Math.floor(frnd(SHAPES.length)),1!==e.wave_type&&3!==e.wave_type||(e.wave_type=2),e.p_base_freq=.85+frnd(.15),e.p_freq_ramp=.3+frnd(.15),e.p_env_attack=0+frnd(.09),e.p_env_sustain=.2+frnd(.3),e.p_env_decay=0+frnd(.1),e.p_duty=frnd(2)-1,e.p_duty_ramp=Math.pow(frnd(2)-1,3),e.p_repeat_speed=.5+frnd(.1),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.4+frnd(.6),e.p_arp_mod=.8+frnd(.1),e.p_lpf_resonance=frnd(2)-1,e.p_lpf_freq=1-Math.pow(frnd(1),3),e.p_lpf_ramp=Math.pow(frnd(2)-1,3),e.p_lpf_freq<.1&&e.p_lpf_ramp<-.05&&(e.p_lpf_ramp=-e.p_lpf_ramp),e.p_hpf_freq=Math.pow(frnd(1),5),e.p_hpf_ramp=Math.pow(frnd(2)-1,5),e)},pushSound=function(){var e=Params();return e.wave_type=Math.floor(frnd(SHAPES.length)),2===e.wave_type&&e.wave_type++,0===e.wave_type&&(e.wave_type=NOISE),e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=.05+frnd(.2),e.p_env_attack=.01+frnd(.09),e.p_env_sustain=.01+frnd(.09),e.p_env_decay=.01+frnd(.09),e.p_repeat_speed=.3+frnd(.5),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6),e},powerUp=function(){var e=Params();return rnd(1)?e.wave_type=SAWTOOTH:e.p_duty=frnd(.6),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.1+frnd(.4),e.p_repeat_speed=.4+frnd(.4)):(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.05+frnd(.2),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6))),e.p_env_attack=0,e.p_env_sustain=frnd(.4),e.p_env_decay=.1+frnd(.4),e},hitHurt=function(){return result=Params(),result.wave_type=rnd(2),result.wave_type===SINE&&(result.wave_type=NOISE),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=.2+frnd(.6),result.p_freq_ramp=-.3-frnd(.4),result.p_env_attack=0,result.p_env_sustain=frnd(.1),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),result},jump=function(){return result=Params(),result.wave_type=SQUARE,result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=SQUARE),result.p_duty=frnd(.6),result.p_base_freq=.3+frnd(.3),result.p_freq_ramp=.1+frnd(.2),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.3),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),rnd(1)&&(result.p_lpf_freq=1-frnd(.6)),result},blipSelect=function(){return result=Params(),result.wave_type=rnd(1),result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=rnd(1)),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.p_base_freq=.2+frnd(.4),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.1),result.p_env_decay=frnd(.2),result.p_hpf_freq=.1,result},random=function(){return result=Params(),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=Math.pow(frnd(2)-1,2),rnd(1)&&(result.p_base_freq=Math.pow(frnd(2)-1,3)+.5),result.p_freq_limit=0,result.p_freq_ramp=Math.pow(frnd(2)-1,5),result.p_base_freq>.7&&result.p_freq_ramp>.2&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_base_freq<.2&&result.p_freq_ramp<-.05&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_freq_dramp=Math.pow(frnd(2)-1,3),result.p_duty=frnd(2)-1,result.p_duty_ramp=Math.pow(frnd(2)-1,3),result.p_vib_strength=Math.pow(frnd(2)-1,3),result.p_vib_speed=frnd(2)-1,result.p_env_attack=Math.pow(frnd(2)-1,3),result.p_env_sustain=Math.pow(frnd(2)-1,2),result.p_env_decay=frnd(2)-1,result.p_env_punch=Math.pow(frnd(.8),2),result.p_env_attack+result.p_env_sustain+result.p_env_decay<.2&&(result.p_env_sustain+=.2+frnd(.3),result.p_env_decay+=.2+frnd(.3)),result.p_lpf_resonance=frnd(2)-1,result.p_lpf_freq=1-Math.pow(frnd(1),3),result.p_lpf_ramp=Math.pow(frnd(2)-1,3),result.p_lpf_freq<.1&&result.p_lpf_ramp<-.05&&(result.p_lpf_ramp=-result.p_lpf_ramp),result.p_hpf_freq=Math.pow(frnd(1),5),result.p_hpf_ramp=Math.pow(frnd(2)-1,5),result.p_pha_offset=Math.pow(frnd(2)-1,3),result.p_pha_ramp=Math.pow(frnd(2)-1,3),result.p_repeat_speed=frnd(2)-1,result.p_arp_speed=frnd(2)-1,result.p_arp_mod=frnd(2)-1,result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound],generatorNames=["pickupCoin","laserShoot","explosion","powerUp","hitHurt","jump","blipSelect","pushSound","random","birdSound"];function SoundEffect(e,n){this._buffer=AUDIO_CONTEXT.createBuffer(1,e,n)}function ULBS(){if("suspended"===AUDIO_CONTEXT.state){var e=function(){AUDIO_CONTEXT.resume().then((function(){document.body.removeEventListener("touchstart",e),document.body.removeEventListener("touchend",e),document.body.removeEventListener("mousedown",e),document.body.removeEventListener("mouseup",e),document.body.removeEventListener("keydown",e),document.body.removeEventListener("keyup",e)}))};document.body.addEventListener("touchstart",e,!1),document.body.addEventListener("touchend",e,!1),document.body.addEventListener("mousedown",e,!1),document.body.addEventListener("mouseup",e,!1),document.body.addEventListener("keydown",e,!1),document.body.addEventListener("keyup",e,!1)}}if(generateFromSeed=function(e){rng=new RNG(e/100|0);var n=generators[e%100%generators.length];seeded=!0;var t=n();return t.seed=e,seeded=!1,t},SoundEffect.prototype.getBuffer=function(){return this._buffer.getChannelData(0)},SoundEffect.prototype.play=function(){ULBS();var e=AUDIO_CONTEXT.createBufferSource(),n=AUDIO_CONTEXT.createBiquadFilter(),t=AUDIO_CONTEXT.createBiquadFilter(),r=AUDIO_CONTEXT.createBiquadFilter();e.buffer=this._buffer,e.connect(n),n.frequency.value=1600,t.frequency.value=1600,r.frequency.value=1600,n.connect(t),t.connect(r),r.connect(AUDIO_CONTEXT.destination);var o=AUDIO_CONTEXT.currentTime;void 0!==e.start?e.start(o):e.noteOn(o),e.onended=function(){r.disconnect()}},SoundEffect.MIN_SAMPLE_RATE=22050,void 0===AUDIO_CONTEXT&&((SoundEffect=function(e,n){this._sample_rate=n,this._buffer=new Array(e),this._audioElement=null}).prototype.getBuffer=function(){return this._audioElement=null,this._buffer},SoundEffect.prototype.play=function(){if(this._audioElement)this._audioElement.cloneNode(!1).play();else{for(var e=0;e<this._buffer.length;e++)this._buffer[e]=255&Math.floor(128*Math.max(0,Math.min(this._buffer[e]+1,2)));var n=MakeRiff(this._sample_rate,BIT_DEPTH,this._buffer);this._audioElement=new Audio,this._audioElement.src=n.dataURI,this._audioElement.play()}},SoundEffect.MIN_SAMPLE_RATE=1),SoundEffect.generate=function(e){function n(){t=0,r=100/(e.p_base_freq*e.p_base_freq+.001),o=Math.floor(r),a=100/(e.p_freq_limit*e.p_freq_limit+.001),i=1-.01*Math.pow(e.p_freq_ramp,3),l=1e-6*-Math.pow(e.p_freq_dramp,3),s=.5-.5*e.p_duty,c=5e-5*-e.p_duty_ramp,d=e.p_arp_mod>=0?1-.9*Math.pow(e.p_arp_mod,2):1+10*Math.pow(e.p_arp_mod,2),0,u=Math.floor(2e4*Math.pow(1-e.p_arp_speed,2)+32),1==e.p_arp_speed&&(u=0)}var t,r,o,a,i,l,s,c,d,u;n();var h=0,f=0,p=.1*Math.pow(e.p_lpf_freq,3),g=1+1e-4*e.p_lpf_ramp,m=5/(1+20*Math.pow(e.p_lpf_resonance,2))*(.01+p);m>.8&&(m=.8);var v=0,_=.1*Math.pow(e.p_hpf_freq,2),y=1+3e-4*e.p_hpf_ramp,b=0,w=.01*Math.pow(e.p_vib_speed,2),S=.5*e.p_vib_strength,k=0,x=0,M=0,C=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],I=C[0]+C[1]+C[2],E=0,T=1020*Math.pow(e.p_pha_offset,2);e.p_pha_offset<0&&(T=-T);var A=1*Math.pow(e.p_pha_ramp,2);e.p_pha_ramp<0&&(A=-A);for(var R=Math.abs(Math.floor(T)),F=0,O=[],D=0;D<1024;++D)O[D]=0;var P=[];for(D=0;D<32;++D)P[D]=2*Math.random()-1;var L=Math.floor(2e4*Math.pow(1-e.p_repeat_speed,2)+32);0==e.p_repeat_speed&&(L=0);for(var N,B=e.sound_vol,j=(B=Math.exp(e.sound_vol)-1,0),q=0,V=Math.floor(44100/e.sample_rate),z=0,G=Math.ceil(I/V),U=(N=e.sample_rate<SoundEffect.MIN_SAMPLE_RATE?new SoundEffect(4*G,SoundEffect.MIN_SAMPLE_RATE):new SoundEffect(G,e.sample_rate)).getBuffer(),H=0;;++H){0!=L&&++t>=L&&n(),0!=u&&H>=u&&(u=0,r*=d),(r*=i+=l)>a&&(r=a,e.p_freq_limit>0&&!0);var W=r;if(S>0&&(b+=w,W=r*(1+Math.sin(b)*S)),(o=Math.floor(W))<8&&(o=8),(s+=c)<0&&(s=0),s>.5&&(s=.5),++M>C[x]){for(M=1,x++;x<3&&0===C[x];)x++;if(3===x)break}k=0===x?M/C[0]:1===x?1+2*Math.pow(1-M/C[1],1)*e.p_env_punch:1-M/C[2],T+=A,(R=Math.abs(Math.floor(T)))>1023&&(R=1023),0!=y&&((_*=y)<1e-5&&(_=1e-5),_>.1&&(_=.1));for(var X=0,Y=0;Y<8;++Y){var Q=0;if(++E>=o&&(E%=o,e.wave_type===NOISE))for(D=0;D<32;++D)P[D]=2*Math.random()-1;var J=E/o;if(e.wave_type===SQUARE)Q=J<s?.5:-.5;else if(e.wave_type===SAWTOOTH)Q=1-2*J;else if(e.wave_type===SINE)Q=Math.sin(2*J*Math.PI);else if(e.wave_type===NOISE)Q=P[Math.floor(32*E/o)];else if(e.wave_type===TRIANGLE)Q=Math.abs(1-2*J)-1;else{if(e.wave_type!==BREAKER)throw new Exception("bad wave type! "+e.wave_type);Q=Math.abs(1-J*J*2)-1}var K=h;(p*=g)<0&&(p=0),p>.1&&(p=.1),1!=e.p_lpf_freq?(f+=(Q-h)*p,f-=f*m):(h=Q,f=0),v+=(h+=f)-K,Q=v-=v*_,O[1023&F]=Q,Q+=O[F-R+1024&1023],F=F+1&1023,X+=Q*k}j+=X,++q>=V&&(q=0,X=j/V,j=0,X=X/8*masterVolume,X*=B,U[z++]=X,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(U[z++]=X,U[z++]=X,U[z++]=X))}return V>0&&(X=(X=j/V)/8*masterVolume,X*=B,U[z++]=X,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(U[z++]=X,U[z++]=X,U[z++]=X)),N},"undefined"!=typeof exports){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params,exports.generate=generate}var sfxCache={},cachedSeeds=[],CACHE_MAX=50;function cacheSeed(e){if(e in sfxCache)return sfxCache[e];var n=generateFromSeed(e);n.sound_vol=SOUND_VOL,n.sample_rate=SAMPLE_RATE,n.bit_depth=BIT_DEPTH;var t=SoundEffect.generate(n);for(sfxCache[e]=t,cachedSeeds.push(e);cachedSeeds.length>CACHE_MAX;){var r=cachedSeeds[0];cachedSeeds=cachedSeeds.slice(1),delete sfxCache[r]}return t}function cacheQuietSeed(e){if(e in sfxCache)return sfxCache[e];var n=generateFromSeed(e);n.sound_vol=QUIET_SOUND_VOL,n.sample_rate=SAMPLE_RATE,n.bit_depth=BIT_DEPTH;var t=SoundEffect.generate(n);for(sfxCache[e]=t,cachedSeeds.push(e);cachedSeeds.length>CACHE_MAX;){var r=cachedSeeds[0];cachedSeeds=cachedSeeds.slice(1),delete sfxCache[r]}return t}function playSound(e){muted||(checkAudioContextExists(),unitTesting||cacheSeed(e).play())}function playQuietSound(e){muted||(checkAudioContextExists(),unitTesting||cacheQuietSeed(e).play())}function killAudioButton(){var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.remove(),n.remove())}function showAudioButton(){var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.style.display="block",n.style.display="none")}function toggleMute(){0===muted?muteAudio():unMuteAudio()}function muteAudio(){muted=1,tryDeactivateYoutube();var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.style.display="none",n.style.display="block")}function unMuteAudio(){muted=0,tryActivateYoutube();var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.style.display="block",n.style.display="none")}function CodeMirror(e,n){}
/*!
 *  howler.js v2.2.3
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */
!function(){"use strict";var e=function(){this.init()};e.prototype={init:function(){var e=this||n;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var t=this||n;if(e=parseFloat(e),t.ctx||c(),void 0!==e&&e>=0&&e<=1){if(t._volume=e,t._muted)return t;t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e,n.ctx.currentTime);for(var r=0;r<t._howls.length;r++)if(!t._howls[r]._webAudio)for(var o=t._howls[r]._getSoundIds(),a=0;a<o.length;a++){var i=t._howls[r]._soundById(o[a]);i&&i._node&&(i._node.volume=i._volume*e)}return t}return t._volume},mute:function(e){var t=this||n;t.ctx||c(),t._muted=e,t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e?0:t._volume,n.ctx.currentTime);for(var r=0;r<t._howls.length;r++)if(!t._howls[r]._webAudio)for(var o=t._howls[r]._getSoundIds(),a=0;a<o.length;a++){var i=t._howls[r]._soundById(o[a]);i&&i._node&&(i._node.muted=!!e||i._muted)}return t},stop:function(){for(var e=this||n,t=0;t<e._howls.length;t++)e._howls[t].stop();return e},unload:function(){for(var e=this||n,t=e._howls.length-1;t>=0;t--)e._howls[t].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,c()),e},codecs:function(e){return(this||n)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||n;if(e.state=e.ctx&&e.ctx.state||"suspended",e._autoSuspend(),!e.usingWebAudio)if("undefined"!=typeof Audio)try{void 0===(new Audio).oncanplaythrough&&(e._canPlayEvent="canplay")}catch(n){e.noAudio=!0}else e.noAudio=!0;try{(new Audio).muted&&(e.noAudio=!0)}catch(e){}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||n,t=null;try{t="undefined"!=typeof Audio?new Audio:null}catch(n){return e}if(!t||"function"!=typeof t.canPlayType)return e;var r=t.canPlayType("audio/mpeg;").replace(/^no$/,""),o=e._navigator?e._navigator.userAgent:"",a=o.match(/OPR\/([0-6].)/g),i=a&&parseInt(a[0].split("/")[1],10)<33,l=-1!==o.indexOf("Safari")&&-1===o.indexOf("Chrome"),s=o.match(/Version\/(.*?) /),c=l&&s&&parseInt(s[1],10)<15;return e._codecs={mp3:!(i||!r&&!t.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!r,opus:!!t.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(t.canPlayType('audio/wav; codecs="1"')||t.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!t.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!t.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(t.canPlayType("audio/x-m4b;")||t.canPlayType("audio/m4b;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(t.canPlayType("audio/x-mp4;")||t.canPlayType("audio/mp4;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!(c||!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!(c||!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!t.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(t.canPlayType("audio/x-flac;")||t.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_unlockAudio:function(){var e=this||n;if(!e._audioUnlocked&&e.ctx){e._audioUnlocked=!1,e.autoUnlock=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var t=function(n){for(;e._html5AudioPool.length<e.html5PoolSize;)try{var r=new Audio;r._unlocked=!0,e._releaseHtml5Audio(r)}catch(n){e.noAudio=!0;break}for(var o=0;o<e._howls.length;o++)if(!e._howls[o]._webAudio)for(var a=e._howls[o]._getSoundIds(),i=0;i<a.length;i++){var l=e._howls[o]._soundById(a[i]);l&&l._node&&!l._node._unlocked&&(l._node._unlocked=!0,l._node.load())}e._autoResume();var s=e.ctx.createBufferSource();s.buffer=e._scratchBuffer,s.connect(e.ctx.destination),void 0===s.start?s.noteOn(0):s.start(0),"function"==typeof e.ctx.resume&&e.ctx.resume(),s.onended=function(){s.disconnect(0),e._audioUnlocked=!0,document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0),document.removeEventListener("keydown",t,!0);for(var n=0;n<e._howls.length;n++)e._howls[n]._emit("unlock")}};return document.addEventListener("touchstart",t,!0),document.addEventListener("touchend",t,!0),document.addEventListener("click",t,!0),document.addEventListener("keydown",t,!0),e}},_obtainHtml5Audio:function(){var e=this||n;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var t=(new Audio).play();return t&&"undefined"!=typeof Promise&&(t instanceof Promise||"function"==typeof t.then)&&t.catch((function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")})),new Audio},_releaseHtml5Audio:function(e){var t=this||n;return e._unlocked&&t._html5AudioPool.push(e),t},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&n.usingWebAudio){for(var t=0;t<e._howls.length;t++)if(e._howls[t]._webAudio)for(var r=0;r<e._howls[t]._sounds.length;r++)if(!e._howls[t]._sounds[r]._paused)return e;return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout((function(){if(e.autoSuspend){e._suspendTimer=null,e.state="suspending";var n=function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())};e.ctx.suspend().then(n,n)}}),3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&void 0!==e.ctx.resume&&n.usingWebAudio)return"running"===e.state&&"interrupted"!==e.ctx.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state||"running"===e.state&&"interrupted"===e.ctx.state?(e.ctx.resume().then((function(){e.state="running";for(var n=0;n<e._howls.length;n++)e._howls[n]._emit("resume")})),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}};var n=new e,t=function(e){e.src&&0!==e.src.length?this.init(e):console.error("An array of source files must be passed with any new Howl.")};t.prototype={init:function(e){var t=this;return n.ctx||c(),t._autoplay=e.autoplay||!1,t._format="string"!=typeof e.format?e.format:[e.format],t._html5=e.html5||!1,t._muted=e.mute||!1,t._loop=e.loop||!1,t._pool=e.pool||5,t._preload="boolean"!=typeof e.preload&&"metadata"!==e.preload||e.preload,t._rate=e.rate||1,t._sprite=e.sprite||{},t._src="string"!=typeof e.src?e.src:[e.src],t._volume=void 0!==e.volume?e.volume:1,t._xhr={method:e.xhr&&e.xhr.method?e.xhr.method:"GET",headers:e.xhr&&e.xhr.headers?e.xhr.headers:null,withCredentials:!(!e.xhr||!e.xhr.withCredentials)&&e.xhr.withCredentials},t._duration=0,t._state="unloaded",t._sounds=[],t._endTimers={},t._queue=[],t._playLock=!1,t._onend=e.onend?[{fn:e.onend}]:[],t._onfade=e.onfade?[{fn:e.onfade}]:[],t._onload=e.onload?[{fn:e.onload}]:[],t._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],t._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],t._onpause=e.onpause?[{fn:e.onpause}]:[],t._onplay=e.onplay?[{fn:e.onplay}]:[],t._onstop=e.onstop?[{fn:e.onstop}]:[],t._onmute=e.onmute?[{fn:e.onmute}]:[],t._onvolume=e.onvolume?[{fn:e.onvolume}]:[],t._onrate=e.onrate?[{fn:e.onrate}]:[],t._onseek=e.onseek?[{fn:e.onseek}]:[],t._onunlock=e.onunlock?[{fn:e.onunlock}]:[],t._onresume=[],t._webAudio=n.usingWebAudio&&!t._html5,void 0!==n.ctx&&n.ctx&&n.autoUnlock&&n._unlockAudio(),n._howls.push(t),t._autoplay&&t._queue.push({event:"play",action:function(){t.play()}}),t._preload&&"none"!==t._preload&&t.load(),t},load:function(){var e=this,t=null;if(n.noAudio)e._emit("loaderror",null,"No audio support.");else{"string"==typeof e._src&&(e._src=[e._src]);for(var o=0;o<e._src.length;o++){var i,l;if(e._format&&e._format[o])i=e._format[o];else{if("string"!=typeof(l=e._src[o])){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(i=/^data:audio\/([^;,]+);/i.exec(l))||(i=/\.([^.]+)$/.exec(l.split("?",1)[0])),i&&(i=i[1].toLowerCase())}if(i||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),i&&n.codecs(i)){t=e._src[o];break}}if(t)return e._src=t,e._state="loading","https:"===window.location.protocol&&"http:"===t.slice(0,5)&&(e._html5=!0,e._webAudio=!1),new r(e),e._webAudio&&a(e),e;e._emit("loaderror",null,"No codec support for selected audio sources.")}},play:function(e,t){var r=this,o=null;if("number"==typeof e)o=e,e=null;else{if("string"==typeof e&&"loaded"===r._state&&!r._sprite[e])return null;if(void 0===e&&(e="__default",!r._playLock)){for(var a=0,i=0;i<r._sounds.length;i++)r._sounds[i]._paused&&!r._sounds[i]._ended&&(a++,o=r._sounds[i]._id);1===a?e=null:o=null}}var l=o?r._soundById(o):r._inactiveSound();if(!l)return null;if(o&&!e&&(e=l._sprite||"__default"),"loaded"!==r._state){l._sprite=e,l._ended=!1;var s=l._id;return r._queue.push({event:"play",action:function(){r.play(s)}}),s}if(o&&!l._paused)return t||r._loadQueue("play"),l._id;r._webAudio&&n._autoResume();var c=Math.max(0,l._seek>0?l._seek:r._sprite[e][0]/1e3),d=Math.max(0,(r._sprite[e][0]+r._sprite[e][1])/1e3-c),u=1e3*d/Math.abs(l._rate),h=r._sprite[e][0]/1e3,f=(r._sprite[e][0]+r._sprite[e][1])/1e3;l._sprite=e,l._ended=!1;var p=function(){l._paused=!1,l._seek=c,l._start=h,l._stop=f,l._loop=!(!l._loop&&!r._sprite[e][2])};if(!(c>=f)){var g=l._node;if(r._webAudio){var m=function(){r._playLock=!1,p(),r._refreshBuffer(l);var e=l._muted||r._muted?0:l._volume;g.gain.setValueAtTime(e,n.ctx.currentTime),l._playStart=n.ctx.currentTime,void 0===g.bufferSource.start?l._loop?g.bufferSource.noteGrainOn(0,c,86400):g.bufferSource.noteGrainOn(0,c,d):l._loop?g.bufferSource.start(0,c,86400):g.bufferSource.start(0,c,d),u!==1/0&&(r._endTimers[l._id]=setTimeout(r._ended.bind(r,l),u)),t||setTimeout((function(){r._emit("play",l._id),r._loadQueue()}),0)};"running"===n.state&&"interrupted"!==n.ctx.state?m():(r._playLock=!0,r.once("resume",m),r._clearTimer(l._id))}else{var v=function(){g.currentTime=c,g.muted=l._muted||r._muted||n._muted||g.muted,g.volume=l._volume*n.volume(),g.playbackRate=l._rate;try{var o=g.play();if(o&&"undefined"!=typeof Promise&&(o instanceof Promise||"function"==typeof o.then)?(r._playLock=!0,p(),o.then((function(){r._playLock=!1,g._unlocked=!0,t?r._loadQueue():r._emit("play",l._id)})).catch((function(){r._playLock=!1,r._emit("playerror",l._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),l._ended=!0,l._paused=!0}))):t||(r._playLock=!1,p(),r._emit("play",l._id)),g.playbackRate=l._rate,g.paused)return void r._emit("playerror",l._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==e||l._loop?r._endTimers[l._id]=setTimeout(r._ended.bind(r,l),u):(r._endTimers[l._id]=function(){r._ended(l),g.removeEventListener("ended",r._endTimers[l._id],!1)},g.addEventListener("ended",r._endTimers[l._id],!1))}catch(e){r._emit("playerror",l._id,e)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===g.src&&(g.src=r._src,g.load());var _=window&&window.ejecta||!g.readyState&&n._navigator.isCocoonJS;if(g.readyState>=3||_)v();else{r._playLock=!0,r._state="loading";var y=function(){r._state="loaded",v(),g.removeEventListener(n._canPlayEvent,y,!1)};g.addEventListener(n._canPlayEvent,y,!1),r._clearTimer(l._id)}}return l._id}r._ended(l)},pause:function(e){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"pause",action:function(){n.pause(e)}}),n;for(var t=n._getSoundIds(e),r=0;r<t.length;r++){n._clearTimer(t[r]);var o=n._soundById(t[r]);if(o&&!o._paused&&(o._seek=n.seek(t[r]),o._rateSeek=0,o._paused=!0,n._stopFade(t[r]),o._node))if(n._webAudio){if(!o._node.bufferSource)continue;void 0===o._node.bufferSource.stop?o._node.bufferSource.noteOff(0):o._node.bufferSource.stop(0),n._cleanBuffer(o._node)}else isNaN(o._node.duration)&&o._node.duration!==1/0||o._node.pause();arguments[1]||n._emit("pause",o?o._id:null)}return n},stop:function(e,n){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"stop",action:function(){t.stop(e)}}),t;for(var r=t._getSoundIds(e),o=0;o<r.length;o++){t._clearTimer(r[o]);var a=t._soundById(r[o]);a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,t._stopFade(r[o]),a._node&&(t._webAudio?a._node.bufferSource&&(void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),t._cleanBuffer(a._node)):isNaN(a._node.duration)&&a._node.duration!==1/0||(a._node.currentTime=a._start||0,a._node.pause(),a._node.duration===1/0&&t._clearSound(a._node))),n||t._emit("stop",a._id))}return t},mute:function(e,t){var r=this;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"mute",action:function(){r.mute(e,t)}}),r;if(void 0===t){if("boolean"!=typeof e)return r._muted;r._muted=e}for(var o=r._getSoundIds(t),a=0;a<o.length;a++){var i=r._soundById(o[a]);i&&(i._muted=e,i._interval&&r._stopFade(i._id),r._webAudio&&i._node?i._node.gain.setValueAtTime(e?0:i._volume,n.ctx.currentTime):i._node&&(i._node.muted=!!n._muted||e),r._emit("mute",i._id))}return r},volume:function(){var e,t,r,o=this,a=arguments;if(0===a.length)return o._volume;if(1===a.length||2===a.length&&void 0===a[1]){var i=o._getSoundIds(),l=i.indexOf(a[0]);l>=0?t=parseInt(a[0],10):e=parseFloat(a[0])}else a.length>=2&&(e=parseFloat(a[0]),t=parseInt(a[1],10));if(!(void 0!==e&&e>=0&&e<=1))return(r=t?o._soundById(t):o._sounds[0])?r._volume:0;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"volume",action:function(){o.volume.apply(o,a)}}),o;void 0===t&&(o._volume=e),t=o._getSoundIds(t);for(var s=0;s<t.length;s++)(r=o._soundById(t[s]))&&(r._volume=e,a[2]||o._stopFade(t[s]),o._webAudio&&r._node&&!r._muted?r._node.gain.setValueAtTime(e,n.ctx.currentTime):r._node&&!r._muted&&(r._node.volume=e*n.volume()),o._emit("volume",r._id));return o},fade:function(e,t,r,o){var a=this;if("loaded"!==a._state||a._playLock)return a._queue.push({event:"fade",action:function(){a.fade(e,t,r,o)}}),a;e=Math.min(Math.max(0,parseFloat(e)),1),t=Math.min(Math.max(0,parseFloat(t)),1),r=parseFloat(r),a.volume(e,o);for(var i=a._getSoundIds(o),l=0;l<i.length;l++){var s=a._soundById(i[l]);if(s){if(o||a._stopFade(i[l]),a._webAudio&&!s._muted){var c=n.ctx.currentTime,d=c+r/1e3;s._volume=e,s._node.gain.setValueAtTime(e,c),s._node.gain.linearRampToValueAtTime(t,d)}a._startFadeInterval(s,e,t,r,i[l],void 0===o)}}return a},_startFadeInterval:function(e,n,t,r,o,a){var i=this,l=n,s=t-n,c=Math.abs(s/.01),d=Math.max(4,c>0?r/c:r),u=Date.now();e._fadeTo=t,e._interval=setInterval((function(){var o=(Date.now()-u)/r;u=Date.now(),l+=s*o,l=Math.round(100*l)/100,l=s<0?Math.max(t,l):Math.min(t,l),i._webAudio?e._volume=l:i.volume(l,e._id,!0),a&&(i._volume=l),(t<n&&l<=t||t>n&&l>=t)&&(clearInterval(e._interval),e._interval=null,e._fadeTo=null,i.volume(t,e._id),i._emit("fade",e._id))}),d)},_stopFade:function(e){var t=this,r=t._soundById(e);return r&&r._interval&&(t._webAudio&&r._node.gain.cancelScheduledValues(n.ctx.currentTime),clearInterval(r._interval),r._interval=null,t.volume(r._fadeTo,e),r._fadeTo=null,t._emit("fade",e)),t},loop:function(){var e,n,t,r=this,o=arguments;if(0===o.length)return r._loop;if(1===o.length){if("boolean"!=typeof o[0])return!!(t=r._soundById(parseInt(o[0],10)))&&t._loop;e=o[0],r._loop=e}else 2===o.length&&(e=o[0],n=parseInt(o[1],10));for(var a=r._getSoundIds(n),i=0;i<a.length;i++)(t=r._soundById(a[i]))&&(t._loop=e,r._webAudio&&t._node&&t._node.bufferSource&&(t._node.bufferSource.loop=e,e&&(t._node.bufferSource.loopStart=t._start||0,t._node.bufferSource.loopEnd=t._stop,r.playing(a[i])&&(r.pause(a[i],!0),r.play(a[i],!0)))));return r},rate:function(){var e,t,r,o=this,a=arguments;if(0===a.length)t=o._sounds[0]._id;else if(1===a.length){var i=o._getSoundIds(),l=i.indexOf(a[0]);l>=0?t=parseInt(a[0],10):e=parseFloat(a[0])}else 2===a.length&&(e=parseFloat(a[0]),t=parseInt(a[1],10));if("number"!=typeof e)return(r=o._soundById(t))?r._rate:o._rate;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"rate",action:function(){o.rate.apply(o,a)}}),o;void 0===t&&(o._rate=e),t=o._getSoundIds(t);for(var s=0;s<t.length;s++)if(r=o._soundById(t[s])){o.playing(t[s])&&(r._rateSeek=o.seek(t[s]),r._playStart=o._webAudio?n.ctx.currentTime:r._playStart),r._rate=e,o._webAudio&&r._node&&r._node.bufferSource?r._node.bufferSource.playbackRate.setValueAtTime(e,n.ctx.currentTime):r._node&&(r._node.playbackRate=e);var c=o.seek(t[s]),d=(o._sprite[r._sprite][0]+o._sprite[r._sprite][1])/1e3-c,u=1e3*d/Math.abs(r._rate);!o._endTimers[t[s]]&&r._paused||(o._clearTimer(t[s]),o._endTimers[t[s]]=setTimeout(o._ended.bind(o,r),u)),o._emit("rate",r._id)}return o},seek:function(){var e,t,r=this,o=arguments;if(0===o.length)r._sounds.length&&(t=r._sounds[0]._id);else if(1===o.length){var a=r._getSoundIds(),i=a.indexOf(o[0]);i>=0?t=parseInt(o[0],10):r._sounds.length&&(t=r._sounds[0]._id,e=parseFloat(o[0]))}else 2===o.length&&(e=parseFloat(o[0]),t=parseInt(o[1],10));if(void 0===t)return 0;if("number"==typeof e&&("loaded"!==r._state||r._playLock))return r._queue.push({event:"seek",action:function(){r.seek.apply(r,o)}}),r;var l=r._soundById(t);if(l){if(!("number"==typeof e&&e>=0)){if(r._webAudio){var s=r.playing(t)?n.ctx.currentTime-l._playStart:0,c=l._rateSeek?l._rateSeek-l._seek:0;return l._seek+(c+s*Math.abs(l._rate))}return l._node.currentTime}var d=r.playing(t);d&&r.pause(t,!0),l._seek=e,l._ended=!1,r._clearTimer(t),r._webAudio||!l._node||isNaN(l._node.duration)||(l._node.currentTime=e);var u=function(){d&&r.play(t,!0),r._emit("seek",t)};if(d&&!r._webAudio){var h=function(){r._playLock?setTimeout(h,0):u()};setTimeout(h,0)}else u()}return r},playing:function(e){var n=this;if("number"==typeof e){var t=n._soundById(e);return!!t&&!t._paused}for(var r=0;r<n._sounds.length;r++)if(!n._sounds[r]._paused)return!0;return!1},duration:function(e){var n=this,t=n._duration,r=n._soundById(e);return r&&(t=n._sprite[r._sprite][1]/1e3),t},state:function(){return this._state},unload:function(){for(var e=this,t=e._sounds,r=0;r<t.length;r++)t[r]._paused||e.stop(t[r]._id),e._webAudio||(e._clearSound(t[r]._node),t[r]._node.removeEventListener("error",t[r]._errorFn,!1),t[r]._node.removeEventListener(n._canPlayEvent,t[r]._loadFn,!1),t[r]._node.removeEventListener("ended",t[r]._endFn,!1),n._releaseHtml5Audio(t[r]._node)),delete t[r]._node,e._clearTimer(t[r]._id);var a=n._howls.indexOf(e);a>=0&&n._howls.splice(a,1);var i=!0;for(r=0;r<n._howls.length;r++)if(n._howls[r]._src===e._src||e._src.indexOf(n._howls[r]._src)>=0){i=!1;break}return o&&i&&delete o[e._src],n.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,n,t,r){var o=this["_on"+e];return"function"==typeof n&&o.push(r?{id:t,fn:n,once:r}:{id:t,fn:n}),this},off:function(e,n,t){var r=this,o=r["_on"+e],a=0;if("number"==typeof n&&(t=n,n=null),n||t)for(a=0;a<o.length;a++){var i=t===o[a].id;if(n===o[a].fn&&i||!n&&i){o.splice(a,1);break}}else if(e)r["_on"+e]=[];else{var l=Object.keys(r);for(a=0;a<l.length;a++)0===l[a].indexOf("_on")&&Array.isArray(r[l[a]])&&(r[l[a]]=[])}return r},once:function(e,n,t){return this.on(e,n,t,1),this},_emit:function(e,n,t){for(var r=this,o=r["_on"+e],a=o.length-1;a>=0;a--)o[a].id&&o[a].id!==n&&"load"!==e||(setTimeout(function(e){e.call(this,n,t)}.bind(r,o[a].fn),0),o[a].once&&r.off(e,o[a].fn,o[a].id));return r._loadQueue(e),r},_loadQueue:function(e){var n=this;if(n._queue.length>0){var t=n._queue[0];t.event===e&&(n._queue.shift(),n._loadQueue()),e||t.action()}return n},_ended:function(e){var t=this,r=e._sprite;if(!t._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(t._ended.bind(t,e),100),t;var o=!(!e._loop&&!t._sprite[r][2]);if(t._emit("end",e._id),!t._webAudio&&o&&t.stop(e._id,!0).play(e._id),t._webAudio&&o){t._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=n.ctx.currentTime;var a=1e3*(e._stop-e._start)/Math.abs(e._rate);t._endTimers[e._id]=setTimeout(t._ended.bind(t,e),a)}return t._webAudio&&!o&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,t._clearTimer(e._id),t._cleanBuffer(e._node),n._autoSuspend()),t._webAudio||o||t.stop(e._id,!0),t},_clearTimer:function(e){var n=this;if(n._endTimers[e]){if("function"!=typeof n._endTimers[e])clearTimeout(n._endTimers[e]);else{var t=n._soundById(e);t&&t._node&&t._node.removeEventListener("ended",n._endTimers[e],!1)}delete n._endTimers[e]}return n},_soundById:function(e){for(var n=this,t=0;t<n._sounds.length;t++)if(e===n._sounds[t]._id)return n._sounds[t];return null},_inactiveSound:function(){var e=this;e._drain();for(var n=0;n<e._sounds.length;n++)if(e._sounds[n]._ended)return e._sounds[n].reset();return new r(e)},_drain:function(){var e=this,n=e._pool,t=0,r=0;if(!(e._sounds.length<n)){for(r=0;r<e._sounds.length;r++)e._sounds[r]._ended&&t++;for(r=e._sounds.length-1;r>=0;r--){if(t<=n)return;e._sounds[r]._ended&&(e._webAudio&&e._sounds[r]._node&&e._sounds[r]._node.disconnect(0),e._sounds.splice(r,1),t--)}}},_getSoundIds:function(e){if(void 0===e){for(var n=[],t=0;t<this._sounds.length;t++)n.push(this._sounds[t]._id);return n}return[e]},_refreshBuffer:function(e){return e._node.bufferSource=n.ctx.createBufferSource(),e._node.bufferSource.buffer=o[this._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,n.ctx.currentTime),this},_cleanBuffer:function(e){var t=n._navigator&&n._navigator.vendor.indexOf("Apple")>=0;if(n._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),t))try{e.bufferSource.buffer=n._scratchBuffer}catch(e){}return e.bufferSource=null,this},_clearSound:function(e){/MSIE |Trident\//.test(n._navigator&&n._navigator.userAgent)||(e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var r=function(e){this._parent=e,this.init()};r.prototype={init:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++n._counter,t._sounds.push(e),e.create(),e},create:function(){var e=this,t=e._parent,r=n._muted||e._muted||e._parent._muted?0:e._volume;return t._webAudio?(e._node=void 0===n.ctx.createGain?n.ctx.createGainNode():n.ctx.createGain(),e._node.gain.setValueAtTime(r,n.ctx.currentTime),e._node.paused=!0,e._node.connect(n.masterGain)):n.noAudio||(e._node=n._obtainHtml5Audio(),e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(n._canPlayEvent,e._loadFn,!1),e._endFn=e._endListener.bind(e),e._node.addEventListener("ended",e._endFn,!1),e._node.src=t._src,e._node.preload=!0===t._preload?"auto":t._preload,e._node.volume=r*n.volume(),e._node.load()),e},reset:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++n._counter,e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorFn,!1)},_loadListener:function(){var e=this,t=e._parent;t._duration=Math.ceil(10*e._node.duration)/10,0===Object.keys(t._sprite).length&&(t._sprite={__default:[0,1e3*t._duration]}),"loaded"!==t._state&&(t._state="loaded",t._emit("load"),t._loadQueue()),e._node.removeEventListener(n._canPlayEvent,e._loadFn,!1)},_endListener:function(){var e=this,n=e._parent;n._duration===1/0&&(n._duration=Math.ceil(10*e._node.duration)/10,n._sprite.__default[1]===1/0&&(n._sprite.__default[1]=1e3*n._duration),n._ended(e)),e._node.removeEventListener("ended",e._endFn,!1)}};var o={},a=function(e){var n=e._src;if(o[n])return e._duration=o[n].duration,void s(e);if(/^data:[^;]+;base64,/.test(n)){for(var t=atob(n.split(",")[1]),r=new Uint8Array(t.length),a=0;a<t.length;++a)r[a]=t.charCodeAt(a);l(r.buffer,e)}else{var c=new XMLHttpRequest;c.open(e._xhr.method,n,!0),c.withCredentials=e._xhr.withCredentials,c.responseType="arraybuffer",e._xhr.headers&&Object.keys(e._xhr.headers).forEach((function(n){c.setRequestHeader(n,e._xhr.headers[n])})),c.onload=function(){var n=(c.status+"")[0];"0"===n||"2"===n||"3"===n?l(c.response,e):e._emit("loaderror",null,"Failed loading audio file with status: "+c.status+".")},c.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete o[n],e.load())},i(c)}},i=function(e){try{e.send()}catch(n){e.onerror()}},l=function(e,t){var r=function(){t._emit("loaderror",null,"Decoding audio data failed.")},a=function(e){e&&t._sounds.length>0?(o[t._src]=e,s(t,e)):r()};"undefined"!=typeof Promise&&1===n.ctx.decodeAudioData.length?n.ctx.decodeAudioData(e).then(a).catch(r):n.ctx.decodeAudioData(e,a,r)},s=function(e,n){n&&!e._duration&&(e._duration=n.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},c=function(){if(n.usingWebAudio){try{"undefined"!=typeof AudioContext?n.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?n.ctx=new webkitAudioContext:n.usingWebAudio=!1}catch(e){n.usingWebAudio=!1}n.ctx||(n.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(n._navigator&&n._navigator.platform),t=n._navigator&&n._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),r=t?parseInt(t[1],10):null;if(e&&r&&r<9){var o=/safari/.test(n._navigator&&n._navigator.userAgent.toLowerCase());n._navigator&&!o&&(n.usingWebAudio=!1)}n.usingWebAudio&&(n.masterGain=void 0===n.ctx.createGain?n.ctx.createGainNode():n.ctx.createGain(),n.masterGain.gain.setValueAtTime(n._muted?0:n._volume,n.ctx.currentTime),n.masterGain.connect(n.ctx.destination)),n._setup()}};"function"==typeof define&&define.amd&&define([],(function(){return{Howler:n,Howl:t}})),"undefined"!=typeof exports&&(exports.Howler=n,exports.Howl=t),"undefined"!=typeof global?(global.HowlerGlobal=e,global.Howler=n,global.Howl=t,global.Sound=r):"undefined"!=typeof window&&(window.HowlerGlobal=e,window.Howler=n,window.Howl=t,window.Sound=r)}(),
/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.3
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */
function(){"use strict";var e;HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var n=this;if(!n.ctx||!n.ctx.listener)return n;for(var t=n._howls.length-1;t>=0;t--)n._howls[t].stereo(e);return n},HowlerGlobal.prototype.pos=function(e,n,t){var r=this;return r.ctx&&r.ctx.listener?(n="number"!=typeof n?r._pos[1]:n,t="number"!=typeof t?r._pos[2]:t,"number"!=typeof e?r._pos:(r._pos=[e,n,t],void 0!==r.ctx.listener.positionX?(r.ctx.listener.positionX.setTargetAtTime(r._pos[0],Howler.ctx.currentTime,.1),r.ctx.listener.positionY.setTargetAtTime(r._pos[1],Howler.ctx.currentTime,.1),r.ctx.listener.positionZ.setTargetAtTime(r._pos[2],Howler.ctx.currentTime,.1)):r.ctx.listener.setPosition(r._pos[0],r._pos[1],r._pos[2]),r)):r},HowlerGlobal.prototype.orientation=function(e,n,t,r,o,a){var i=this;if(!i.ctx||!i.ctx.listener)return i;var l=i._orientation;return n="number"!=typeof n?l[1]:n,t="number"!=typeof t?l[2]:t,r="number"!=typeof r?l[3]:r,o="number"!=typeof o?l[4]:o,a="number"!=typeof a?l[5]:a,"number"!=typeof e?l:(i._orientation=[e,n,t,r,o,a],void 0!==i.ctx.listener.forwardX?(i.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),i.ctx.listener.forwardY.setTargetAtTime(n,Howler.ctx.currentTime,.1),i.ctx.listener.forwardZ.setTargetAtTime(t,Howler.ctx.currentTime,.1),i.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),i.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),i.ctx.listener.upZ.setTargetAtTime(a,Howler.ctx.currentTime,.1)):i.ctx.listener.setOrientation(e,n,t,r,o,a),i)},Howl.prototype.init=(e=Howl.prototype.init,function(n){var t=this;return t._orientation=n.orientation||[1,0,0],t._stereo=n.stereo||null,t._pos=n.pos||null,t._pannerAttr={coneInnerAngle:void 0!==n.coneInnerAngle?n.coneInnerAngle:360,coneOuterAngle:void 0!==n.coneOuterAngle?n.coneOuterAngle:360,coneOuterGain:void 0!==n.coneOuterGain?n.coneOuterGain:0,distanceModel:void 0!==n.distanceModel?n.distanceModel:"inverse",maxDistance:void 0!==n.maxDistance?n.maxDistance:1e4,panningModel:void 0!==n.panningModel?n.panningModel:"HRTF",refDistance:void 0!==n.refDistance?n.refDistance:1,rolloffFactor:void 0!==n.rolloffFactor?n.rolloffFactor:1},t._onstereo=n.onstereo?[{fn:n.onstereo}]:[],t._onpos=n.onpos?[{fn:n.onpos}]:[],t._onorientation=n.onorientation?[{fn:n.onorientation}]:[],e.call(this,n)}),Howl.prototype.stereo=function(e,t){var r=this;if(!r._webAudio)return r;if("loaded"!==r._state)return r._queue.push({event:"stereo",action:function(){r.stereo(e,t)}}),r;var o=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===t){if("number"!=typeof e)return r._stereo;r._stereo=e,r._pos=[e,0,0]}for(var a=r._getSoundIds(t),i=0;i<a.length;i++){var l=r._soundById(a[i]);if(l){if("number"!=typeof e)return l._stereo;l._stereo=e,l._pos=[e,0,0],l._node&&(l._pannerAttr.panningModel="equalpower",l._panner&&l._panner.pan||n(l,o),"spatial"===o?void 0!==l._panner.positionX?(l._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),l._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),l._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):l._panner.setPosition(e,0,0):l._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),r._emit("stereo",l._id)}}return r},Howl.prototype.pos=function(e,t,r,o){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"pos",action:function(){a.pos(e,t,r,o)}}),a;if(t="number"!=typeof t?0:t,r="number"!=typeof r?-.5:r,void 0===o){if("number"!=typeof e)return a._pos;a._pos=[e,t,r]}for(var i=a._getSoundIds(o),l=0;l<i.length;l++){var s=a._soundById(i[l]);if(s){if("number"!=typeof e)return s._pos;s._pos=[e,t,r],s._node&&(s._panner&&!s._panner.pan||n(s,"spatial"),void 0!==s._panner.positionX?(s._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),s._panner.positionY.setValueAtTime(t,Howler.ctx.currentTime),s._panner.positionZ.setValueAtTime(r,Howler.ctx.currentTime)):s._panner.setPosition(e,t,r)),a._emit("pos",s._id)}}return a},Howl.prototype.orientation=function(e,t,r,o){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"orientation",action:function(){a.orientation(e,t,r,o)}}),a;if(t="number"!=typeof t?a._orientation[1]:t,r="number"!=typeof r?a._orientation[2]:r,void 0===o){if("number"!=typeof e)return a._orientation;a._orientation=[e,t,r]}for(var i=a._getSoundIds(o),l=0;l<i.length;l++){var s=a._soundById(i[l]);if(s){if("number"!=typeof e)return s._orientation;s._orientation=[e,t,r],s._node&&(s._panner||(s._pos||(s._pos=a._pos||[0,0,-.5]),n(s,"spatial")),void 0!==s._panner.orientationX?(s._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),s._panner.orientationY.setValueAtTime(t,Howler.ctx.currentTime),s._panner.orientationZ.setValueAtTime(r,Howler.ctx.currentTime)):s._panner.setOrientation(e,t,r)),a._emit("orientation",s._id)}}return a},Howl.prototype.pannerAttr=function(){var e,t,r,o=this,a=arguments;if(!o._webAudio)return o;if(0===a.length)return o._pannerAttr;if(1===a.length){if("object"!=typeof a[0])return(r=o._soundById(parseInt(a[0],10)))?r._pannerAttr:o._pannerAttr;e=a[0],void 0===t&&(e.pannerAttr||(e.pannerAttr={coneInnerAngle:e.coneInnerAngle,coneOuterAngle:e.coneOuterAngle,coneOuterGain:e.coneOuterGain,distanceModel:e.distanceModel,maxDistance:e.maxDistance,refDistance:e.refDistance,rolloffFactor:e.rolloffFactor,panningModel:e.panningModel}),o._pannerAttr={coneInnerAngle:void 0!==e.pannerAttr.coneInnerAngle?e.pannerAttr.coneInnerAngle:o._coneInnerAngle,coneOuterAngle:void 0!==e.pannerAttr.coneOuterAngle?e.pannerAttr.coneOuterAngle:o._coneOuterAngle,coneOuterGain:void 0!==e.pannerAttr.coneOuterGain?e.pannerAttr.coneOuterGain:o._coneOuterGain,distanceModel:void 0!==e.pannerAttr.distanceModel?e.pannerAttr.distanceModel:o._distanceModel,maxDistance:void 0!==e.pannerAttr.maxDistance?e.pannerAttr.maxDistance:o._maxDistance,refDistance:void 0!==e.pannerAttr.refDistance?e.pannerAttr.refDistance:o._refDistance,rolloffFactor:void 0!==e.pannerAttr.rolloffFactor?e.pannerAttr.rolloffFactor:o._rolloffFactor,panningModel:void 0!==e.pannerAttr.panningModel?e.pannerAttr.panningModel:o._panningModel})}else 2===a.length&&(e=a[0],t=parseInt(a[1],10));for(var i=o._getSoundIds(t),l=0;l<i.length;l++)if(r=o._soundById(i[l])){var s=r._pannerAttr;s={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:s.coneInnerAngle,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:s.coneOuterAngle,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:s.coneOuterGain,distanceModel:void 0!==e.distanceModel?e.distanceModel:s.distanceModel,maxDistance:void 0!==e.maxDistance?e.maxDistance:s.maxDistance,refDistance:void 0!==e.refDistance?e.refDistance:s.refDistance,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:s.rolloffFactor,panningModel:void 0!==e.panningModel?e.panningModel:s.panningModel};var c=r._panner;c?(c.coneInnerAngle=s.coneInnerAngle,c.coneOuterAngle=s.coneOuterAngle,c.coneOuterGain=s.coneOuterGain,c.distanceModel=s.distanceModel,c.maxDistance=s.maxDistance,c.refDistance=s.refDistance,c.rolloffFactor=s.rolloffFactor,c.panningModel=s.panningModel):(r._pos||(r._pos=o._pos||[0,0,-.5]),n(r,"spatial"))}return o},Sound.prototype.init=function(e){return function(){var n=this,t=n._parent;n._orientation=t._orientation,n._stereo=t._stereo,n._pos=t._pos,n._pannerAttr=t._pannerAttr,e.call(this),n._stereo?t.stereo(n._stereo):n._pos&&t.pos(n._pos[0],n._pos[1],n._pos[2],n._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var n=this,t=n._parent;return n._orientation=t._orientation,n._stereo=t._stereo,n._pos=t._pos,n._pannerAttr=t._pannerAttr,n._stereo?t.stereo(n._stereo):n._pos?t.pos(n._pos[0],n._pos[1],n._pos[2],n._id):n._panner&&(n._panner.disconnect(0),n._panner=void 0,t._refreshBuffer(n)),e.call(this)}}(Sound.prototype.reset);var n=function(e,n){"spatial"===(n=n||"spatial")?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,void 0!==e._panner.positionX?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),void 0!==e._panner.orientationX?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}}(),CodeMirror.defineMode=function(e,n){};var StringStream=CodeMirror.StringStream=function(e,n){this.pos=this.start=0,this.string=e,this.tabSize=n||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0};StringStream.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==this.lineStart},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},eat:function(e){var n=this.string.charAt(this.pos);if("string"==typeof e)var t=n==e;else t=n&&(e.test?e.test(n):e(n));if(t)return++this.pos,n},eatWhile:function(e){for(var n=this.pos;this.eat(e););return this.pos>n},eatSpace:function(){for(var e=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>e},skipToEnd:function(){this.pos=this.string.length},skipTo:function(e){var n=this.string.indexOf(e,this.pos);if(n>-1)return this.pos=n,!0},backUp:function(e){this.pos-=e},column:function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=countColumn(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},indentation:function(){return countColumn(this.string,null,this.tabSize)-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},match:function(e,n,t){if("string"!=typeof e){var r=this.string.slice(this.pos).match(e);return r&&r.index>0?null:(r&&!1!==n&&(this.pos+=r[0].length),r)}var o=function(e){return t?e.toLowerCase():e};if(o(this.string.substr(this.pos,e.length))==o(e))return!1!==n&&(this.pos+=e.length),!0},current:function(){return this.string.slice(this.start,this.pos)},hideFirstChars:function(e,n){this.lineStart+=e;try{return n()}finally{this.lineStart-=e}}},colorPalettesAliases={1:"mastersystem",2:"gameboycolour",3:"amiga",4:"arnecolors",5:"famicom",6:"atari",7:"pastel",8:"ega",9:"amstrad",10:"proteus_mellow",11:"proteus_rich",12:"proteus_night",13:"c64",14:"whitingjp"},colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#1d57f7",lightblue:"#B2DCEF",darkblue:"#1B2632",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},proteus_mellow:{black:"#3d2d2e",white:"#ddf1fc",grey:"#9fb2d4",darkgrey:"#7b8272",lightgrey:"#a4bfda",gray:"#9fb2d4",darkgray:"#7b8272",lightgray:"#a4bfda",red:"#9d5443",darkred:"#8c5b4a",lightred:"#94614c",brown:"#89a78d",darkbrown:"#829e88",lightbrown:"#aaae97",orange:"#d1ba86",yellow:"#d6cda2",green:"#75ac8d",darkgreen:"#8fa67f",lightgreen:"#8eb682",blue:"#88a3ce",lightblue:"#a5adb0",darkblue:"#5c6b8c",purple:"#d39fac",pink:"#c8ac9e"},proteus_night:{black:"#010912",white:"#fdeeec",grey:"#051d40",darkgrey:"#091842",lightgrey:"#062151",gray:"#051d40",darkgray:"#091842",lightgray:"#062151",red:"#ad4576",darkred:"#934765",lightred:"#ab6290",brown:"#61646b",darkbrown:"#3d2d2d",lightbrown:"#8393a0",orange:"#0a2227",yellow:"#0a2541",green:"#75ac8d",darkgreen:"#0a2434",lightgreen:"#061f2e",blue:"#0b2c79",lightblue:"#809ccb",darkblue:"#08153b",purple:"#666a87",pink:"#754b4d"},proteus_rich:{black:"#6f686f",white:"#d1b1e2",grey:"#b9aac1",darkgrey:"#8e8b84",lightgrey:"#c7b5cd",gray:"#b9aac1",darkgray:"#8e8b84",lightgray:"#c7b5cd",red:"#a11f4f",darkred:"#934765",lightred:"#c998ad",brown:"#89867d",darkbrown:"#797f75",lightbrown:"#ab9997",orange:"#ce8c5c",yellow:"#f0d959",green:"#75bc54",darkgreen:"#599d79",lightgreen:"#90cf5c",blue:"#8fd0ec",lightblue:"#bcdce7",darkblue:"#0b2c70",purple:"#9b377f",pink:"#cd88e5"},amstrad:{black:"#000000",white:"#ffffff",grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"},c64:{black:"#000000",white:"#ffffff",grey:"#6C6C6C",darkgrey:"#444444",lightgrey:"#959595",gray:"#6C6C6C",darkgray:"#444444",lightgray:"#959595",red:"#68372B",darkred:"#3f1e17",lightred:"#9A6759",brown:"#433900",darkbrown:"#221c02",lightbrown:"#6d5c0d",orange:"#6F4F25",yellow:"#B8C76F",green:"#588D43",darkgreen:"#345129",lightgreen:"#9AD284",blue:"#6C5EB5",lightblue:"#70A4B2",darkblue:"#352879",purple:"#6F3D86",pink:"#b044ac"},whitingjp:{black:"#202527",white:"#eff8fd",grey:"#7b7680",darkgrey:"#3c3b44",lightgrey:"#bed0d7",gray:"#7b7680",darkgray:"#3c3b44",lightgray:"#bed0d7",red:"#bd194b",darkred:"#6b1334",lightred:"#ef2358",brown:"#b52e1c",darkbrown:"#681c12",lightbrown:"#e87b45",orange:"#ff8c10",yellow:"#fbd524",green:"#36bc3c",darkgreen:"#317610",lightgreen:"#8ce062",blue:"#3f62c6",lightblue:"#57bbe0",darkblue:"#2c2fa0",purple:"#7037d9",pink:"#ec2b8f"}};var reg_color_names=/(black|white|darkgray|lightgray|gray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent)\s*/,reg_color=/(black|white|gray|darkgray|lightgray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent|#(?:[0-9a-f]{2}){3,4}|#(?:[0-9a-f]{3}))\s*/;function createSprite(e,n,t,r){void 0===t&&(t=[state.bgcolor,state.fgcolor]);var o=makeSpriteCanvas(e);return renderSprite(o.getContext("2d"),n,t,r,0,0),o}function renderSprite(e,n,t,r,o,a){void 0===t&&(t=["#00000000",state.fgcolor]);var i=o*cellwidth,l=a*cellheight;e.clearRect(i,l,cellwidth,cellheight);var s=n[0].length,c=n.length,d=~~(cellwidth/(s+(0|r))),u=~~(cellheight/(c+(0|r))),h=u;"scanline"in state.metadata&&(h=Math.ceil(u/2)),e.fillStyle=state.fgcolor;for(var f=0;f<c;f++)for(var p=0;p<s;p++){var g=n[f][p];if(g>=0){var m=f*u|0,v=p*d|0;e.fillStyle=t[g],e.fillRect(i+v,l+m,d,h)}}}function drawTextWithCustomFont(e,n,t,r){n.fillStyle=state.fgcolor,n.textBaseline="middle",n.textAlign="center";var o=1;void 0!==state.metadata.font_size&&(o=Math.max(parseFloat(state.metadata.font_size),0)),n.font=cellheight*o+"px PuzzleCustomFont",n.fillText(e,t,r)}var textsheetCanvas=null;function regenText(e,n){null==textsheetCanvas&&(textsheetCanvas=document.createElement("canvas"));var t=Math.ceil(Math.sqrt(fontKeys.length));textsheetCanvas.width=t*cellwidth,textsheetCanvas.height=t*cellheight*2;for(var r=textsheetCanvas.getContext("2d"),o=0;o<fontKeys.length;o++){var a=fontKeys[o];if("†"==a){console.log("making custom red character"),fontstr="11111\n                       11111\n                       11111\n                       11111\n                       11111\n                       11111\n                       11111\n                       11111\n                       11111\n                       11111\n                       11111\n                       11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();var i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#FF0000","#FF0000"],1,i,l),renderSprite(r,fontstr,["#FF0000","#FF0000"],1,i,l+t)}else if("ŋ"==a){console.log("making blue siren character"),fontstr="00000\n            00000\n            00000\n            00000\n            00000\n            00000\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#0000FF"],1,i,l),renderSprite(r,fontstr,["#000000","#0000FF"],1,i,l+t)}else if("ŉ"==a){console.log("making red siren character"),fontstr="00000\n            00000\n            00000\n            00000\n            00000\n            00000\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FF0000"],1,i,l),renderSprite(r,fontstr,["#000000","#FF0000"],1,i,l+t)}else if("Æ"==a){console.log("making custom white character"),fontstr="11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#FFFFFF","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#FFFFFF","#FFFFFF"],1,i,l+t)}else if("Ĳ"==a){console.log("making custom half-white character"),fontstr="00000\n            00000\n            00000\n            00000\n            00000\n            00000\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("ĳ"==a){console.log("making custom blue character"),fontstr="11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#0000FF","#0000FF"],1,i,l),renderSprite(r,fontstr,["#0000FF","#0000FF"],1,i,l+t)}else if("æ"==a){console.log("making custom left wheel character"),fontstr="11111\n            11111\n            11111\n            11100\n            11100\n            11100\n            11100\n            11100\n            11100\n            11100\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#FFFFFF","#3A3B3C"],1,i,l),renderSprite(r,fontstr,["#FFFFFF","#3A3B3C"],1,i,l+t)}else if("ł"==a){console.log("making custom right wheel character"),fontstr="11111\n            11111\n            11111\n            00111\n            00111\n            00111\n            00111\n            00111\n            00111\n            00111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#FFFFFF","#3A3B3C"],1,i,l),renderSprite(r,fontstr,["#FFFFFF","#3A3B3C"],1,i,l+t)}else if("®"==a){console.log("making custom light gray character"),fontstr="11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#D3D3D3","#D3D3D3"],1,i,l),renderSprite(r,fontstr,["#D3D3D3","#D3D3D3"],1,i,l+t)}else if("€"==a){console.log("making custom light blue character"),fontstr="11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#ADD8E6","#ADD8E6"],1,i,l),renderSprite(r,fontstr,["#ADD8E6","#ADD8E6"],1,i,l+t)}else if("ĸ"==a){console.log("making custom black character"),fontstr="11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#000000"],1,i,l),renderSprite(r,fontstr,["#000000","#000000"],1,i,l+t)}else if("Ł"==a){console.log("making custom noise line character"),fontstr="11111\n            11111\n            11111\n            11111\n            01111\n            10111\n            11011\n            00001\n            01111\n            10111\n            11011\n            11101",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#FFFFFF","#000000"],1,i,l),renderSprite(r,fontstr,["#FFFFFF","#000000"],1,i,l+t)}else if("ŀ"==a){console.log("making custom noise line 2 character"),fontstr="11111\n            11111\n            11101\n            11101\n            11101\n            11101\n            10101\n            10001\n            10101\n            10111\n            10111\n            10111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#FFFFFF","#000000"],1,i,l),renderSprite(r,fontstr,["#FFFFFF","#000000"],1,i,l+t)}else if("Ŀ"==a){console.log("making custom noise line 3 character"),fontstr="11111\n            11111\n            11111\n            11111\n            00111\n            01111\n            11111\n            00000\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#FFFFFF","#000000"],1,i,l),renderSprite(r,fontstr,["#FFFFFF","#000000"],1,i,l+t)}else if("ļ"==a){console.log("making custom noise line 4 character"),fontstr="11111\n            11111\n            11111\n            11111\n            10000\n            11111\n            11110\n            11100\n            11111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#FFFFFF","#000000"],1,i,l),renderSprite(r,fontstr,["#FFFFFF","#000000"],1,i,l+t)}else if("¥"==a){console.log("making custom title 1 character"),fontstr="11111\n            11111\n            11111\n            11100\n            11110\n            11110\n            11110\n            11110\n            11110\n            11110\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("§"==a){console.log("making custom title 2 character"),fontstr="11111\n            11111\n            11111\n            01010\n            11010\n            11010\n            11000\n            11010\n            11010\n            11010\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("¤"==a){console.log("making custom title 3 character"),fontstr="11111\n            11111\n            11111\n            10001\n            10111\n            10111\n            10001\n            10111\n            10111\n            10001\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("¢"==a){console.log("making custom title 4 character"),fontstr="11111\n            11111\n            11111\n            10001\n            10111\n            10111\n            10001\n            11101\n            11101\n            10001\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("Ÿ"==a){console.log("making custom title 5 character"),fontstr="11111\n            11111\n            11111\n            00010\n            01010\n            01010\n            01010\n            01010\n            01010\n            00010\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("ŷ"==a){console.log("making custom title 6 character"),fontstr="11111\n            11111\n            11111\n            10101\n            10100\n            10100\n            10100\n            10101\n            10101\n            00101\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("ų"==a){console.log("making custom title 7 character"),fontstr="11111\n            11111\n            11111\n            10100\n            10101\n            10101\n            00101\n            00101\n            00101\n            10100\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("ø"==a){console.log("making custom title 7.1 character"),fontstr="11111\n            11111\n            11111\n            11111\n            01111\n            01111\n            01111\n            01111\n            01111\n            11111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("Ų"==a){console.log("making custom title 8 character"),fontstr="11111\n            11111\n            11111\n            11000\n            11010\n            11010\n            11010\n            11010\n            11010\n            11000\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("ű"==a){console.log("making custom title 9 character"),fontstr="11111\n            11111\n            11111\n            10001\n            10111\n            10001\n            10111\n            10111\n            10111\n            10111\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("ŧ"==a){console.log("making custom title 10 character"),fontstr="11111\n            11111\n            11111\n            10001\n            10111\n            10111\n            10001\n            11101\n            11101\n            10001\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("Ŧ"==a){console.log("making custom title 11 character"),fontstr="11111\n            11111\n            11111\n            00010\n            10110\n            10110\n            10110\n            10110\n            10110\n            00010\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("Ţ"==a){console.log("making custom title 12 character"),fontstr="11111\n            11111\n            11111\n            00100\n            10101\n            10101\n            01100\n            10101\n            10101\n            10100\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("Œ"==a){console.log("making custom title 13 character"),fontstr="11111\n            11111\n            11111\n            01011\n            11001\n            11001\n            01000\n            11010\n            11010\n            01011\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if("œ"==a){console.log("making custom title 14 character"),fontstr="11111\n            11111\n            11111\n            01000\n            01011\n            01011\n            01000\n            01110\n            01110\n            01000\n            11111\n            11111",fontstr=fontstr.split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFFFF"],1,i,l+t)}else if(font.hasOwnProperty(a)){fontstr=font[a].split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();i=o%t|0,l=o/t|0;"✓"==a?(renderSprite(r,fontstr,["#000000","#00FF00"],1,i,l),renderSprite(r,fontstr,["#000000","#00FF00"],0,i,l+t)):">"==a||"<"==a||"#"==a||"["==a||"]"==a||"Ć"==a||"ć"==a||"ľ"==a||"į"==a||"ķ"==a||"ť"==a||"ŏ"==a||"ń"==a||"ū"==a||"ě"==a||"Ĺ"==a||"Ġ"==a||"Ń"==a||"Ý"==a||"Ś"==a||"ś"==a||"ā"==a||"ď"==a||"ř"==a||"ñ"==a||"ŵ"==a?(renderSprite(r,fontstr,["#000000","#FFFF00"],1,i,l),renderSprite(r,fontstr,["#000000","#FFFF00"],0,i,l+t)):"*"==a||"+"==a?(renderSprite(r,fontstr,["#000000","#FF0000"],1,i,l),renderSprite(r,fontstr,["#000000","#FF0000"],0,i,l+t)):(renderSprite(r,fontstr,void 0,1,i,l),renderSprite(r,fontstr,["#00000000","#000000"],0,i,l+t))}}}var spriteimages,glyphImagesCorrespondance,glyphImages,glyphHighlight,glyphHighlightDiff,glyphHighlightResize,glyphPrintButton,glyphMouseOver,editor_s_grille=[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[0,1,1,1,0]],spritesheetCanvas=null;function regenSpriteImages(){if(console.log("sprites length: "+sprites.length),textMode)return spriteimages=[],void regenText();if(!0===IDE&&(textImages.editor_s=createSprite("chars",editor_s_grille,void 0)),0!==state.levels.length){spriteimages=[];var e=Math.ceil(Math.sqrt(sprites.length));null==spritesheetCanvas&&(spritesheetCanvas=document.createElement("canvas")),spritesheetCanvas.width=e*cellwidth,spritesheetCanvas.height=e*cellheight;for(var n=spritesheetCanvas.getContext("2d"),t=0;t<sprites.length;t++)if(null!=sprites[t]){canOpenEditor&&(spriteimages[t]=createSprite(t.toString(),sprites[t].dat,sprites[t].colors));var r=t%e|0,o=t/e|0;renderSprite(n,sprites[t].dat,sprites[t].colors,0,r,o)}canOpenEditor&&generateGlyphImages()}}var canvas,ctx,x,y,cellwidth,cellheight,xoffset,yoffset,lastDownTarget,glyphSelectedIndex=0,editorRowCount=1,editorGlyphMovements=[],canvasdict={};function makeSpriteCanvas(e){var n;return e in canvasdict?n=canvasdict[e]:(n=document.createElement("canvas"),canvasdict[e]=n),n.width=cellwidth,n.height=cellheight,n}function generateGlyphImages(){if(0!==cellwidth&&0!==cellheight){for(var e in glyphImagesCorrespondance=[],glyphImages=[],seenobjects={},state.glyphDict)if(1==e.length&&state.glyphDict.hasOwnProperty(e)){var n=state.glyphDict[e],t=n.join(",");if(seenobjects.hasOwnProperty(t))continue;var r=makeSpriteCanvas("C"+e),o=r.getContext("2d");glyphImagesCorrespondance.push(e),seenobjects[t]=!0;for(var a=0;a<n.length;a++){var i=n[a];-1!==i&&o.drawImage(spriteimages[i],0,0)}glyphImages.push(r)}if(IDE){(o=(glyphHighlight=makeSpriteCanvas("highlight")).getContext("2d")).fillStyle="#FFFFFF",o.fillRect(0,0,cellwidth,1),o.fillRect(0,0,1,cellheight),o.fillRect(0,cellheight-1,cellwidth,1),o.fillRect(cellwidth-1,0,1,cellheight),glyphPrintButton=textImages.editor_s,(o=(glyphHighlightDiff=makeSpriteCanvas("glyphHighlightDiff")).getContext("2d")).fillStyle=state.bgcolor,o.fillRect(0,0,cellwidth,2),o.fillRect(0,0,2,cellheight),o.fillRect(0,cellheight-2,cellwidth,2),o.fillRect(cellwidth-2,0,2,cellheight),o.fillStyle=state.fgcolor,o.fillRect(0,0,cellwidth,1),o.fillRect(0,0,1,cellheight),o.fillRect(0,cellheight-1,cellwidth,1),o.fillRect(cellwidth-1,0,1,cellheight),glyphPrintButton=textImages.editor_s,(o=(glyphHighlightResize=makeSpriteCanvas("highlightresize")).getContext("2d")).fillStyle="#FFFFFF";var l=cellwidth/2-1|0,s=cellwidth-l-1-l,c=cellheight/2-1|0,d=cellheight-c-1-l;o.fillRect(l,0,s,cellheight),o.fillRect(0,c,cellwidth,d),(o=(glyphMouseOver=makeSpriteCanvas("glyphMouseOver")).getContext("2d")).fillStyle="yellow",o.fillRect(0,0,cellwidth,2),o.fillRect(0,0,2,cellheight),o.fillRect(0,cellheight-2,cellwidth,2),o.fillRect(cellwidth-2,0,2,cellheight);const e=[[[3,2],[5,0],[7,2]],[[3,8],[5,10],[7,8]],[[2,3],[0,5],[2,7]],[[7,3],[10,5],[7,7]],[[3,5],[5,7],[7,5],[5,3]]];for(a=0;a<e.length;a++){editorGlyphMovements[a]=makeSpriteCanvas("editorGlyphMovements"+a);var u=e[a];(o=editorGlyphMovements[a].getContext("2d")).lineWidth=1,o.fillStyle=state.bgcolor,o.strokeStyle=state.fgcolor,o.beginPath(),o.moveTo(u[0][0]*cellwidth/10,u[0][1]*cellheight/10);for(var h=1;h<u.length;h++)o.lineTo(u[h][0]*cellwidth/10,u[h][1]*cellheight/10);o.closePath(),o.fill(),o.stroke()}}}}function glyphCount(){var e=0;for(var n in state.glyphDict)1==n.length&&state.glyphDict.hasOwnProperty(n)&&e++;return e}function redraw(){if(0!==cellwidth&&0!==cellheight){var e=Math.ceil(Math.sqrt(fontKeys.length));if(textMode)if(console.log("redrawing in text mode"),ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height),void 0!==state.metadata.custom_font&&loadedCustomFont){null===spritesheetCanvas&&regenSpriteImages();for(n=0;n<titleHeight;n++){drawTextWithCustomFont(titleImage[n],ctx,xoffset+titleWidth*cellwidth/2,yoffset+n*cellheight+cellheight/2)}}else for(var n=0;n<titleWidth;n++)for(var t=0;t<titleHeight;t++){var r=titleImage[t].charAt(n);if(r in font){var o=fontIndex[r],a=o%e|0,i=o/e|0;ctx.imageSmoothingEnabled=!1,"†"==r||"Æ"==r||"æ"==r||"®"==r||"€"==r||"¥"==r||"§"==r||"¤"==r||"¢"==r||"Ÿ"==r||"ŷ"==r||"ų"==r||"Ų"==r||"ű"==r||"ŧ"==r||"Ŧ"==r||"Ţ"==r||"Œ"==r||"œ"==r||"ŋ"==r||"ŉ"==r||"ł"==r||"Ł"==r||"ŀ"==r||"Ŀ"==r||"ļ"==r||"ĸ"==r||"ĳ"==r||"Ĳ"==r||"ø"==r?ctx.drawImage(textsheetCanvas,a*textcellwidth,i*textcellheight,textcellwidth,textcellheight,xoffset+n*cellwidth,yoffset+t*cellheight,1.25*cellwidth,1.2*cellheight):ctx.drawImage(textsheetCanvas,a*textcellwidth,i*textcellheight,textcellwidth,textcellheight,xoffset+n*cellwidth,yoffset+t*cellheight,cellwidth,cellheight)}}else{console.log("redrawing in normal mode");var l=level;ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);var s=0,c=screenwidth,d=0,u=screenheight,h={x:0,y:0};if(levelEditorOpened){var f=glyphCount();c-=2,u-=2+(editorRowCount=Math.ceil(f/(screenwidth-1)))}else if(flickscreen){if((m=getPlayerPositions()).length>0){var p=(v=m[0])/l.height|0,g=v%l.height|0;s=(p/screenwidth|0)*screenwidth,d=(g/screenheight|0)*screenheight,c=Math.min(s+screenwidth,l.width),u=Math.min(d+screenheight,l.height),oldflickscreendat=[s,d,c,u]}else oldflickscreendat.length>0&&(s=oldflickscreendat[0],d=oldflickscreendat[1],c=oldflickscreendat[2],u=oldflickscreendat[3])}else if(zoomscreen){var m;if((m=getPlayerPositions()).length>0){var v;p=(v=m[0])/l.height|0,g=v%l.height|0;s=Math.max(Math.min(p-(screenwidth/2|0),l.width-screenwidth),0),d=Math.max(Math.min(g-(screenheight/2|0),l.height-screenheight),0),c=Math.min(s+screenwidth,l.width),u=Math.min(d+screenheight,l.height),oldflickscreendat=[s,d,c,u]}else oldflickscreendat.length>0&&(s=oldflickscreendat[0],d=oldflickscreendat[1],c=oldflickscreendat[2],u=oldflickscreendat[3])}else smoothscreen&&(null!==cameraPositionTarget?(["x","y"].forEach((function(e){var n=cameraPositionTarget[e]-cameraPosition[e];0!==n&&(Math.abs(n)<.5/cellwidth?cameraPosition[e]=cameraPositionTarget[e]:(cameraPosition[e]+=n*state.metadata.smoothscreen.cameraSpeed,h[e]=cameraPosition[e]%1))})),s=Math.max(Math.min(Math.floor(cameraPosition.x)-Math.floor(screenwidth/2),level.width-screenwidth),0),d=Math.max(Math.min(Math.floor(cameraPosition.y)-Math.floor(screenheight/2),level.height-screenheight),0),c=Math.min(s+screenwidth,level.width),u=Math.min(d+screenheight,level.height),oldflickscreendat=[s,d,c,u]):oldflickscreendat.length>0&&(s=oldflickscreendat[0],d=oldflickscreendat[1],c=oldflickscreendat[2],u=oldflickscreendat[3]),ctx.save(),ctx.beginPath(),ctx.moveTo(xoffset,yoffset),ctx.lineTo(xoffset+(c-s)*cellwidth,yoffset),ctx.lineTo(xoffset+(c-s)*cellwidth,yoffset+(u-d)*cellwidth),ctx.lineTo(xoffset,yoffset+(u-d)*cellwidth),ctx.clip());screenOffsetX=s,screenOffsetY=d;var _=smoothscreen?1:0,y=Math.ceil(Math.sqrt(sprites.length));if(state.metadata.tween_length&&currentMovedEntities){var b=1-clamp(tweentimer/tweeninterval,0,1),w="linear",S=state.sprite_size;void 0!==state.metadata.tween_easing&&(w=state.metadata.tween_easing,NaN!=parseInt(w)&&easingAliases[parseInt(w)]&&(w=easingAliases[parseInt(w)]),w=w.toLowerCase()),void 0!==state.metadata.tween_snap&&(S=Math.max(parseInt(state.metadata.tween_snap),1)),null!=EasingFunctions[w]&&(b=EasingFunctions[w](b)),b=Math.floor(b*S)/S;for(var k=0;k<state.idDict.length;k++)for(var x=state.objects[state.idDict[k]].layer,n=Math.max(s-_,0);n<Math.min(c+_,l.width);n++)for(var t=Math.max(d-_,0);t<Math.min(u+_,l.height);t++){var M=t+n*l.height;if(0!=(E=l.getCellInto(M,_o12)).get(k)){T=k%y|0,A=k/y|0,R=xoffset+(n-s-h.x)*cellwidth,F=yoffset+(t-d-h.y)*cellheight;if(currentMovedEntities&&currentMovedEntities["p"+M+"-l"+x]){var C=currentMovedEntities["p"+M+"-l"+x];if(16!=C){var I=dirMasksDelta[C];R-=cellwidth*I[0]*b,F-=cellheight*I[1]*b}else 16==C&&(ctx.globalAlpha=1-b)}ctx.drawImage(spritesheetCanvas,T*cellwidth,A*cellheight,cellwidth,cellheight,Math.floor(R),Math.floor(F),cellwidth,cellheight),ctx.globalAlpha=1}}}else for(var n=Math.max(s-_,0);n<Math.min(c+_,l.width);n++)for(var t=Math.max(d-_,0);t<Math.min(u+_,l.height);t++)for(var M=t+n*l.height,E=l.getCellInto(M,_o12),k=0;k<state.objectCount;k++)if(0!=E.get(k)){var T=k%y|0,A=k/y|0,R=xoffset+(n-s-h.x)*cellwidth,F=yoffset+(t-d-h.y)*cellheight;ctx.drawImage(spritesheetCanvas,T*cellwidth,A*cellheight,cellwidth,cellheight,Math.floor(R),Math.floor(F),cellwidth,cellheight)}smoothscreen&&(state.metadata.smoothscreen.debug&&drawSmoothScreenDebug(ctx),ctx.restore()),levelEditorOpened&&drawEditorIcons(s,d)}}}function drawSmoothScreenDebug(e){e.save();var n=state.metadata.smoothscreen.boundarySize,t=getPlayerPositions();if(t.length>0){var r={x:t[0]/level.height|0,y:t[0]%level.height|0},o=r.x-cameraPosition.x,a=r.y-cameraPosition.y;e.fillStyle="#00ff00",e.beginPath(),e.arc(xoffset+(Math.floor(screenwidth/2)+o+.5)*cellwidth,yoffset+(Math.floor(screenheight/2)+a+.5)*cellheight,cellwidth/4,0,2*Math.PI),e.fill()}var i=cameraPositionTarget.x-cameraPosition.x,l=cameraPositionTarget.y-cameraPosition.y;e.fillStyle="#0000ff",e.beginPath(),e.arc(xoffset+(Math.floor(screenwidth/2)+i)*cellwidth,yoffset+(Math.floor(screenheight/2)+l)*cellheight,cellwidth/8,0,2*Math.PI),e.fill(),e.strokeStyle="#0000ff",e.lineWidth=cellwidth/16,e.strokeRect(xoffset+(Math.floor(screenwidth/2)+i-Math.floor(n.width/2))*cellwidth,yoffset+(Math.floor(screenheight/2)+l-Math.floor(n.height/2))*cellheight,n.width*cellwidth,n.height*cellheight),e.fillStyle="#ff0000",e.beginPath(),e.arc(xoffset+Math.floor(screenwidth/2)*cellwidth,yoffset+Math.floor(screenheight/2)*cellheight,cellwidth/4,0,2*Math.PI),e.fill(),e.strokeStyle="#ff0000",e.lineWidth=cellwidth/8,e.strokeRect(xoffset+(Math.floor(screenwidth/2)-Math.floor(n.width/2))*cellwidth,yoffset+(Math.floor(screenheight/2)-Math.floor(n.height/2))*cellheight,n.width*cellwidth,n.height*cellheight),e.restore()}function drawEditorIcons(e,n){glyphImages.length;var t=glyphImages.length-0;ctx.drawImage(glyphPrintButton,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount)),mouseCoordY===-1-editorRowCount&&-1===mouseCoordX&&ctx.drawImage(glyphMouseOver,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));for(var r=mouseCoordX+(screenwidth-1)*(l=editorRowCount-(-mouseCoordY-2)-1),o=0;o<t;o++){var a=glyphImages[0+o],i=o%(screenwidth-1),l=o/(screenwidth-1)|0;ctx.drawImage(a,xoffset+i*cellwidth,yoffset+l*cellheight-cellheight*(1+editorRowCount)),mouseCoordX>=0&&mouseCoordX<screenwidth-1&&r===o&&ctx.drawImage(glyphMouseOver,xoffset+i*cellwidth,yoffset+l*cellheight-cellheight*(1+editorRowCount)),o===glyphSelectedIndex&&ctx.drawImage(glyphHighlight,xoffset+i*cellwidth,yoffset+l*cellheight-cellheight*(1+editorRowCount))}var s="",c=null;if(mouseCoordX>=0&&mouseCoordX<screenwidth&&r>=0&&r<t){const e=glyphImagesCorrespondance[0+r];s=e,e in state.synonymsDict?s+=" = "+state.synonymsDict[e]:e in state.aggregatesDict&&(s+=" = "+state.aggregatesDict[e].join(" and "))}else if(mouseCoordX>=0&&mouseCoordY>=0&&mouseCoordX<screenwidth&&mouseCoordY<screenheight-editorRowCount){const t=level.getCellInto(mouseCoordY+n+(mouseCoordX+e)*level.height,_o12);null!==(c=state.idDict.filter(((e,n)=>0!=t.get(n))))&&(s=c.join(", "))}s.length>0&&(ctx.fillStyle=state.fgcolor,ctx.font='16px "Source Sans Pro", Helvetica, Arial, sans-serif',ctx.fillText(s,xoffset,yoffset-.4*cellheight)),mouseCoordX>=-1&&mouseCoordY>=-1&&mouseCoordX<screenwidth-1&&mouseCoordY<screenheight-1-editorRowCount&&(-1==mouseCoordX||-1==mouseCoordY||mouseCoordX==screenwidth-2||mouseCoordY===screenheight-2-editorRowCount?ctx.drawImage(glyphHighlightResize,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight):ctx.drawImage(glyphHighlight,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight))}window.addEventListener("resize",canvasResize,!1),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),x=0,y=0;var oldcellwidth=0,oldcellheight=0,oldtextmode=-1,oldfgcolor=-1,forceRegenImages=!1,textcellwidth=0,textcellheight=0;function canvasResize(){if(parentWidth=canvas.parentNode.clientWidth,parentHeight=canvas.parentNode.clientHeight,screenwidth=level.width,screenheight=level.height,void 0!==state)if(flickscreen=void 0!==state.metadata.flickscreen,zoomscreen=void 0!==state.metadata.zoomscreen,smoothscreen=void 0!==state.metadata.smoothscreen,levelEditorOpened){screenwidth+=2;var e=glyphCount();editorRowCount=Math.ceil(e/(screenwidth-1)),screenheight+=2+editorRowCount}else flickscreen?(screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1]):zoomscreen?(screenwidth=state.metadata.zoomscreen[0],screenheight=state.metadata.zoomscreen[1]):smoothscreen&&(screenwidth=state.metadata.smoothscreen.screenSize.width,screenheight=state.metadata.smoothscreen.screenSize.height);textMode&&(screenwidth=titleWidth,screenheight=titleHeight),cellwidth=parentWidth/screenwidth,cellheight=parentHeight/screenheight;var n=5,t=5;if(sprites.length>=2)n=sprites[1].dat.length,t=sprites[1].dat.length;textMode&&(n=6,t=font.X.length/n+1),cellwidth=n*Math.max(~~(cellwidth/n),1),cellheight=t*Math.max(~~(cellheight/t),1),0!=cellwidth&&0!=cellheight||textMode||(cellwidth=n,cellheight=t,console.log("Resized below 1")),xoffset=0,yoffset=0,cellwidth/n>cellheight/t||textMode&&void 0!==state.metadata.custom_font&&loadedCustomFont?(cellwidth=cellheight*n/t,xoffset=(parentWidth-cellwidth*screenwidth)/2,yoffset=(parentHeight-cellheight*screenheight)/2):(cellheight=cellwidth*t/n,yoffset=(parentHeight-cellheight*screenheight)/2,xoffset=(parentWidth-cellwidth*screenwidth)/2),yoffset<0&&(yoffset=0),xoffset<0&&(xoffset=0),levelEditorOpened&&!textMode&&(xoffset+=cellwidth,yoffset+=cellheight*(1+editorRowCount)),cellwidth|=0,cellheight|=0,xoffset|=0,yoffset|=0,textMode&&(textcellwidth=cellwidth,textcellheight=cellheight),(oldcellwidth!=cellwidth||oldcellheight!=cellheight||oldtextmode!=textMode||textMode||oldfgcolor!=state.fgcolor||forceRegenImages)&&(forceRegenImages=!1,regenSpriteImages()),oldcellheight=cellheight,oldcellwidth=cellwidth,oldtextmode=textMode,oldfgcolor=state.fgcolor,canvas.width=xoffset+cellwidth*screenwidth,canvas.height=yoffset+cellheight*screenheight,redraw()}EasingFunctions={linear:e=>e,easeinquad:e=>e*e,easeoutquad:e=>e*(2-e),easeinoutquad:e=>e<.5?2*e*e:(4-2*e)*e-1,easeincubic:e=>e*e*e,easeoutcubic:e=>--e*e*e+1,easeinoutcubic:e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,easeinquart:e=>e*e*e*e,easeoutquart:e=>1- --e*e*e*e,easeinoutquart:e=>e<.5?8*e*e*e*e:1-8*--e*e*e*e,easeinquint:e=>e*e*e*e*e,easeoutquint:e=>1+--e*e*e*e*e,easeinoutquint:e=>e<.5?16*e*e*e*e*e:1+16*--e*e*e*e*e},easingAliases={1:"linear",2:"easeInQuad",3:"easeOutQuad",4:"easeInOutQuad",5:"easeInCubic",6:"easeOutCubic",7:"easeInOutCubic",8:"easeInQuart",9:"easeOutQuart",10:"easeInOutQuart",11:"easeInQuint",12:"easeOutQuint",13:"easeInOutQuint"};var onLevelRestarted=new Event("levelRestarted"),RandomGen=new RNG,intro_template=["..................................","..................................","..................................","......Puzzle Script Terminal......","..............v 1.7+..............","..................................","..................................","..................................",".........insert cartridge.........","..................................","..................................","..................................",".................................."],sitelock_template=["..................................","..................................","..................................","......Puzzle Script Terminal......","..............v 1.7+..............","..................................","..................................","..................................",".....This game is sitelocked!.....","................................. ","................................  ","...............................   ","..............................    "],messagecontainer_template=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..........X to continue...........","..................................",".................................."],messagecontainer_template_mouse=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","........Ćľįćķ ťŏ ćŏńťįńūě.........","..................................",".................................."],titletemplate_firstgo=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..........>.start game.<..........","..................................",".................................."],titletemplate_firstgo_selected=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","+++++++++++.start game.++++++++++++","..................................",".................................."],titletemplate_empty=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................",".................................."],titletemplate_intro1=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸÆÆÆÆÆÆÆÆÆÆĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸÆ¥§¤Æ¢ŸŷųÆĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋÆŲűÆŧŦŢŒœÆĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®ÆÆÆÆÆ†ÆÆÆÆĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®ÆÆÆÆÆÆÆÆÆÆĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸæłĸĸĸĸĸæłĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro2=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸÆÆÆÆÆÆÆÆÆÆĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸÆ¥§¤Æ¢ŸŷųÆĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋÆŲűÆŧŦŢŒœÆĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®ÆÆÆÆÆ†ÆÆÆÆĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®ÆÆÆÆÆÆÆÆÆÆĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸæłĸĸĸĸĸæłĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro3=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸÆÆÆÆÆÆÆ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸÆ¥§¤Æ¢Ÿ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋÆŲűÆŧŦŢ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®ÆÆÆÆÆ†Æ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®ÆÆÆÆÆÆÆ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸæłĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro4=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸÆÆÆ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸÆ¥§","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋÆŲű","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®ÆÆÆ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®ÆÆÆ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸæł","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro5=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro10=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro9=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸÆĸĸÆĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸÆĸĸÆĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸÆÆĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro8=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸÆĸĸÆĸĳĸĸĸĸĸĸĸĸĸĸĸŁĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸÆÆÆÆĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro7=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸĲĸĸĲĸĳĸĸĸĸĸĸĸĸĸĸĸŁĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĸĸĳĸĸĸĸĸĸĸĸĸļĿĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸÆÆÆÆĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro6=["ĸĸĸĸĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĳĸĲĸĸĲĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀ","ĸĸĸĸĸĸĸĸĸĳĸĸĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸĸ","ĸĸĸĸĸĸĸĸĸĳĸÆÆÆÆĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],title_options=(titletemplate_intro5=["ĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĳĸĲĸĸĲĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸ","ĸĸĸĸĸĳĸĸĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋ","ĸĸĸĸĸĳĸÆÆÆÆĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®","ĸĸĸĸĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®","ĸĸĸĸĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro4=["ĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸÆÆÆ","ĸĳĸĲĸĸĲĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸÆÆ¥","ĸĳĸĸĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋÆÆÆ","ĸĳĸÆÆÆÆĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®ÆÆÆ","ĸĸĳĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®ÆÆÆ","ĸĸĸĳĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸæł","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro3=["ĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸÆÆÆÆÆÆÆ","ĸĸĲĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸÆÆ¥§¤†¢","ĸĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋÆÆÆÆ†††","ÆÆÆĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®ÆÆÆŲű†ŧ","ĸĸĸĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®ÆÆÆÆÆÆÆ","ĳĳĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸæłĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro2=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸÆÆÆÆÆÆÆÆÆÆÆ","ĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸÆÆ¥§¤†¢Ÿŷųø","ĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋÆÆÆÆ†††ÆÆÆÆ","ĳĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®ÆÆÆŲű†ŧŦŢŒœ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®ÆÆÆÆÆÆÆÆÆÆÆ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸæłĸĸĸĸĸĸæł","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],titletemplate_intro1=["ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸÆÆÆÆÆÆÆÆÆÆÆÆĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸŁŀĸÆÆ¥§¤†¢ŸŷųøÆĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸļĿĸŉŋÆÆÆÆ†††ÆÆÆÆÆĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ€®®ÆÆÆŲű†ŧŦŢŒœÆĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ®®®ÆÆÆÆÆÆÆÆÆÆÆÆĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸæłĸĸĸĸĸĸæłĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ","ĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸĸ"],[[".............Continue.............",".............Continue.............",".............Ćŏńťįńūě.............","...........>.Continue.<..........."],["...........Level Select...........","...........Level Select...........","...........ĹěÝěľ Śěľěćť...........",".........>.Level Select.<.........."],[".............Settings.............",".............Settings.............",".............Settings.............","...........>.Settings.<..........."],[".............New Game.............",".............New Game.............",".............Ńěŵ Ġāñě.............","...........>.New Game.<..........."],[".............Credits..............",".............Credits..............",".............Ćřěďįťś..............","...........>.Credits.<............"]]),titleImage=[],titleWidth=titletemplate_empty[0].length,titleHeight=titletemplate_empty.length,textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelectOptions=3,titleSelected=!1,hoverSelection=-1;function showContinueOptionOnTitleScreen(){return(curlevel>0||null!==curlevelTarget)&&curlevel in state.levels}function unloadGame(){state=introstate,(level=new Level(0,5,5,2,null,null)).objects=new Int32Array(0),generateTitleScreen(),canvasResize(),redraw(),titleSelected=!0}function isContinueOptionSelected(){return void 0===state.metadata.continue_is_level_select&&0==titleSelection}function isNewGameOptionSelected(){return titleSelection==titleSelectOptions-2}function isLevelSelectOptionSelected(){return void 0!==state.metadata.level_select&&(void 0!==state.metadata.continue_is_level_select?0==titleSelection:1==titleSelection)}function delay(e){return new Promise((n=>setTimeout(n,e)))}function isCreditsOptionSelected(){return void 0!==state.metadata.credits&&titleSelection==titleSelectOptions-1}function playIntro9(){4===titleMode&&(titleImage=deepClone(titletemplate_intro9),delay(2e3).then((()=>playIntro8())))}function playIntro8(){4===titleMode&&(titleImage=deepClone(titletemplate_intro8),delay(1200).then((()=>playIntro7())))}function playIntro7(){4===titleMode&&(titleImage=deepClone(titletemplate_intro7),delay(1200).then((()=>playIntro6())))}function playIntro6(){4===titleMode&&(titleImage=deepClone(titletemplate_intro6),delay(250).then((()=>playIntro5())))}function playIntro5(){4===titleMode&&(titleImage=deepClone(titletemplate_intro5),delay(250).then((()=>playIntro4())))}function playIntro4(){4===titleMode&&(titleImage=deepClone(titletemplate_intro4),delay(250).then((()=>playIntro3())))}function playIntro3(){4===titleMode&&(titleImage=deepClone(titletemplate_intro3),delay(250).then((()=>playIntro2())))}function playIntro2(){4===titleMode&&(titleImage=deepClone(titletemplate_intro2),delay(250).then((()=>playIntro1())))}function playIntro1(){4===titleMode&&(titleImage=deepClone(titletemplate_intro1),delay(250).then((()=>generateTitleScreen())))}function generateTitleScreen(){if(new Howl({src:["resources/sampleMusic.mp3"]}).play(),tryLoadCustomFont(),titleMode=showContinueOptionOnTitleScreen()?1:0,0!==state.levels.length)if(isSitelocked())titleImage=sitelock_template;else{var e="\n\tĸĸĸĸĸĸĸĸÆÆÆÆÆÆÆÆÆÆÆÆ\n\tĸĸĸĸĸŁŀĸÆÆ¥§¤†¢ŸŷųøÆ\n    ļĿĸŉŋÆÆÆÆ†††ÆÆÆÆÆ\n\tĸĸĸĸĸ€®®ÆÆÆŲű†ŧŦŢŒœÆ\n\tĸĸĸĸĸ®®®ÆÆÆÆÆÆÆÆÆÆÆÆ\n\tĸĸĸĸĸĸĸĸĸæłĸĸĸĸĸæłĸ";if(void 0!==state.metadata.title&&(e=state.metadata.title),0===titleMode)titleSelectOptions=2,titleImage=deepClone(titleSelected?titletemplate_firstgo_selected:titletemplate_firstgo);else{var n=[0];titleSelectOptions=2,void 0!==state.metadata.level_select&&void 0===state.metadata.continue_is_level_select&&(titleSelectOptions++,n.push(1)),void 0!==state.metadata.settings&&(titleSelectOptions++,n.push(2)),n.push(3),void 0!==state.metadata.credits&&(titleSelectOptions++,n.push(4)),titleImage=deepClone(titletemplate_empty);for(var t=0;t<titleSelectOptions;t++){var r=0,o=0;3==titleSelectOptions&&1==t&&(o=1);var a=8+t+o;titleSelection==t&&titleSelected&&(r=2),hoverSelection==a&&!titleSelected&&hoverSelection>=0&&(r=3),titleImage[a]=deepClone(title_options[n[t]][r])}}if(state.metadata.text_controls){for(t=0;t<titleImage.length;t++)titleImage[t]=titleImage[t].replace(/\./g," ");var i=wordwrap(state.metadata.text_controls,35,!0);i[0]&&(titleImage[10]=i[0]),i[1]&&(titleImage[11]=i[1]),i[2]&&(titleImage[12]=i[2])}else for(t=0;t<titleImage.length;t++)titleImage[t]=titleImage[t].replace(/\./g," ");var l=titleImage[0].length,s=wordwrap(e,titleImage[0].length);void 0!==state.metadata.author?s.length>3&&(s.splice(3),logWarning("Game title is too long to fit on screen, truncating to three lines.",void 0,!0)):s.length>6&&(s.splice(6),logWarning("Game title is too long to fit on screen, truncating to six lines.",void 0,!0));for(t=0;t<s.length;t++){var c=s[t],d=c.length,u=(l-d)/2|0,h=titleImage[1+t];titleImage[1+t]=h.slice(0,u)+c+h.slice(u+c.length)}if(void 0!==state.metadata.author){var f=wordwrap("by "+state.metadata.author,titleImage[0].length);f[0].length<titleImage[0].length&&(f[0]=" "+f[0]),f.length>3&&(f.splice(3),logWarning("Author list too long to fit on screen, truncating to three lines.",void 0,!0));for(t=0;t<f.length;t++){var p=f[t]+" ";p.length>l&&(p=p.slice(0,l));h=titleImage[3+t];titleImage[3+t]=h.slice(0,l-p.length)+p}}}else titleImage=intro_template}var levelSelectScrollPos=0;function gotoLevelSelectScreen(){if(void 0!==state.metadata.level_select){if(levelSelectScrollPos=0,titleSelected=!1,timer=0,quittingTitleScreen=!1,quittingMessageScreen=!1,messageselected=!1,titleMode=2,titleScreen=!0,textMode=!0,againing=!1,messagetext="",0==titleSelection)for(var e=0;e<state.sections.length;e++)if(state.sections[e].firstLevel>curlevel){titleSelection=Math.max(0,e-1);break}state.metadata=deepClone(state.default_metadata),twiddleMetadataExtras(),generateLevelSelectScreen(),redraw()}else goToTitleScreen()}function gotoCreditsScreen(){void 0!==state.metadata.credits?(levelSelectScrollPos=0,titleSelected=!1,timer=0,quittingTitleScreen=!1,quittingMessageScreen=!1,messageselected=!1,titleMode=3,titleScreen=!0,textMode=!0,againing=!1,messagetext="",twiddleMetadataExtras(),generateCreditsScreen(),redraw()):goToTitleScreen()}function generateCreditsScreen(){titleImage=[" [ ESC: Back ]                    ","              Credits             ","                                  ","           Developed by:          ","                Joey Meffen       ","                Nick Birtch       ","                                  ","     A PuzzleScript Plus Game     "],0==hoverSelection&&(titleImage[0]="[  ESC: Back  ]                   ");for(var e=titleImage.length;e<13;e++)titleImage.push("                                  ");redraw()}function generateLevelSelectScreen(){titleImage=[" [ ESC: Back ]                    ","           Level Select           "],0==hoverSelection&&(titleImage[0]="[  ESC: Back  ]                   "),amountOfLevelsOnScreen=9,titleSelectOptions=state.sections.length,titleSelection<levelSelectScrollPos?levelSelectScrollPos=titleSelection:titleSelection>=levelSelectScrollPos+amountOfLevelsOnScreen&&(levelSelectScrollPos=titleSelection-amountOfLevelsOnScreen+1);var e=titleSelection-levelSelectScrollPos;0==e&&(levelSelectScrollPos=Math.max(0,levelSelectScrollPos-1)),e==amountOfLevelsOnScreen-1&&(levelSelectScrollPos=Math.min(state.sections.length-amountOfLevelsOnScreen,levelSelectScrollPos+1)),0!=levelSelectScrollPos?2==hoverSelection?titleImage.push("                        [  PREV  ]"):titleImage.push("                         [ PREV ] "):titleImage.push("                                  ");var n=-1;if(void 0!==state.metadata.level_select_lock){for(var t=0;t<state.sections.length;t++)solvedSections.indexOf(state.sections[t].name)>=0?n=t:0;void 0===state.metadata.level_select_unlocked_ahead?n+=1:void 0!==state.metadata.level_select_unlocked_rollover?n=solvedSections.length+Number(state.metadata.level_select_unlocked_rollover)-1:n+=Number(state.metadata.level_select_unlocked_ahead)}for(t=levelSelectScrollPos;t<levelSelectScrollPos+amountOfLevelsOnScreen&&!(t<0||t>=state.sections.length);t++){var r=state.sections[t],o=solvedSections.indexOf(r.name)>=0,a=t==titleSelection,i=n>=0&&t>n,l=r.name.substring(0,31);if(i){a&&titleSelected&&(titleSelected=!1,quittingTitleScreen=!1);var s=l.length;l="";for(var c=0;c<s;c++)l+="*"}var d="✓";void 0!==state.metadata.level_select_solve_symbol&&(d=state.metadata.level_select_solve_symbol);var u=(o?d:" ")+" ",h=" ";hoverSelection-3+levelSelectScrollPos==t&&(h=">"),a&&titleSelected&&(h=" "),u+=h+" "+l;for(c=l.length;c<32;c++)u+=" ";titleImage.push(u)}levelSelectScrollPos!=titleSelectOptions-amountOfLevelsOnScreen&&titleSelectOptions-amountOfLevelsOnScreen>0?12==hoverSelection?titleImage.push("                        [  NEXT  ]"):titleImage.push("                         [ NEXT ] "):titleImage.push("                                  ");for(t=titleImage.length;t<13;t++)titleImage.push("                                  ");redraw()}function gotoLevel(e){solving||e<0||(againing=!1,messagetext="",curlevel=state.sections[e].firstLevel,loadLevelFromStateOrTarget(),updateLocalStorage(),resetFlickDat(),canvasResize(),clearInputHistory())}var introstate={title:"EMPTY GAME",attribution:"increpare",objectCount:2,metadata:[],levels:[],bgcolor:"#000000",fgcolor:"#FFFFFF"},state=introstate;function deepClone(e){if(!e)return e;if([Number,String,Boolean].forEach((function(t){e instanceof t&&(n=t(e))})),void 0===n)if("[object Array]"===Object.prototype.toString.call(e))n=[],e.forEach((function(e,t,r){n[t]=deepClone(e)}));else if("object"==typeof e)if(e.nodeType&&"function"==typeof e.cloneNode)var n=e.cloneNode(!0);else if(e.prototype)n=e;else if(e instanceof Date)n=new Date(e);else for(var t in n={},e)n[t]=deepClone(e[t]);else n=e;return n}function wordwrap(e,n,t=!1){if(!e)return e;var r=".{1,"+(n=n||75)+"}(\\s|$)|.{"+n+"}|.+$";if(t){splitNewlines=e.split("\\n");var o=[];return splitNewlines.forEach((e=>{o=o.concat(e.match(RegExp(r,"g")))})),o}return e.match(RegExp(r,"g"))}var splitMessage=[];function drawMessageScreen(){if(tryLoadCustomFont(),titleMode=0,textMode=!0,"text_message_continue"in state.metadata){titleImage=deepClone(messagecontainer_template);for(var e=0;e<titleImage.length;e++)titleImage[e]=titleImage[e].replace(/\./g," ");titleImage[10]=state.metadata.text_message_continue}else{titleImage=IsMouseGameInputEnabled()?deepClone(messagecontainer_template_mouse):deepClone(messagecontainer_template);for(e=0;e<titleImage.length;e++)titleImage[e]=titleImage[e].replace(/\./g," ")}var n=titleImage[9],t=titleImage[10];titleImage[10]=n;var r,o=titleImage[0].length;""===messagetext?r=state.levels[curlevel].message.trim():r=messagetext;var a=5-((splitMessage=wordwrap(r,titleImage[0].length,!0)).length/2|0);a<0&&(a=0);var i=Math.min(splitMessage.length,12);for(e=0;e<i;e++)if(splitMessage[e]){var l=splitMessage[e].trimRight(),s=a+e,c=l.length,d=(o-c)/2|0;if(state.metadata.message_text_align){var u=state.metadata.message_text_align.toLowerCase();"left"==u?d=0:"right"==u&&(d=o-c)}var h=titleImage[s];titleImage[s]=h.slice(0,d)+l+h.slice(d+l.length)}var f=10;i>=10&&(f=i<12?i+1:12),titleImage[f]=quittingMessageScreen?n:t,canvasResize()}var loadedLevelSeed=0;function loadLevelFromLevelDat(e,n,t,r){if(null==t&&(t=(Math.random()+Date.now()).toString()),RandomGen=new RNG(loadedLevelSeed=t),forceRegenImages=!0,ignoreNotJustPressedAction=!0,titleScreen=!1,titleMode=showContinueOptionOnTitleScreen()?1:0,titleSelection=0,titleSelected=!1,dragging=!1,rightdragging=!1,e.metadata=deepClone(e.default_metadata),againing=!1,void 0===n)return consolePrint("Trying to access a level that doesn't exist.",!0),void goToTitleScreen();void 0!==n.message?(ignoreNotJustPressedAction=!0,tryPlayShowMessageSound(),twiddleMetadataExtras(),drawMessageScreen(),canvasResize(),clearInputHistory()):void 0!==n.target?(setSectionSolved(e.levels[Number(curlevel)].section),gotoLevel(n.target)):(consolePrint("level loading"),titleMode=0,textMode=!1,level=n.clone(),RebuildLevelArrays(),void 0!==e&&(void 0!==e.metadata.flickscreen?oldflickscreendat=[0,0,Math.min(e.metadata.flickscreen[0],level.width),Math.min(e.metadata.flickscreen[1],level.height)]:void 0!==e.metadata.zoomscreen?oldflickscreendat=[0,0,Math.min(e.metadata.zoomscreen[0],level.width),Math.min(e.metadata.zoomscreen[1],level.height)]:void 0!==e.metadata.smoothscreen&&(oldflickscreendat=[0,0,Math.min(e.metadata.smoothscreen.screenSize.width,level.width),Math.min(e.metadata.smoothscreen.screenSize.height,level.height)])),initSmoothCamera(),twiddleMetadataExtras(),backups=[],restartTarget=backupLevel(),keybuffer=[],"run_rules_on_level_start"in e.metadata&&(runrulesonlevelstart_phase=!0,processInput(-1,!0),runrulesonlevelstart_phase=!1)),!0===r&&clearInputHistory()}function loadLevelFromStateTarget(e,n,t,r){curlevel=n,curlevelTarget=t,void 0===t.message&&tryPlayStartLevelSound(),consolePrint("level index = "+n+", target = "+t),loadLevelFromLevelDat(e,e.levels[n],r),restoreLevel(t,!0),restartTarget=t}function loadLevelFromState(e,n,t){var r=e.levels[n];curlevel=n,curlevelTarget=null,void 0!==r&&void 0===r.message&&(document.dispatchEvent(new CustomEvent("psplusLevelLoaded",{detail:n})),tryPlayStartLevelSound()),loadLevelFromLevelDat(e,r,t)}var sprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];function tryLoadCustomFont(){null==state||null==state.metadata||null==state.metadata.custom_font||loadedCustomFont||new FontFace("PuzzleCustomFont","url("+state.metadata.custom_font+")").load().then((function(e){document.fonts.add(e),loadedCustomFont=!0,canvasResize(),redraw()})).catch((function(e){alert("Unable to load font!")}))}function tryPlaySimpleSound(e){if(void 0!==state.sfx_Events[e]){var n=state.sfx_Events[e];"sfx10"==e||"sfx11"==e||"sfx12"==e||"sfx13"==e?playQuietSound(n):playSound(n)}}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}function tryPlayCancelSound(){tryPlaySimpleSound("cancel")}function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayEnterLevelSelectSound(){tryPlaySimpleSound("enterlevelselect")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}loadedCustomFont=!1,tryLoadCustomFont(),generateTitleScreen(),titleMode>0&&(titleSelection=0),canvasResize();var restartTarget,backups=[];function backupLevel(){var e={dat:new Int32Array(level.objects),width:level.width,height:level.height,oldflickscreendat:oldflickscreendat.concat([]),cameraPositionTarget:Object.assign({},cameraPositionTarget)};if(void 0!==state.metadata.runtime_metadata_twiddling){var n=deepClone(state.metadata);delete n.custom_font,e.metadata=n}return e}function level4Serialization(){return{dat:Array.from(level.objects),width:level.width,height:level.height,oldflickscreendat:oldflickscreendat.concat([]),cameraPositionTarget:Object.assign({},cameraPositionTarget)}}function tryDeactivateYoutube(){var e=document.getElementById("youtubeFrame");e&&document.body.removeChild(e)}function tryActivateYoutube(){if(!document.getElementById("youtubeFrame")&&canYoutube&&"youtube"in state.metadata){var e=state.metadata.youtube,n="https://www.youtube.com/embed/"+e+"?autoplay=1&loop=1&playlist="+e;(ifrm=document.createElement("IFRAME")).setAttribute("src",n),ifrm.setAttribute("id","youtubeFrame"),ifrm.style.visibility="hidden",ifrm.style.width="500px",ifrm.style.height="500px",ifrm.style.position="absolute",ifrm.style.top="-1000px",ifrm.style.left="-1000px",document.body.appendChild(ifrm)}}function setGameState(e,n,t){for(var r in oldflickscreendat=[],timer=0,autotick=0,winning=!1,againing=!1,messageselected=!1,STRIDE_MOV=e.STRIDE_MOV,STRIDE_OBJ=e.STRIDE_OBJ,sfxCreateMask=new BitVec(STRIDE_OBJ),sfxDestroyMask=new BitVec(STRIDE_OBJ),void 0===n&&(n=["restart"]),(0===state.levels.length||0===e.levels.length)&&n.length>0&&"rebuild"===n[0]&&(n=["restart"]),void 0===t&&(t=null),RandomGen=new RNG(t),state=e,"rebuild"!==n[0]&&(backups=[]),sprites=[],state.objects)if(state.objects.hasOwnProperty(r)){var o=state.objects[r],a={colors:o.colors,dat:o.spritematrix};sprites[o.id]=a}switch(void 0!==state.metadata.realtime_interval?(autotick=0,autotickinterval=1e3*state.metadata.realtime_interval):(autotick=0,autotickinterval=0),repeatinterval=void 0!==state.metadata.key_repeat_interval?1e3*state.metadata.key_repeat_interval:150,tweeninterval=void 0!==state.metadata.tween_length?1e3*state.metadata.tween_length:0,againinterval=void 0!==state.metadata.again_interval?1e3*state.metadata.again_interval:150,throttle_movement&&0===autotickinterval&&logWarning("throttle_movement is designed for use in conjunction with realtime_interval. Using it in other situations makes games gross and unresponsive, broadly speaking.  Please don't."),norepeat_action=void 0!==state.metadata.norepeat_action,storage_remove(document.URL+"_checkpoint"),storage_remove(document.URL),n[0]){case"restart":if(1==restarting){logWarning('A "restart" command is being triggered in the "run_rules_on_level_start" section of level creation, which would cause an infinite loop if it was actually triggered, but it\'s being ignored, so it\'s not.');break}winning=!1,timer=0,titleScreen=!0,tryPlayTitleSound(),textMode=!0,titleSelection=0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,showContinueOptionOnTitleScreen()&&(titleMode=1),void 0!==state.metadata.skip_title_screen?(consolePrint("skip_title_screen enabled, proceeding to do exactly as it says on the tin."),void 0!==state.metadata.continue_is_level_select?gotoLevelSelectScreen():titleMode<=1?nextLevel():2==titleMode&&gotoLevel(titleSelection)):(titleMode=4,playIntro9());break;case"rebuild":break;case"loadFirstNonMessageLevel":for(var i=0;i<state.levels.length;i++)if(!state.levels[i].hasOwnProperty("message")){curlevel=l=i,curlevelTarget=null,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,l,t);break}break;case"loadLevel":consolePrint("loading a level");var l=n[1];curlevel=l,curlevelTarget=null,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,l,t);break;case"levelline":var s=n[1];for(i=state.levels.length-1;i>=0;i--){if(state.levels[i].lineNumber<=s+1){curlevel=i,curlevelTarget=null,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,i);break}}}"rebuild"!==n[0]&&clearInputHistory(),canvasResize(),0==state.sounds.length&&null==state.metadata.youtube?killAudioButton():showAudioButton()}function RebuildLevelArrays(){level.movements=new Int32Array(level.n_tiles*STRIDE_MOV),level.rigidMovementAppliedMask=[],level.rigidGroupIndexMask=[],level.rowCellContents=[],level.rowCellContents_Movements=[],level.colCellContents=[],level.colCellContents_Movements=[],level.mapCellContents=new BitVec(STRIDE_OBJ),level.mapCellContents_Movements=new BitVec(STRIDE_MOV),_movementVecs=[new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV)],_o1=new BitVec(STRIDE_OBJ),_o2=new BitVec(STRIDE_OBJ),_o2_5=new BitVec(STRIDE_OBJ),_o3=new BitVec(STRIDE_OBJ),_o4=new BitVec(STRIDE_OBJ),_o5=new BitVec(STRIDE_OBJ),_o6=new BitVec(STRIDE_OBJ),_o7=new BitVec(STRIDE_OBJ),_o8=new BitVec(STRIDE_OBJ),_o9=new BitVec(STRIDE_OBJ),_o10=new BitVec(STRIDE_OBJ),_o11=new BitVec(STRIDE_OBJ),_o12=new BitVec(STRIDE_OBJ),_m1=new BitVec(STRIDE_MOV),_m2=new BitVec(STRIDE_MOV),_m3=new BitVec(STRIDE_MOV);for(var e=0;e<level.height;e++)level.rowCellContents[e]=new BitVec(STRIDE_OBJ);for(e=0;e<level.width;e++)level.colCellContents[e]=new BitVec(STRIDE_OBJ);for(e=0;e<level.height;e++)level.rowCellContents_Movements[e]=new BitVec(STRIDE_MOV);for(e=0;e<level.width;e++)level.colCellContents_Movements[e]=new BitVec(STRIDE_MOV);for(e=0;e<level.n_tiles;e++)level.rigidMovementAppliedMask[e]=new BitVec(STRIDE_MOV),level.rigidGroupIndexMask[e]=new BitVec(STRIDE_MOV)}var messagetext="",currentMovedEntities={},newMovedEntities={};function restoreLevel(e,n,t=!0,r=!0){var o=e.hasOwnProperty("diff");if(oldflickscreendat=e.oldflickscreendat.concat([]),t&&(currentMovedEntities={}),o)for(var a=0;a<e.dat.length;){var i=e.dat[a],l=e.dat[a+1];if(0===l)break;for(j=0;j<l;j++)level.objects[i+j]=e.dat[a+2+j];a+=2+l}else level.objects=new Int32Array(e.dat);if(level.width!==e.width||level.height!==e.height)level.width=e.width,level.height=e.height,level.n_tiles=e.width*e.height,RebuildLevelArrays();else{for(var s=0;s<level.n_tiles;s++)level.movements[s]=0,level.rigidMovementAppliedMask[s]=0,level.rigidGroupIndexMask[s]=0;for(s=0;s<level.height;s++){level.rowCellContents[s].setZero()}for(s=0;s<level.width;s++){level.colCellContents[s].setZero()}}e.cameraPositionTarget&&(cameraPositionTarget=Object.assign({},e.cameraPositionTarget),n&&(cameraPosition=Object.assign({},cameraPositionTarget))),void 0!==state.metadata.runtime_metadata_twiddling&&(void 0===e.metadata&&(e.metadata=deepClone(state.default_metadata),consolePrint("RUNTIME METADATA TWIDDLING: Reloaded level state that did not have saved metadata. Likely this state was recovered from a CHECKPOINT. Using the default metadata instead.",!0)),state.metadata=deepClone(e.metadata),twiddleMetadataExtras(r)),againing=!1,level.commandQueue=[],level.commandQueueSourceRules=[]}var zoomscreen=!1,flickscreen=!1,smoothscreen=!1,screenwidth=0,screenheight=0;function consolidateDiff(e,n){if(e.width!==n.width||e.height!==n.height||e.dat.length!==n.dat.length)return e;if(e.hasOwnProperty("diff")||n.hasOwnProperty("diff"))return e;if(e.dat.length<1024)return e;for(var t=new Int32Array(128),r=0,o=!1,a=-1,i=e.dat,l=n.dat,s=0;s<i.length;s++)if(!1===o){if(i[s]!==l[s]){if(o=!0,a=r,t.length<r+4)(c=new Int32Array(2*t.length)).set(t),t=c;t[r+0]=s,t[r+1]=1,t[r+2]=i[s],r+=3}}else if(i[s]!==l[s]){var c;if(r+1>=t.length)if(t.length<r+4)(c=new Int32Array(2*t.length)).set(t),t=c;t[a+1]++,t[r]=i[s],r++}else o=!1;return{diff:!0,dat:t,width:e.width,height:e.height,oldflickscreendat:e.oldflickscreendat}}function addUndoState(e){backups.push(e),backups.length>2&&!backups[backups.length-1].hasOwnProperty("diff")&&(backups[backups.length-3]=consolidateDiff(backups[backups.length-3],backups[backups.length-2]))}function DoRestart(e){!0!==restarting&&(!0!==e&&"norestart"in state.metadata||(restarting=!0,!0!==e&&addUndoState(backupLevel()),verbose_logging&&consolePrint("--- restarting ---",!0),restoreLevel(restartTarget,!0),tryPlayRestartSound(),document.dispatchEvent(new CustomEvent("psplusLevelRestarted",{detail:curlevel})),"run_rules_on_level_start"in state.metadata&&processInput(-1,!0),twiddleMetadataExtras(),level.commandQueue=[],level.commandQueueSourceRules=[],restarting=!1))}function backupDiffers(){if(0==backups.length)return!0;var e=backups[backups.length-1];if(e.hasOwnProperty("diff"))return 0!==e.dat.length&&0!==e.dat[1];for(var n=0;n<level.objects.length;n++)if(level.objects[n]!==e.dat[n])return!0;return!1}function DoUndo(e,n,t=!0,r=!0){if(levelEditorOpened||!("noundo"in state.metadata)||!0===e){if(verbose_logging&&consolePrint("--- undoing ---",!0),n)for(;0==backupDiffers();)backups.pop();if(backups.length>0)restoreLevel(backups[backups.length-1],null,t,r),backups=backups.splice(0,backups.length-1),e||tryPlayUndoSound()}}function getPlayerPositions(){var e=[],n=state.playerMask;for(i=0;i<level.n_tiles;i++)level.getCellInto(i,_o11),n.anyBitsInCommon(_o11)&&e.push(i);return e}function getLayersOfMask(e){for(var n=[],t=0;t<state.objectCount;t++)if(e.get(t)){var r=state.idDict[t],o=state.objects[r];n.push(o.layer)}return n}function moveEntitiesAtIndex(e,n,t){var r=level.getCell(e);r.iand(n);for(var o=getLayersOfMask(r),a=level.getMovements(e),i=0;i<o.length;i++)a.ishiftor(t,5*o[i]);level.setMovements(e,a);var l=e/level.height|0,s=e%level.height;level.colCellContents_Movements[l].ior(a),level.rowCellContents_Movements[s].ior(a),level.mapCellContents_Movements.ior(a)}function startMovement(e){for(var n=getPlayerPositions(),t=0;t<n.length;t++){moveEntitiesAtIndex(n[t],state.playerMask,e)}return n}var _movementVecs,dirMasksDelta={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},dirMaskName={1:"up",2:"down",4:"left",8:"right",15:"?",16:"action",3:"no"},seedsToPlay_CanMove=[],seedsToPlay_CantMove=[];function repositionEntitiesOnLayer(e,n,t){var r=dirMasksDelta[t],o=r[0],a=r[1],i=e/level.height|0,l=e%level.height,s=level.width-1,c=level.height-1;if(0===i&&o<0||i===s&&o>0||0===l&&a<0||l===c&&a>0)return!1;var d=e+r[1]+r[0]*level.height,u=state.layerMasks[n],h=level.getCellInto(d,_o7),f=level.getCellInto(e,_o8);if(u.anyBitsInCommon(h)&&16!=t)return!1;for(var p=0;p<state.sfx_MovementMasks.length;p++){var g=state.sfx_MovementMasks[p];if(g.objectMask.anyBitsInCommon(f)){var m=level.getMovements(e),v=g.directionMask;m.anyBitsInCommon(v)&&-1===seedsToPlay_CanMove.indexOf(g.seed)&&seedsToPlay_CanMove.push(g.seed)}}var _=f.clone();f.iclear(u),_.iand(u),h.ior(_),level.setCell(e,f),level.setCell(d,h);var y=d/level.height|0,b=d%level.height;return level.colCellContents[y].ior(_),level.rowCellContents[b].ior(_),level.mapCellContents.ior(_),!0}function repositionEntitiesAtCell(e){var n=level.getMovements(e);if(n.iszero())return!1;for(var t=!1,r=0;r<level.layerCount;r++){var o=n.getshiftor(31,5*r);if(0!==o)if(repositionEntitiesOnLayer(e,r,o)){if(state.metadata.tween_length){var a=dirMasksDelta[o],i=e+a[1]+a[0]*level.height;newMovedEntities["p"+i+"-l"+r]=o}n.ishiftclear(o,5*r),t=!0}}return level.setMovements(e,n),t}function Level(e,n,t,r,o,a){this.lineNumber=e,this.width=n,this.height=t,this.n_tiles=n*t,this.objects=o,this.section=a,this.layerCount=r,this.commandQueue=[],this.commandQueueSourceRules=[]}Level.prototype.delta_index=function(e){const[n,t]=dirMasksDelta[e];return n*this.height+t},Level.prototype.clone=function(){var e=new Level(this.lineNumber,this.width,this.height,this.layerCount,null,this.section);return e.objects=new Int32Array(this.objects),e},Level.prototype.getCell=function(e){return new BitVec(this.objects.subarray(e*STRIDE_OBJ,e*STRIDE_OBJ+STRIDE_OBJ))},Level.prototype.getCellInto=function(e,n){for(var t=0;t<STRIDE_OBJ;t++)n.data[t]=this.objects[e*STRIDE_OBJ+t];return n},Level.prototype.setCell=function(e,n){for(var t=0;t<n.data.length;++t)this.objects[e*STRIDE_OBJ+t]=n.data[t]};var _movementVecIndex=0;Level.prototype.getMovements=function(e){var n=_movementVecs[_movementVecIndex];_movementVecIndex=(_movementVecIndex+1)%_movementVecs.length;for(var t=0;t<STRIDE_MOV;t++)n.data[t]=this.movements[e*STRIDE_MOV+t];return n},Level.prototype.getMovementsInto=function(e,n){for(var t=n,r=0;r<STRIDE_MOV;r++)t.data[r]=this.movements[e*STRIDE_MOV+r];return t},Level.prototype.setMovements=function(e,n){for(var t=0;t<n.data.length;++t)this.movements[e*STRIDE_MOV+t]=n.data[t];var r=e/this.height|0,o=e%this.height;level.colCellContents_Movements[r].ior(n),level.rowCellContents_Movements[o].ior(n),level.mapCellContents_Movements.ior(n)};var ellipsisPattern=["ellipsis"];function BitVec(e){return this.data=new Int32Array(e),this}function Rule(e){this.direction=e[0],this.patterns=e[1],this.hasReplacements=e[2],this.lineNumber=e[3],this.isEllipsis=e[4],this.groupNumber=e[5],this.isRigid=e[6],this.commands=e[7],this.isRandom=e[8],this.cellRowMasks=e[9],this.cellRowMasks_Movements=e[10],this.isGlobal=e[11],this.ruleMask=this.cellRowMasks.reduce(((e,n)=>(e.ior(n),e)),new BitVec(STRIDE_OBJ)),this.cellRowMatches=[];for(var n=0;n<this.patterns.length;n++)this.cellRowMatches.push(this.generateCellRowMatchesFunction(this.patterns[n],this.isEllipsis[n]))}BitVec.prototype.cloneInto=function(e){for(var n=0;n<this.data.length;++n)e.data[n]=this.data[n];return e},BitVec.prototype.clone=function(){return new BitVec(this.data)},BitVec.prototype.iand=function(e){for(var n=0;n<this.data.length;++n)this.data[n]&=e.data[n]},BitVec.prototype.inot=function(){for(var e=0;e<this.data.length;++e)this.data[e]=~this.data[e]},BitVec.prototype.ior=function(e){for(var n=0;n<this.data.length;++n)this.data[n]|=e.data[n]},BitVec.prototype.iclear=function(e){for(var n=0;n<this.data.length;++n)this.data[n]&=~e.data[n]},BitVec.prototype.ibitset=function(e){this.data[e>>5]|=1<<(31&e)},BitVec.prototype.ibitclear=function(e){this.data[e>>5]&=~(1<<(31&e))},BitVec.prototype.get=function(e){return 0!=(this.data[e>>5]&1<<(31&e))},BitVec.prototype.getshiftor=function(e,n){var t=31&n,r=this.data[n>>5]>>>t;return t&&(r|=this.data[1+(n>>5)]<<32-t),r&e},BitVec.prototype.ishiftor=function(e,n){var t=31&n,r=e<<t;if(this.data[n>>5]|=r,t){var o=e>>32-t;this.data[1+(n>>5)]|=o}},BitVec.prototype.ishiftclear=function(e,n){var t=31&n,r=e<<t;if(this.data[n>>5]&=~r,t){var o=e>>32-(31&n);this.data[1+(n>>5)]&=~o}},BitVec.prototype.equals=function(e){if(this.data.length!==e.data.length)return!1;for(var n=0;n<this.data.length;++n)if(this.data[n]!==e.data[n])return!1;return!0},BitVec.prototype.setZero=function(){for(var e=0;e<this.data.length;++e)this.data[e]=0},BitVec.prototype.iszero=function(){for(var e=0;e<this.data.length;++e)if(this.data[e])return!1;return!0},BitVec.prototype.bitsSetInArray=function(e){for(var n=0;n<this.data.length;++n)if((this.data[n]&e[n])!==this.data[n])return!1;return!0},BitVec.prototype.bitsClearInArray=function(e){for(var n=0;n<this.data.length;++n)if(this.data[n]&e[n])return!1;return!0},BitVec.prototype.anyBitsInCommon=function(e){return!this.bitsClearInArray(e.data)},Rule.prototype.generateCellRowMatchesFunction=function(e,n){if(0==n){for(var t=e.length,r="",o=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,a=0;a<STRIDE_OBJ;++a)r+="var cellObjects"+a+" = objects[i"+o+(a?"+"+a:"")+"];\n";o=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(a=0;a<STRIDE_MOV;++a)r+="var cellMovements"+a+" = movements[i"+o+(a?"+"+a:"")+"];\n";r+="return "+e[0].generateMatchString("0_");for(var i=1;i<t;i++)r+="&&cellRow["+i+"].matches(i+"+i+"*d, objects, movements)";return(r+=";")in matchCache?matchCache[r]:matchCache[r]=new Function("cellRow","i","d","objects","movements",r)}t=e.length,r="var result = [];\n";r+="if(cellRow[0].matches(i, objects, movements)";for(i=1;e[i]!==ellipsisPattern;i++)r+="&&cellRow["+i+"].matches(i+"+i+"*d, objects, movements)";for(r+=") {\n",r+="\tfor (var k=kmin;k<kmax;k++) {\n",r+="\t\tif(cellRow["+ ++i+"].matches((i+d*(k+"+(i-1)+")), objects, movements)",i++;i<t;i++)r+="&&cellRow["+i+"].matches((i+d*(k+"+(i-1)+")), objects, movements)";return r+="){\n",r+="\t\t\tresult.push([i,k]);\n",r+="\t\t}\n",r+="\t}\n",r+="}\n",(r+="return result;")in matchCache?matchCache[r]:matchCache[r]=new Function("cellRow","i","kmax","kmin","d","objects","movements",r)},Rule.prototype.toJSON=function(){return[this.direction,this.patterns,this.hasReplacements,this.lineNumber,this.isEllipsis,this.groupNumber,this.isRigid,this.commands,this.isRandom,this.cellRowMasks,this.cellRowMasks_Movements]};var STRIDE_OBJ=1,STRIDE_MOV=1;function CellPattern(e){this.objectsPresent=e[0],this.objectsMissing=e[1],this.anyObjectsPresent=e[2],this.movementsPresent=e[3],this.movementsMissing=e[4],this.matches=this.generateMatchFunction(),this.replacement=e[5]}function CellReplacement(e){this.objectsClear=e[0],this.objectsSet=e[1],this.movementsClear=e[2],this.movementsSet=e[3],this.movementsLayerMask=e[4],this.randomEntityMask=e[5],this.randomDirMask=e[6]}var _o1,_o2,_o2_5,_o3,_o4,_o5,_o6,_o7,_o8,_o9,_o10,_o11,_o12,_m1,_m2,_m3,matchCache={};function matchCellRow(e,n,t,r,o,a,i){var l=[];if(!r.bitsSetInArray(level.mapCellContents.data)||!o.bitsSetInArray(level.mapCellContents_Movements.data))return l;if(i||void 0===state.metadata.local_radius)xmin=0,xmax=level.width,ymin=0,ymax=level.height;else{var s=parseInt(state.metadata.local_radius);xmin=Math.max(0,(playerPositions[0]/level.height|0)-s),xmax=Math.min(level.width,(playerPositions[0]/level.height|0)+s+1),ymin=Math.max(0,playerPositions[0]%level.height-s),ymax=Math.min(level.height,playerPositions[0]%level.height+s+1)}var c=t.length;switch(e){case 1:ymin+=c-1;break;case 2:ymax-=c-1;break;case 4:xmin+=c-1;break;case 8:xmax-=c-1;break;default:window.console.log("EEEP "+e)}if(e>2){for(var d=ymin;d<ymax;d++)if(r.bitsSetInArray(level.rowCellContents[d].data)&&o.bitsSetInArray(level.rowCellContents_Movements[d].data))for(var u=xmin;u<xmax;u++){n(t,h=u*level.height+d,a,level.objects,level.movements)&&l.push(h)}}else for(u=xmin;u<xmax;u++)if(r.bitsSetInArray(level.colCellContents[u].data)&&o.bitsSetInArray(level.colCellContents_Movements[u].data))for(d=ymin;d<ymax;d++){var h;n(t,h=u*level.height+d,a,level.objects,level.movements)&&l.push(h)}return l}function matchCellRowWildCard(e,n,t,r,o,a){var i=[];if(!r.bitsSetInArray(level.mapCellContents.data)||!o.bitsSetInArray(level.mapCellContents_Movements.data))return i;var l=0,s=level.width,c=0,d=level.height,u=t.length-1;switch(e){case 1:c+=u-1;break;case 2:d-=u-1;break;case 4:l+=u-1;break;case 8:s-=u-1;break;default:window.console.log("EEEP2 "+e)}if(e>2){for(var h=c;h<d;h++)if(r.bitsSetInArray(level.rowCellContents[h].data)&&o.bitsSetInArray(level.rowCellContents_Movements[h].data))for(var f=l;f<s;f++){var p=f*level.height+h;4===e?g=f-u+2:8===e?g=level.width-(f+u)+1:window.console.log("EEEP2 "+e),i.push.apply(i,n(t,p,g,0,a,level.objects,level.movements))}}else for(f=l;f<s;f++)if(r.bitsSetInArray(level.colCellContents[f].data)&&o.bitsSetInArray(level.colCellContents_Movements[f].data))for(h=c;h<d;h++){var g;p=f*level.height+h;2===e?g=level.height-(h+u)+1:1===e?g=h-u+2:window.console.log("EEEP2 "+e),i.push.apply(i,n(t,p,g,0,a,level.objects,level.movements))}return i}function generateTuples(e){for(var n=[[]],t=0;t<e.length;t++){for(var r=e[t],o=[],a=0;a<r.length;a++)for(var i=r[a],l=0;l<n.length;l++){var s=n[l].concat([i]);o.push(s)}n=o}return n}function twiddleMetadataExtras(e=!0){void 0!==state.metadata.realtime_interval?(e&&(autotick=0),autotickinterval=1e3*state.metadata.realtime_interval):(autotick=0,autotickinterval=0),againinterval=void 0!==state.metadata.again_interval?1e3*state.metadata.again_interval:150,tweeninterval=void 0!==state.metadata.tween_length?Math.max(1e3*state.metadata.tween_length,0):0,repeatinterval=void 0!==state.metadata.key_repeat_interval?1e3*state.metadata.key_repeat_interval:150,"background_color"in state.metadata?state.bgcolor=colorToHex(colorPalette,state.metadata.background_color):state.bgcolor="#000000","text_color"in state.metadata?state.fgcolor=colorToHex(colorPalette,state.metadata.text_color):state.fgcolor="#FFFFFF"}function showTempMessage(){solving||(keybuffer=[],textMode=!0,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,ignoreNotJustPressedAction=!0,tryPlayShowMessageSound(),drawMessageScreen(),canvasResize())}function processOutputCommands(e){for(var n=0;n<e.length;n++){var t=e[n];"f"===t.charAt(1)&&tryPlaySimpleSound(t),!1===unitTesting&&"message"===t&&showTempMessage()}}function applyRandomRuleGroup(e,n){for(var t=[],r=0;r<n.length;r++){var o=(c=n[r]).findMatches();if(o.length>0)for(var a=generateTuples(o),i=0;i<a.length;i++){var l=a[i];t.push([r,l])}}if(0===t.length)return!1;var s=t[Math.floor(RandomGen.uniform()*t.length)],c=n[r=s[0]];l=s[1];const d=e.delta_index(c.direction);var u=c.applyAt(e,l,!1,d);return c.queueCommands(),u}function applyRuleGroup(e){if(e[0].isRandom)return applyRandomRuleGroup(level,e);for(var n=!1,t=!0,r=0,o=-1;t;){if(++r>200){logErrorCacheable("Got caught looping lots in a rule group :O",e[0].lineNumber,!0);break}t=!1;for(var a=0;a<e.length;a++){if(e[a].tryApply(level)?(t=!0,o=0):o++,o===e.length)break}t&&(n=!0,verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(level,-2)))}return n}function applyRules(e,n,t,r){playerPositions=getPlayerPositions();for(var o=t>0,a=0,i=t;i<e.length;){if(r&&r[i]);else o=applyRuleGroup(e[i])||o;if(o&&void 0!==n[i]){if(i=n[i],o=!1,++a>200){logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",e[i][0].lineNumber,!0);break}verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(level,-2))}else{if(++i===e.length&&o&&void 0!==n[i]&&(i=n[i],o=!1,++a>200)){logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",e[i][0].lineNumber,!0);break}verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(level,-2))}}}function resolveMovements(e,n){for(var t=!0;t;){t=!1;for(var r=0;r<e.n_tiles;r++)t=repositionEntitiesAtCell(r)||t}var o=!1;for(r=0;r<e.n_tiles;r++){var a=e.getCellInto(r,_o6),i=e.getMovements(r);if(!i.iszero()){var l=e.rigidMovementAppliedMask[r];if(0!==l&&(i.iand(l),!i.iszero()))for(var s=0;s<e.layerCount;s++){if(0!==i.getshiftor(31,5*s)){var c=e.rigidGroupIndexMask[r].getshiftor(31,5*s);c--,n[state.rigidGroupIndex_to_GroupIndex[c]]=!0,o=!0;break}}for(s=0;s<state.sfx_MovementFailureMasks.length;s++){var d=state.sfx_MovementFailureMasks[s];if(d.objectMask.anyBitsInCommon(a)){var u=d.directionMask;i.anyBitsInCommon(u)&&-1===seedsToPlay_CantMove.indexOf(d.seed)&&seedsToPlay_CantMove.push(d.seed)}}}for(s=0;s<STRIDE_MOV;s++)e.movements[s+r*STRIDE_MOV]=0;e.rigidGroupIndexMask[r]=0,e.rigidMovementAppliedMask[r]=0}return o}CellPattern.prototype.generateMatchString=function(){for(var e="(true",n=0;n<Math.max(STRIDE_OBJ,STRIDE_MOV);++n){var t="cellObjects"+n,r="cellMovements"+n,o=this.objectsPresent.data[n],a=this.objectsMissing.data[n],i=this.movementsPresent.data[n],l=this.movementsMissing.data[n];o&&(e+=o&o-1?"\t\t&& (("+t+"&"+o+")==="+o+")\n":"\t\t&& ("+t+"&"+o+")\n"),a&&(e+="\t\t&& !("+t+"&"+a+")\n"),i&&(e+=i&i-1?"\t\t&& (("+r+"&"+i+")==="+i+")\n":"\t\t&& ("+r+"&"+i+")\n"),l&&(e+="\t\t&& !("+r+"&"+l+")\n")}for(var s=0;s<this.anyObjectsPresent.length;s++){e+="\t\t&& (0";for(n=0;n<STRIDE_OBJ;++n){var c=this.anyObjectsPresent[s].data[n];c&&(e+="|(cellObjects"+n+"&"+c+")")}e+=")"}return e+="\t)"},CellPattern.prototype.generateMatchFunction=function(){for(var e="",n=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,t=0;t<STRIDE_OBJ;++t)e+="\tvar cellObjects"+t+" = objects[i"+n+(t?"+"+t:"")+"];\n";n=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(t=0;t<STRIDE_MOV;++t)e+="\tvar cellMovements"+t+" = movements[i"+n+(t?"+"+t:"")+"];\n";return(e+="return "+this.generateMatchString()+";")in matchCache?matchCache[e]:matchCache[e]=new Function("i","objects","movements",e)},CellPattern.prototype.toJSON=function(){return[this.movementMask,this.cellMask,this.nonExistenceMask,this.moveNonExistenceMask,this.moveStationaryMask,this.randomDirOrEntityMask,this.movementsToRemove]},CellPattern.prototype.replace=function(e,n){var t=this.replacement;if(null===t)return!1;var r=t.randomEntityMask,o=t.randomDirMask,a=t.objectsSet.cloneInto(_o1),i=t.objectsClear.cloneInto(_o2),l=t.movementsSet.cloneInto(_m1),s=t.movementsClear.cloneInto(_m2);if(s.ior(t.movementsLayerMask),!r.iszero()){for(var c=[],d=0;d<32*STRIDE_OBJ;d++)r.get(d)&&c.push(d);var u=c[Math.floor(RandomGen.uniform()*c.length)],h=state.idDict[u],f=state.objects[h];a.ibitset(u),i.ior(state.layerMasks[f.layer]),s.ishiftor(31,5*f.layer)}if(!o.iszero())for(var p=0;p<level.layerCount;p++)if(o.get(5*p)){var g=Math.floor(4*RandomGen.uniform());l.ibitset(g+5*p)}var m=level.getCellInto(n,_o2_5),v=level.getMovements(n),_=m.cloneInto(_o3),y=v.cloneInto(_m3);m.iclear(i),m.ior(a),v.iclear(s),v.ior(l);var b=!1,w=0,S=0;if(e.isRigid){var k=state.groupNumber_to_RigidGroupIndex[e.groupNumber];k++;for(var x=new BitVec(STRIDE_MOV),M=0;M<level.layerCount;M++)x.ishiftor(k,5*M);x.iand(t.movementsLayerMask),w=level.rigidGroupIndexMask[n]||new BitVec(STRIDE_MOV),S=level.rigidMovementAppliedMask[n]||new BitVec(STRIDE_MOV),x.bitsSetInArray(w.data)||t.movementsLayerMask.bitsSetInArray(S.data)||(w.ior(x),S.ior(t.movementsLayerMask),b=!0)}var C=!1;if(!_.equals(m)||!y.equals(v)||b){C=!0,b&&(level.rigidGroupIndexMask[n]=w,level.rigidMovementAppliedMask[n]=S);var I=m.cloneInto(_o4);I.iclear(_),sfxCreateMask.ior(I);var E=_.cloneInto(_o5);E.iclear(m),sfxDestroyMask.ior(E),level.setCell(n,m),level.setMovements(n,v);var T=n/level.height|0,A=n%level.height;level.colCellContents[T].ior(m),level.rowCellContents[A].ior(m),level.mapCellContents.ior(m),level.colCellContents_Movements[T].ior(v),level.rowCellContents_Movements[A].ior(v),level.mapCellContents_Movements.ior(v)}return C},Rule.prototype.findMatches=function(){if(!this.ruleMask.bitsSetInArray(level.mapCellContents.data))return[];const e=level.delta_index(this.direction);for(var n=[],t=this.cellRowMasks,r=this.cellRowMasks_Movements,o=0;o<this.patterns.length;o++){var a=this.patterns[o],i=this.cellRowMatches[o];if(this.isEllipsis[o])var l=matchCellRowWildCard(this.direction,i,a,t[o],r[o],e);else l=matchCellRow(this.direction,i,a,t[o],r[o],e,this.isGlobal);if(0===l.length)return[];n.push(l)}return n},Rule.prototype.directional=function(){for(var e=0;e<state.rules.length;e++)for(var n=state.rules[e],t=0,r=0;r<n.length;r++)if(this.lineNumber===n[r].lineNumber&&t++,t>1)return!0;return!1},Rule.prototype.applyAt=function(e,n,t,r){var o=this;if(t)for(var a=0;a<this.patterns.length;a++)if(this.isEllipsis[a]){if(0==this.cellRowMatches[a](this.patterns[a],n[a][0],n[a][1]+1,n[a][1],r,e.objects,e.movements).length)return!1}else if(!this.cellRowMatches[a](this.patterns[a],n[a],r,e.objects,e.movements))return!1;var i=!1;for(a=0;a<o.patterns.length;a++)for(var l=o.patterns[a],s=o.isEllipsis[a]?n[a][0]:n[a],c=0;c<l.length;c++){var d=l[c];if(d!==ellipsisPattern)i=d.replace(o,s)||i,s+=r;else s+=r*n[a][1]}if(verbose_logging&&i){var u=dirMaskName[o.direction];o.directional()||(u="");var h=addToDebugTimeline(e,o.lineNumber);consolePrint(`<font color="green">Rule <a onclick="jumpToLine(${o.lineNumber});"  href="javascript:void(0);">${o.lineNumber}</a> ${u} applied.</font>`,!1,o.lineNumber,h)}return i},Rule.prototype.tryApply=function(e){const n=e.delta_index(this.direction);var t=this.findMatches();if(0===t.length)return!1;var r=!1;if(this.hasReplacements)for(var o=generateTuples(t),a=0;a<o.length;a++){var i=o[a],l=a>0;r=this.applyAt(e,i,l,n)||r}return t.length>0&&this.queueCommands(),r},Rule.prototype.queueCommands=function(){var e=this.commands;if(0!=e.length){for(var n=level.commandQueue.indexOf("cancel")>=0,t=level.commandQueue.indexOf("restart")>=0,r=!1,o=!1,a=0;a<e.length;a++){var i=e[a][0];"cancel"===i?r=!0:"restart"===i&&(o=!0)}if(!n&&(!t||r)){(r||o)&&(level.commandQueue=[],level.commandQueueSourceRules=[],messagetext="");for(a=0;a<e.length;a++){var l=e[a];if(!(level.commandQueue.indexOf(l[0])>=0)){if(level.commandQueue.push(l[0]),level.commandQueueSourceRules.push(this),verbose_logging){var s=this.lineNumber;dirMaskName[this.direction];consolePrint('<font color="green">Rule <a onclick="jumpToLine('+s.toString()+');"  href="javascript:void(0);">'+s.toString()+"</a> triggers command "+l[0]+".</font>",!1,s,null)}if("message"===l[0]&&(messagetext=l[1]),"goto"===l[0]&&gotoLevel(l[1]),void 0!==state.metadata.runtime_metadata_twiddling&&twiddleable_params.includes(l[0])&&(value=l[1],"wipe"==value?(delete state.metadata[l[0]],value=null):"default"==value&&(value=deepClone(state.default_metadata[l[0]])),null!=value&&(state.metadata[l[0]]=value),"zoomscreen"!==l[0]&&"flickscreen"!==l[0]||(twiddleMetaData(state,!0),canvasResize()),"smoothscreen"===l[0]&&(void 0!==value?(twiddleMetaData(state,!0),initSmoothCamera()):smoothscreen=!1,canvasResize()),twiddleMetadataExtras(),void 0!==state.metadata.runtime_metadata_twiddling_debug)){var c="Metadata twiddled: Flag "+l[0]+" set to "+value;value!=l[1]&&(c+=" ("+l[1]+")"),consolePrintFromRule(c,this,!0)}}}}}};var playerPositions,playerPositionsAtTurnStart,sfxCreateMask=null,sfxDestroyMask=null;function calculateRowColMasks(){for(var e=0;e<level.mapCellContents.length;e++)level.mapCellContents[e]=0,level.mapCellContents_Movements[e]=0;for(e=0;e<level.width;e++){level.colCellContents[e].setZero(),level.colCellContents_Movements[e].setZero()}for(e=0;e<level.height;e++){level.rowCellContents[e].setZero(),level.rowCellContents_Movements[e].setZero()}for(e=0;e<level.width;e++)for(var n=0;n<level.height;n++){var t=n+e*level.height,r=level.getCellInto(t,_o9);level.mapCellContents.ior(r),level.rowCellContents[n].ior(r),level.colCellContents[e].ior(r);var o=level.getMovementsInto(t,_m1);level.mapCellContents_Movements.ior(o),level.rowCellContents_Movements[n].ior(o),level.colCellContents_Movements[e].ior(o)}}function processInput(e,n,t,r){t||(newMovedEntities={});var o=e;if(againing=!1,null==r&&(r=backupLevel()),playerPositions=[],playerPositionsAtTurnStart=getPlayerPositions(),e<=5){if(verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(level,-2)),e>=0&&e<=4){switch(e){case 0:e=parseInt("00001",2);break;case 1:e=parseInt("00100",2);break;case 2:e=parseInt("00010",2);break;case 3:e=parseInt("01000",2);break;case 4:e=parseInt("10000",2)}playerPositions=startMovement(e)}if(verbose_logging){consolePrint("Applying rules");var a=addToDebugTimeline(level,-1);consolePrint(-1===e?"Turn starts with no input.":`Turn starts with input of ${["up","left","down","right","action","mouse"][o]}.`,!1,null,a)}bannedGroup=[],level.commandQueue=[],level.commandQueueSourceRules=[];var i=0,l=!1;const b={objects:new Int32Array(level.objects),movements:new Int32Array(level.movements),rigidGroupIndexMask:level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:level.rigidMovementAppliedMask.concat([]),commandQueue:[],commandQueueSourceRules:[]};sfxCreateMask.setZero(),sfxDestroyMask.setZero(),seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],calculateRowColMasks();var s=0;do{if(l=!1,s++,applyRules(state.rules,state.loopPoint,i,bannedGroup),resolveMovements(level,bannedGroup))l=!0,consolePrint("Rigid movement application failed. Rolling back..."),level.objects=new Int32Array(b.objects),level.movements=new Int32Array(b.movements),level.rigidGroupIndexMask=b.rigidGroupIndexMask.concat([]),level.rigidMovementAppliedMask=b.rigidMovementAppliedMask.concat([]),level.commandQueue=b.commandQueue.concat([]),level.commandQueueSourceRules=b.commandQueueSourceRules.concat([]),sfxCreateMask.setZero(),sfxDestroyMask.setZero(),verbose_logging&&l&&s>0&&(consolePrint("Relooping through rules because of rigid."),debugger_turnIndex++,addToDebugTimeline(level,-2)),i=0;else{if(verbose_logging){var c=debug_visualisation_array[debugger_turnIndex].length+1;consolePrint("Processed movements.",!1,null,a=addToDebugTimeline(level,c)),state.lateRules.length>0&&(debugger_turnIndex++,addToDebugTimeline(level,-2),consolePrint("Applying late rules"))}applyRules(state.lateRules,state.lateLoopPoint,0),i=0}}while(s<250&&l);if(s>=250)return consolePrint("looped through 250 times, gave up. Too many loops!"),applyRules(state.lateRules,state.lateLoopPoint,0),i=0,backups.push(r),DoUndo(!0,!1),!1;if(level.commandQueue.indexOf("undo")>=0)return verbose_logging&&(consoleCacheDump(),consolePrint("UNDO command executed, undoing turn.",!0)),messagetext="",DoUndo(!0,!1),!0;if(playerPositionsAtTurnStart.length>0&&void 0!==state.metadata.require_player_movement&&e>=0){var d=!1;for(s=0;s<playerPositionsAtTurnStart.length;s++){var u=playerPositionsAtTurnStart[s],h=level.getCell(u);if(state.playerMask.bitsClearInArray(h.data)){d=!0;break}}if(!1===d)return verbose_logging&&(consolePrint("require_player_movement set, but no player movement detected, so cancelling turn."),consoleCacheDump()),addUndoState(r),DoUndo(!0,!1),!1}if(level.commandQueue.indexOf("cancel")>=0){if(verbose_logging)consoleCacheDump(),consolePrintFromRule("CANCEL command executed, cancelling turn.",v=level.commandQueueSourceRules[level.commandQueue.indexOf("cancel")],!0);return processOutputCommands(level.commandQueue),addUndoState(r),DoUndo(!0,!1,!0,!1),tryPlayCancelSound(),!1}if(level.commandQueue.indexOf("restart")>=0){if(verbose_logging)consolePrintFromRule("RESTART command executed, reverting to restart state.",v=level.commandQueueSourceRules[level.commandQueue.indexOf("restart")]),consoleCacheDump();return processOutputCommands(level.commandQueue),addUndoState(r),DoRestart(!0),!0}if(level.commandQueue.indexOf("quit")>=0&&!solving){if(verbose_logging)consolePrintFromRule("QUIT command executed, exiting level.",v=level.commandQueueSourceRules[level.commandQueue.indexOf("restart")]),consoleCacheDump();return void 0!==state.metadata.level_select?gotoLevelSelectScreen():goToTitleScreen(),messagetext="",canvasResize(),!0}if(t&&level.commandQueue.indexOf("win")>=0)return!0;var f=!0;if(!winning&&level.commandQueue.indexOf("nosave")>=0){if(verbose_logging)consolePrintFromRule("NOSAVE command executed, not storing current state to undo queue.",v=level.commandQueueSourceRules[level.commandQueue.indexOf("nosave")]);f=!1}var p=!1;for(s=0;s<level.objects.length;s++)if(level.objects[s]!==r.dat[s]){if(t)return verbose_logging&&consoleCacheDump(),addUndoState(r),DoUndo(!0,!1,!1),!0;-1!==e&&f&&addUndoState(r),p=!0,updateCameraPositionTarget();break}if(t&&level.commandQueue.indexOf("win")>=0)return!0;if(t)return verbose_logging&&consoleCacheDump(),!1;for(s=0;s<seedsToPlay_CantMove.length;s++)playSound(seedsToPlay_CantMove[s]);for(s=0;s<seedsToPlay_CanMove.length;s++)playSound(seedsToPlay_CanMove[s]);for(s=0;s<state.sfx_CreationMasks.length;s++){var g=state.sfx_CreationMasks[s];sfxCreateMask.anyBitsInCommon(g.objectMask)&&playSound(g.seed)}for(s=0;s<state.sfx_DestructionMasks.length;s++){g=state.sfx_DestructionMasks[s];sfxDestroyMask.anyBitsInCommon(g.objectMask)&&playSound(g.seed)}if(processOutputCommands(level.commandQueue),!1===textMode&&(verbose_logging&&consolePrint("Checking win conditions."),void 0===n&&(n=!1),checkWin(n)),!winning){if(level.commandQueue.indexOf("checkpoint")>=0){if(verbose_logging)consolePrintFromRule("CHECKPOINT command executed, saving current state to the restart state.",v=level.commandQueueSourceRules[level.commandQueue.indexOf("checkpoint")]);restartTarget=level4Serialization(),hasUsedCheckpoint=!0;var m=JSON.stringify(restartTarget);storage_set(document.URL+"_checkpoint",m),storage_set(document.URL,curlevel)}if(level.commandQueue.indexOf("again")>=0){var v=level.commandQueueSourceRules[level.commandQueue.indexOf("again")],_=verbose_logging,y=messagetext;verbose_logging=!1,processInput(-1,!0,!0),(verbose_logging=_)&&consolePrintFromRule("AGAIN command executed, with changes detected - will execute another turn.",v),againing=!0,timer=0,verbose_logging=_,messagetext=y}}verbose_logging&&consolePrint("Turn complete"),currentMovedEntities=newMovedEntities,tweentimer=0,level.commandQueue=[],level.commandQueueSourceRules=[]}return verbose_logging&&consoleCacheDump(),winning&&(againing=!1),p}function checkWin(e){if(levelEditorOpened&&(e=!0),level.commandQueue.indexOf("win")>=0)return runrulesonlevelstart_phase?consolePrint("Win Condition Satisfied (However this is in the run_rules_on_level_start rule pass, so I'm going to ignore it for you.  Why would you want to complete a level before it's already started?!)"):solving||consolePrint("Win Condition Satisfied"),void(e||DoWin());var n=!1;if(state.winconditions.length>0){for(var t=!0,r=0;r<state.winconditions.length;r++){var o=state.winconditions[r],a=o[1],i=o[2],l=!0;switch(o[0]){case-1:for(var s=0;s<level.n_tiles;s++){var c=level.getCellInto(s,_o10);if(!a.bitsClearInArray(c.data)&&!i.bitsClearInArray(c.data)){l=!1;break}}break;case 0:var d=!1;for(s=0;s<level.n_tiles;s++){c=level.getCellInto(s,_o10);if(!a.bitsClearInArray(c.data)&&!i.bitsClearInArray(c.data)){d=!0;break}}!1===d&&(l=!1);break;case 1:for(s=0;s<level.n_tiles;s++){c=level.getCellInto(s,_o10);if(!a.bitsClearInArray(c.data)&&i.bitsClearInArray(c.data)){l=!1;break}}}!1===l&&(t=!1)}n=t}n&&(runrulesonlevelstart_phase?consolePrint("Win Condition Satisfied (However this is in the run_rules_on_level_start rule pass, so I'm going to ignore it for you.  Why would you want to complete a level before it's already started?!)"):solving||consolePrint("Win Condition Satisfied"),e||DoWin())}function DoWin(){winning||(againing=!1,tryPlayEndLevelSound(),unitTesting?nextLevel():(winning=!0,timer=0))}function nextLevel(){if(againing=!1,messagetext="",state&&state.levels&&curlevel>state.levels.length&&(curlevel=state.levels.length-1),ignoreNotJustPressedAction=!0,titleScreen&&titleMode<=1)isContinueOptionSelected()?loadLevelFromStateOrTarget():isNewGameOptionSelected()?(curlevel=0,curlevelTarget=null,void 0===state.metadata.level_select&&clearLocalStorage(),loadLevelFromStateOrTarget()):isLevelSelectOptionSelected()?(titleSelection=0,gotoLevelSelectScreen()):isCreditsOptionSelected()&&gotoCreditsScreen();else if(hasUsedCheckpoint&&(curlevelTarget=null,hasUsedCheckpoint=!1),curlevel<state.levels.length-1){var e=!1,n=state.levels[Number(curlevel)].section,t=state.levels[Number(curlevel)+1].section;t!=n&&(setSectionSolved(state.levels[Number(curlevel)].section),solvedSections.length==state.sections.length&&null!=state.winSection?curlevel=state.winSection.firstLevel-1:"__WIN__"==t&&(gotoLevelSelectScreen(),e=!0)),e||(curlevel++,curlevelTarget=null,textMode=!1,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,loadLevelFromStateOrTarget())}else if(solvedSections.length==state.sections.length){if(void 0===state.metadata.level_select){try{storage_remove(document.URL),storage_remove(document.URL+"_checkpoint")}catch(e){}curlevel=0,curlevelTarget=null,goToTitleScreen()}else gotoLevelSelectScreen();tryPlayEndGameSound()}else null!=state.levels[Number(curlevel)].section&&setSectionSolved(state.levels[Number(curlevel)].section),gotoLevelSelectScreen();updateLocalStorage(),resetFlickDat(),canvasResize()}function loadLevelFromStateOrTarget(){null!==curlevelTarget?loadLevelFromStateTarget(state,curlevel,curlevelTarget):loadLevelFromState(state,curlevel)}function goToTitleScreen(){againing=!1,messagetext="",titleScreen=!0,textMode=!0,hoverSelection=-1,doSetupTitleScreenLevelContinue(),state.metadata=deepClone(state.default_metadata),twiddleMetadataExtras(),null!==canvas&&regenSpriteImages(),generateTitleScreen()}function resetFlickDat(){void 0!==state&&void 0!==state.metadata.flickscreen&&(oldflickscreendat=[0,0,Math.min(state.metadata.flickscreen[0],level.width),Math.min(state.metadata.flickscreen[1],level.height)])}function updateLocalStorage(){try{if(storage_set(document.URL,curlevel),null!==curlevelTarget){restartTarget=level4Serialization();var e=JSON.stringify(restartTarget);storage_set(document.URL+"_checkpoint",e)}else storage_remove(document.URL+"_checkpoint")}catch(e){}}function setSectionSolved(e){if(null!=e&&null!=e&&"__WIN__"!=e.name&&!(solvedSections.indexOf(e)>=0))try{window.localStorage&&(solvedSections.push(e),localStorage.setItem(document.URL+"_sections",JSON.stringify(solvedSections)))}catch(e){}}function clearLocalStorage(){curlevel=0,curlevelTarget=null,solvedSections=[];try{window.localStorage&&(localStorage.removeItem(document.URL),localStorage.removeItem(document.URL+"_checkpoint"),localStorage.removeItem(document.URL+"_sections"))}catch(e){}}var cameraPositionTarget=null,cameraPosition={x:0,y:0};function initSmoothCamera(){if(void 0!==state&&void 0!==state.metadata.smoothscreen){screenwidth=state.metadata.smoothscreen.screenSize.width,screenheight=state.metadata.smoothscreen.screenSize.height;var e=state.metadata.smoothscreen.boundarySize,n=state.metadata.smoothscreen.flick,t=getPlayerPositions();if(t.length>0){var r={x:t[0]/level.height|0,y:t[0]%level.height|0};cameraPositionTarget={x:n?getFlickCameraPosition(r.x,level.width,screenwidth,e.width):getCameraPosition(r.x,level.width,screenwidth),y:n?getFlickCameraPosition(r.y,level.height,screenheight,e.height):getCameraPosition(r.y,level.height,screenheight)},cameraPosition.x=cameraPositionTarget.x,cameraPosition.y=cameraPositionTarget.y}}}function getCameraPosition(e,n,t){return Math.min(Math.max(e,Math.floor(t/2)),n-Math.ceil(t/2))}function getFlickCameraPosition(e,n,t,r){var o=Math.floor(t/2)-Math.floor(r/2),a=e-o,i=Math.floor(a/r),l=Math.floor((n-Math.ceil(t/2)-Math.floor(r/2)-o)/r);return Math.min(Math.max(i,0),l)*r+Math.floor(t/2)}function updateCameraPositionTarget(){var e=state.metadata.smoothscreen,n=getPlayerPositions();if(e&&0!==n.length){var t={x:n[0]/level.height|0,y:n[0]%level.height|0};["x","y"].forEach((function(n){var r="x"===n?screenwidth:screenheight,o="x"===n?"width":"height",a=level[o],i=e.boundarySize[o],l=t[n]-cameraPositionTarget[n],s=Math.sign(l),c=s>0?Math.ceil(i/2):-(Math.floor(i/2)+1);Math.abs(l)-Math.abs(c)>=0&&(cameraPositionTarget[n]=e.flick?getFlickCameraPosition(t[n],a,r,i):getCameraPosition(t[n]-c+s,a,r))}))}}function IsMouseGameInputEnabled(){return"mouse_left"in state.metadata||"mouse_drag"in state.metadata||"mouse_up"in state.metadata}var compiling=!1,errorStrings=[],errorCount=0,twiddleable_params=["background_color","text_color","key_repeat_interval","realtime_interval","again_interval","flickscreen","zoomscreen","smoothscreen","noundo","norestart","message_text_align"];function logErrorCacheable(e,n,t){if(compiling||t){if(void 0===n)return logErrorNoLine(e,t);var r='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!t||(consolePrint(r),errorStrings.push(r),errorCount++)}}function logError(e,n,t){if(compiling||t){if(void 0===n)return logErrorNoLine(e,t);var r='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!t||(consolePrint(r,!0),errorStrings.push(r),errorCount++)}}function logWarning(e,n,t){if(compiling||t){if(void 0===n)return logWarningNoLine(e,t);var r='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="warningText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!t||(consolePrint(r,!0),errorStrings.push(r))}}function logWarningNoLine(e,n){if(compiling||n){var t='<span class="warningText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!n||(consolePrint(t,!0),errorStrings.push(t)),errorCount++}}function logErrorNoLine(e,n){if(compiling||n){var t='<span class="errorText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!n||(consolePrint(t,!0),errorStrings.push(t)),errorCount++}}function logBetaMessage(e,n){if(compiling||n){var t='<span class="betaText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!n||(consoleError(t),errorStrings.push(t))}}function blankLineHandle(e){"levels"===e.section?e.levels[e.levels.length-1].length>0&&e.levels.push([]):"objects"===e.section&&(e.objects_section=0)}"function"!=typeof Object.assign&&(Object.assign=function(e){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),t=1;t<arguments.length;t++){var r=arguments[t];if(null!=r)for(var o in r)r.hasOwnProperty(o)&&(n[o]=r[o])}return n});var debugMode,colorPalette,codeMirrorFn=function(){"use strict";var e=["objects","legend","sounds","collisionlayers","rules","winconditions","levels"],n=["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","sfx11","sfx12","sfx13","cancel","checkpoint","restart","win","message","again","undo","nosave","quit","zoomscreen","flickscreen","smoothscreen","again_interval","realtime_interval","key_repeat_interval","noundo","norestart","background_color","text_color","goto","message_text_align"],t=/[\p{L}\p{N}_]+[\p{Z}\s]*/u,r=/\d+\b/,o=/(objects|collisionlayers|legend|sounds|rules|winconditions|levels)(?![\p{L}\p{N}_])[\p{Z}\s]*/u,a=/[\=]+/,i=/[^\(]+/,l=/[ \,]*/,s=/(move|action|create|destroy|cantmove|undo|restart|titlescreen|startgame|cancel|endgame|startlevel|endlevel|enterlevelselect|showmessage|closemessage|sfx0|sfx1|sfx2|sfx3|sfx4|sfx5|sfx6|sfx7|sfx8|sfx9|sfx10|sfx11|sfx12|sfx13)\b[\p{Z}\s]*/u,c=/^(action|up|down|left|right|\^|v|\<|\>|moving|stationary|parallel|perpendicular|horizontal|orthogonal|vertical|no|randomdir|random)$/,d=/^(startloop|endloop)$/,u=/^(up|down|left|right|horizontal|vertical|orthogonal|late|rigid)$/,h=/[\p{Z}\s]*(up|down|left|right|horizontal|vertical|orthogonal)(?![\p{L}\p{N}_])[\p{Z}\s]*/u,f=/^(all|any|no|some)$/,p=["title","author","homepage","background_color","text_color","key_repeat_interval","realtime_interval","again_interval","flickscreen","zoomscreen","smoothscreen","color_palette","youtube","sprite_size","level_select_unlocked_ahead","level_select_solve_symbol","custom_font","mouse_left","mouse_drag","mouse_right","mouse_rdrag","mouse_up","mouse_rup","local_radius","font_size","tween_length","tween_easing","tween_snap","message_text_align","text_controls","text_message_continue","level_select_unlocked_rollover","sitelock_origin_whitelist","sitelock_hostname_whitelist"],g=["run_rules_on_level_start","norepeat_action","require_player_movement","debug","verbose_logging","throttle_movement","noundo","noaction","norestart","scanline","case_sensitive","level_select","credits","continue_is_level_select","level_select_lock","settings","runtime_metadata_twiddling","runtime_metadata_twiddling_debug","smoothscreen_debug","skip_title_screen","nokeyboard"],m=["checkpoint","objects","collisionlayers","legend","sounds","rules","...","winconditions","levels","|","[","]","up","down","left","right","late","rigid","^","v",">","<","no","randomdir","random","horizontal","vertical","any","all","no","some","moving","stationary","parallel","perpendicular","action","nosave","message","global","zoomscreen","flickscreen","smoothscreen","noundo","norestart","background_color","text_color","goto","message_text_align"];return{copyState:function(e){var n={};for(var t in e.objects)if(e.objects.hasOwnProperty(t)){var r=e.objects[t];n[t]={colors:r.colors.concat([]),lineNumber:r.lineNumber,spritematrix:r.spritematrix.concat([])}}var o=[];for(t=0;t<e.collisionLayers.length;t++)o.push(e.collisionLayers[t].concat([]));var a=[],i=[],l=[],s=[],c=[],d=[];for(t=0;t<e.legend_synonyms.length;t++)a.push(e.legend_synonyms[t].concat([]));for(t=0;t<e.legend_aggregates.length;t++)i.push(e.legend_aggregates[t].concat([]));for(t=0;t<e.legend_properties.length;t++)l.push(e.legend_properties[t].concat([]));for(t=0;t<e.sounds.length;t++)s.push(e.sounds[t].concat([]));for(t=0;t<e.levels.length;t++)c.push(e.levels[t].concat([]));for(t=0;t<e.winconditions.length;t++)d.push(e.winconditions[t].concat([]));var u=Object.assign({},e.original_case_names);return{lineNumber:e.lineNumber,objects:n,collisionLayers:o,commentLevel:e.commentLevel,section:e.section,visitedSections:e.visitedSections.concat([]),objects_candname:e.objects_candname,objects_section:e.objects_section,objects_spritematrix:e.objects_spritematrix.concat([]),tokenIndex:e.tokenIndex,currentSection:e.currentSection,legend_synonyms:a,legend_aggregates:i,legend_properties:l,sounds:s,rules:e.rules.concat([]),names:e.names.concat([]),winconditions:d,original_case_names:u,abbrevNames:e.abbrevNames.concat([]),metadata:e.metadata.concat([]),sprite_size:e.sprite_size,case_sensitive:e.case_sensitive,levels:c,STRIDE_OBJ:e.STRIDE_OBJ,STRIDE_MOV:e.STRIDE_MOV}},blankLine:function(e){"levels"===e.section&&e.levels[e.levels.length-1].length>0&&e.levels.push([])},token:function(v,_){var y=v.string,b=v.sol();function w(e){function n(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}var t;t=_.case_sensitive?new RegExp("\\b"+n(e)+"\\b"):new RegExp("\\b"+n(e)+"\\b","i");var r=y.match(t);null!=r&&(_.original_case_names[e]=r[0])}if(b&&(_.case_sensitive||(v.string=v.string.toLowerCase()),_.tokenIndex=0),v.eatWhile(/[ \t]/),"("===(T=v.peek())&&-4!==_.tokenIndex)v.next(),_.commentLevel++;else if(")"===T&&(v.next(),_.commentLevel>0&&(_.commentLevel--,0===_.commentLevel)))return"comment";if(_.commentLevel>0){for(;v.eatWhile(/[^\(\)]+/),!v.eol()&&("("===(T=v.peek())?_.commentLevel++:")"===T&&_.commentLevel--,v.next(),0!==_.commentLevel););return"comment"}if(v.eatWhile(/[ \t]/),b&&v.eol())return blankLineHandle(_);if(b&&v.match(a,!0))return"EQUALSBIT";if(b&&v.match(o,!0)){_.section=v.string.slice(0,v.pos).trim().toLowerCase(),_.visitedSections.indexOf(_.section)>=0&&logError('cannot duplicate sections (you tried to duplicate "'+_.section+'").',_.lineNumber),_.visitedSections.push(_.section);var S=e.indexOf(_.section);if(0==S?(_.objects_section=0,_.visitedSections.length>1&&logError('section "'+_.section+'" must be the first section',_.lineNumber)):-1==_.visitedSections.indexOf(e[S-1])&&logError(-1===S?'no such section as "'+_.section+'".':'section "'+_.section+'" is out of order, must follow  "'+e[S-1]+'".',_.lineNumber),"sounds"===_.section){for(var k in _.objects)_.objects.hasOwnProperty(k)&&_.names.push(k);for(var x=0;x<_.legend_synonyms.length;x++){k=_.legend_synonyms[x][0];_.names.push(k)}for(x=0;x<_.legend_aggregates.length;x++){k=_.legend_aggregates[x][0];_.names.push(k)}for(x=0;x<_.legend_properties.length;x++){k=_.legend_properties[x][0];_.names.push(k)}}else if("levels"===_.section){for(var k in _.objects)_.objects.hasOwnProperty(k)&&1==k.length&&_.abbrevNames.push(k);for(x=0;x<_.legend_synonyms.length;x++)1==_.legend_synonyms[x][0].length&&_.abbrevNames.push(_.legend_synonyms[x][0]);for(x=0;x<_.legend_aggregates.length;x++)1==_.legend_aggregates[x][0].length&&_.abbrevNames.push(_.legend_aggregates[x][0])}return"HEADER"}if(void 0===_.section&&logError('must start with section "OBJECTS"',_.lineNumber),v.eol())return null;switch(_.section){case"objects":var M=function(){var e=b?v.match(t,!0):v.match(/[^\p{Z}\s\()]+[\p{Z}\s]*/u,!0);if(null==e)return v.match(i,!0),v.pos>0&&logWarning('Unknown junk in object section (possibly: the main names for objects have to be words containing only the letters a-z0.9 - if you want to call them something like ",", do it in the legend section).',_.lineNumber),"ERROR";var n=e[0].trim();if(void 0!==_.objects[n])return logError('Object "'+n+'" defined multiple times.',_.lineNumber),"ERROR";for(var r=0;r<_.legend_synonyms.length;r++){_.legend_synonyms[r][0]==n&&logError('Name "'+n+'" already in use.',_.lineNumber)}if(m.indexOf(n)>=0&&logWarning('You named an object "'+n+"\", but this is a keyword. Don't do that!",_.lineNumber),b)_.objects_candname=n,w(n),_.objects[_.objects_candname]={lineNumber:_.lineNumber,colors:[],spritematrix:[],cloneSprite:""};else{if("copy:"==n.substring(0,5)&&n.length>5){var o=n.substring(5);return""!=_.objects[_.objects_candname].cloneSprite?(logError("You already assigned a sprite parent for "+o+", you can't have more than one!",_.lineNumber),"ERROR"):o==_.objects_candname?(logError("You attempted to set the sprite parent for "+o+" to "+o+"! Please don't, and keep the recursion in check.",_.lineNumber),"ERROR"):(_.objects[_.objects_candname].cloneSprite=o,"SPRITEPARENT")}var a;w(n),(a=[n,_.objects_candname]).lineNumber=_.lineNumber,_.legend_synonyms.push(a)}return _.case_sensitive&&("player"==n.toLowerCase()&&"player"!=n||"background"==n.toLowerCase()&&"background"!=n)&&((a=[n.toLowerCase(),_.objects_candname]).lineNumber=_.lineNumber,_.legend_synonyms.push(a)),_.objects_section=1,"NAME"};switch(b&&2==_.objects_section&&(_.objects_section=3),b&&1==_.objects_section&&(_.objects_section=2),_.objects_section){case 0:case 1:return _.objects_spritematrix=[],M();case 2:v.string=v.string.toLowerCase(),_.tokenIndex=0;var C=v.match(reg_color,!0);if(null==C){var I=v.match(t,!0)||v.match(i,!0);return logError("Was looking for color for object "+_.objects_candname+', got "'+I+'" instead.',_.lineNumber),null}void 0===_.objects[_.objects_candname].colors?_.objects[_.objects_candname].colors=[C[0].trim()]:_.objects[_.objects_candname].colors.push(C[0].trim());var E=C[0].trim().toLowerCase();return E in colorPalettes.arnecolors?"COLOR COLOR-"+E.toUpperCase():"transparent"===E?"COLOR FADECOLOR":"MULTICOLOR"+C[0];case 3:var T=v.eat(/[.\d]/),A=_.objects_spritematrix;if(void 0===T)return 0===A.length?M():(logError("Unknown junk in spritematrix for object "+_.objects_candname+".",_.lineNumber),v.match(i,!0),null);b&&A.push("");var R=_.objects[_.objects_candname];return A[A.length-1]+=T,A[A.length-1].length>_.sprite_size?(logError("Sprites must be "+_.sprite_size+" wide and "+_.sprite_size+" high.",_.lineNumber),v.match(i,!0),null):(R.spritematrix=_.objects_spritematrix,A.length===_.sprite_size&&A[A.length-1].length==_.sprite_size&&(_.objects_section=0),"."!==T?(k=parseInt(T))>=R.colors.length?(logError("Trying to access color number "+k+" from the color palette of sprite "+_.objects_candname+", but there are only "+R.colors.length+" defined in it.",_.lineNumber),"ERROR"):isNaN(k)?(logError('Invalid character "'+T+'" in sprite for '+_.objects_candname,_.lineNumber),"ERROR"):"COLOR BOLDCOLOR COLOR-"+R.colors[k].toUpperCase():"COLOR FADECOLOR");default:window.console.logError("EEK shouldn't get here.")}break;case"sounds":if(b){var F=!0;(z=i.exec(v.string)[0].split(/[\p{Z}\s]/u).filter((function(e){return""!==e}))).push(_.lineNumber),_.sounds.push(z)}if(null!==(P=v.match(s,!0)))return"SOUNDVERB";if(null!==(P=v.match(h,!0)))return"DIRECTION";if(null!==(P=v.match(r,!0)))return _.tokenIndex++,"SOUND";if(null!==(P=v.match(/[^\[\|\]\p{Z}\s]*/u,!0))){var O=P[0].trim();if(_.names.indexOf(O)>=0)return"NAME"}else P=v.match(i,!0);return logError('unexpected sound token "'+P+'".',_.lineNumber),v.match(i,!0),"ERROR";case"collisionlayers":if(b&&(_.collisionLayers.push([]),_.tokenIndex=0),null===(W=v.match(t,!0))){var D=v.pos;return v.match(l,!0),v.pos==D&&(logError("error detected - unexpected character "+v.peek(),_.lineNumber),v.next()),null}var P=W[0].trim(),L=function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return[e];for(var n=0;n<_.legend_synonyms.length;n++){if((t=_.legend_synonyms[n])[0]===e)return L(t[1])}for(n=0;n<_.legend_aggregates.length;n++){if((t=_.legend_aggregates[n])[0]===e)return logError('"'+e+'" is an aggregate (defined using "and"), and cannot be added to a single layer because its constituent objects must be able to coexist.',_.lineNumber),[]}for(n=0;n<_.legend_properties.length;n++){var t;if((t=_.legend_properties[n])[0]===e)return[].concat.apply([],t.slice(1).map(L))}return logError('Cannot add "'+P+'" to a collision layer; it has not been declared.',_.lineNumber),[]};"background"===P.toLowerCase()?(_.collisionLayers.length>0&&_.collisionLayers[_.collisionLayers.length-1].length>0&&logError("Background must be in a layer by itself.",_.lineNumber),_.tokenIndex=1):0!==_.tokenIndex&&logError("Background must be in a layer by itself.",_.lineNumber);var N=L(P);if(0===_.collisionLayers.length)return logError("no layers found.",_.lineNumber),"ERROR";var B=[];for(x=0;x<N.length;x++){P=N[x];for(var j=0;j<=_.collisionLayers.length-1;j++){_.collisionLayers[j].indexOf(P)>=0&&j!=_.collisionLayers.length-1&&B.push(j)}}if(B.length>0){var q='Object "'+P+'" included in multiple collision layers ( layers ';for(x=0;x<B.length;x++)q+="#"+(B[x]+1)+", ";logWarning((q+="#"+_.collisionLayers.length)+" ). You should fix this!",_.lineNumber)}return _.collisionLayers[_.collisionLayers.length-1]=_.collisionLayers[_.collisionLayers.length-1].concat(N),N.length>0?"NAME":"ERROR";case"legend":if(b){var V=v.string.replace("="," = "),z=(V=i.exec(V)[0]).split(/[\p{Z}\s]/u).filter((function(e){return""!==e}));F=!0;if(z.length>0){P=z[0];_.case_sensitive||(P=P.toLowerCase()),m.indexOf(P)>=0&&logWarning('You named an object "'+P+"\", but this is a keyword. Don't do that!",_.lineNumber),z.indexOf(P,2)>=2&&logError("You can't define object "+P.toUpperCase()+" in terms of itself!",_.lineNumber),function(e,n){if(void 0!==e.objects[n])return logError('Object "'+n+'" defined multiple times.',e.lineNumber),"ERROR";for(var t=0;t<e.legend_synonyms.length;t++)e.legend_synonyms[t][0]==n&&logError('Name "'+n+'" already in use.',e.lineNumber);for(t=0;t<e.legend_aggregates.length;t++)e.legend_aggregates[t][0]==n&&logError('Name "'+n+'" already in use.',e.lineNumber);for(t=0;t<e.legend_properties.length;t++)e.legend_properties[t][0]==n&&logError('Name "'+n+'" already in use.',e.lineNumber)}(_,P)}if(F)if(z.length<3)F=!1;else if("="!==z[1])F=!1;else if(3===z.length){var G=[z[0],z[2]];_.case_sensitive||(G[1]=G[1].toLowerCase()),G.lineNumber=_.lineNumber,w(z[0]),_.legend_synonyms.push(G)}else if(z.length%2==0)F=!1;else{var U=z[3].toLowerCase();if("and"===U){for(L=function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return[e];for(var n=0;n<_.legend_synonyms.length;n++){if((t=_.legend_synonyms[n])[0]===e)return L(t[1])}for(n=0;n<_.legend_aggregates.length;n++){if((t=_.legend_aggregates[n])[0]===e)return[].concat.apply([],t.slice(1).map(L))}for(n=0;n<_.legend_properties.length;n++){var t;if((t=_.legend_properties[n])[0]===e)return logError("Cannot define an aggregate (using 'and') in terms of properties (something that uses 'or').",_.lineNumber),F=!1,[e]}return[e]},x=5;x<z.length;x+=2)if("and"!==z[x].toLowerCase()){F=!1;break}if(F){var H=[z[0]].concat(L(z[2])).concat(L(z[4]));for(x=6;x<z.length;x+=2)H=H.concat(L(z[x]));H.lineNumber=_.lineNumber,w(H[0]),_.legend_aggregates.push(H)}}else if("or"===U){for(L=function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return[e];for(var n=0;n<_.legend_synonyms.length;n++){if((t=_.legend_synonyms[n])[0]===e)return L(t[1])}for(n=0;n<_.legend_aggregates.length;n++){(t=_.legend_aggregates[n])[0]===e&&(logError("Cannot define a property (using 'or') in terms of aggregates (something that uses 'and').",_.lineNumber),F=!1)}for(n=0;n<_.legend_properties.length;n++){var t;if((t=_.legend_properties[n])[0]===e)return[].concat.apply([],t.slice(1).map(L))}return[e]},x=5;x<z.length;x+=2)if("or"!==z[x].toLowerCase()){F=!1;break}if(F){for(H=[z[0]].concat(L(z[2])).concat(L(z[4])),x=6;x<z.length;x+=2)_.case_sensitive?H.push(z[x]):H.push(z[x].toLowerCase());H.lineNumber=_.lineNumber,w(H[0]),_.legend_properties.push(H)}}else F=!1}else;if(!1===F)return logError("incorrect format of legend - should be one of A = B, A = B or C ( or D ...), A = B and C (and D ...)",_.lineNumber),v.match(i,!0),"ERROR";_.tokenIndex=0}if(0===_.tokenIndex)return v.match(/[^=]*/,!0),_.tokenIndex++,"NAME";if(1===_.tokenIndex)return v.next(),v.match(/[\p{Z}\s]*/u,!0),_.tokenIndex++,"ASSSIGNMENT";var W;if(null===(W=v.match(t,!0)))return logError("Something bad's happening in the LEGEND",_.lineNumber),v.match(i,!0),"ERROR";P=W[0].trim();if(_.tokenIndex%2==0){return!1===function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return!0;for(var n=0;n<_.legend_aggregates.length;n++){if(_.legend_aggregates[n][0]===e)return!0}for(n=0;n<_.legend_properties.length;n++){if(_.legend_properties[n][0]===e)return!0}for(n=0;n<_.legend_synonyms.length;n++){if(_.legend_synonyms[n][0]===e)return!0}return!1}(P)?(logError('Cannot reference "'+P+'" in the LEGEND section; it has not been defined yet.',_.lineNumber),_.tokenIndex++,"ERROR"):(_.tokenIndex++,"NAME")}return _.tokenIndex++,"LOGICWORD";case"rules":if(b){var X=i.exec(v.string)[0];_.rules.push([X,_.lineNumber,y]),_.tokenIndex=0}if(-4===_.tokenIndex)return v.skipToEnd(),"MESSAGE";if(v.match(/[\p{Z}\s]*->[\p{Z}\s]*/u,!0))return"ARROW";if("["===T||"|"===T||"]"===T||"+"===T)return"+"!==T&&(_.tokenIndex=1),v.next(),v.match(/[\p{Z}\s]*/u,!0),"BRACKET";O=v.match(/[^\[\|\]\p{Z}\s]*/u,!0)[0].trim();return 0===_.tokenIndex&&d.exec(O)?"BRACKET":0===_.tokenIndex&&u.exec(O)||1===_.tokenIndex&&c.exec(O)?(v.match(/[\p{Z}\s]*/u,!0),"DIRECTION"):_.names.indexOf(O)>=0?b?(logError("Identifiers cannot appear outside of square brackets in rules, only directions can.",_.lineNumber),"ERROR"):(v.match(/[\p{Z}\s]*/u,!0),"NAME"):"..."===(O=O.toLowerCase())||"rigid"===O||"random"===O||"global"===O?"DIRECTION":n.indexOf(O)>=0?(("message"===O||"goto"===O||twiddleable_params.includes(O))&&(_.tokenIndex=-4),"COMMAND"):(logError('Name "'+O+'", referred to in a rule, does not exist.',_.lineNumber),"ERROR");case"winconditions":if(b){var Y=i.exec(v.string)[0].split(/[\p{Z}\s]/u).filter((function(e){return""!==e}));Y.push(_.lineNumber),_.winconditions.push(Y),_.tokenIndex=-1}if(_.tokenIndex++,null===($=v.match(/[\p{Z}\s]*[\p{L}\p{N}_]+[\p{Z}\s]*/u)))return logError("incorrect format of win condition.",_.lineNumber),v.match(i,!0),"ERROR";var Q=$[0].trim();if(0===_.tokenIndex)return f.exec(Q)?"LOGICWORD":"ERROR";if(2===_.tokenIndex)return"on"!=Q?(logError('Expecting the word "ON" but got "'+Q.toUpperCase()+"'.",_.lineNumber),"ERROR"):"LOGICWORD";if(1===_.tokenIndex||3===_.tokenIndex)return-1===_.names.indexOf(Q)?(logError('Error in win condition: "'+Q+'" is not a valid object name.',_.lineNumber),"ERROR"):"NAME";break;case"levels":if(b){if(v.match(/[\p{Z}\s]*message\b[\p{Z}\s]*/u,!0)){_.tokenIndex=1;var J=["message",y.slice(v.pos).trim(),_.lineNumber,_.currentSection];return 0==_.levels[_.levels.length-1].length?_.levels.splice(_.levels.length-1,0,J):_.levels.push(J),"MESSAGE_VERB"}if(v.match(/[\p{Z}\s]*message[\p{Z}\s]*/u,!0)){logWarning("You probably meant to put a space after 'message' innit.  That's ok, I'll still interpret it as a message, but you probably want to put a space there.",_.lineNumber),_.tokenIndex=1;J=["message",y.slice(v.pos).trim(),_.lineNumber,_.currentSection];return 0==_.levels[_.levels.length-1].length?_.levels.splice(_.levels.length-1,0,J):_.levels.push(J),"MESSAGE_VERB"}if(v.match(/\s*section\s*/i,!0))return _.tokenIndex=3,_.currentSection=y.slice(v.pos).trim(),"SECTION_VERB";if(v.match(/\s*goto\s*/i,!0)){_.tokenIndex=4;J=["goto",y.slice(v.pos).trim(),_.lineNumber,_.currentSection];return 0==_.levels[_.levels.length-1].length?_.levels.splice(_.levels.length-1,0,J):_.levels.push(J),"GOTO_VERB"}var K=v.match(i,!1)[0].trim();_.tokenIndex=2;var Z=_.levels[_.levels.length-1];"\n"==Z[0]?_.levels.push([_.lineNumber,_.currentSection,K]):(0==Z.length&&(Z.push(_.lineNumber),Z.push(_.currentSection)),Z.push(K),Z.length>2&&K.length!=Z[2].length&&logWarning("Maps must be rectangular, yo (In a level, the length of each row must be the same).",_.lineNumber))}else{if(1==_.tokenIndex)return v.skipToEnd(),"MESSAGE";if(3==_.tokenIndex)return v.skipToEnd(),"SECTION";if(4==_.tokenIndex)return v.skipToEnd(),"GOTO"}if(2===_.tokenIndex&&!v.eol()){T=v.peek();return v.next(),_.abbrevNames.indexOf(T)>=0?"LEVEL":(logError('Key "'+T+'" not found. Do you need to add it to the legend, or define a new object?',_.lineNumber),"ERROR")}break;default:if(b&&(_.tokenIndex=0),0!=_.tokenIndex)return v.match(i,!0),"METADATATEXT";var $;if(null!==($=v.match(/[\p{Z}\s]*[\p{L}\p{N}_]+[\p{Z}\s]*/u))){var ee=$[0].trim();if(b){if(p.indexOf(ee)>=0){"youtube"!==ee&&"author"!==ee&&"homepage"!==ee&&"title"!==ee&&"custom_font"!==ee&&"text_controls"!==ee&&"text_message_continue"!==ee||(v.string=y);var ne=v.match(i,!1);return null!=ne?"sprite_size"==ee?_.sprite_size=parseInt(ne[0].trim(),10):(_.metadata.push(ee),_.metadata.push(ne[0].trim())):logError('MetaData "'+ee+'" needs a value.',_.lineNumber),_.tokenIndex=1,"METADATA"}return g.indexOf(ee)>=0?("case_sensitive"==ee&&(_.case_sensitive=!0),_.metadata.push(ee),_.metadata.push("true"),_.tokenIndex=-1,"METADATA"):(logError("Unrecognised stuff in the prelude.",_.lineNumber),"ERROR")}return-1==_.tokenIndex?(logError('MetaData "'+ee+'" has no parameters.',_.lineNumber),"ERROR"):"METADATA"}}return v.eol()?null:v.eol()?void 0:(v.next(),null)},startState:function(){return{objects:{},lineNumber:0,commentLevel:0,section:"",visitedSections:[],objects_candname:"",objects_section:0,objects_spritematrix:[],collisionLayers:[],tokenIndex:0,currentSection:null,legend_synonyms:[],legend_aggregates:[],legend_properties:[],sounds:[],rules:[],names:[],winconditions:[],metadata:[],sprite_size:5,case_sensitive:!1,original_case_names:{},abbrevNames:[],levels:[[]],subsection:""}}}};window.CodeMirror.defineMode("puzzle",codeMirrorFn);"use strict";function isColor(e){return(e=e.trim())in colorPalettes.arnecolors||(!!/^#([0-9A-F]{2}){3,4}$/i.test(e)||(!!/^#([0-9A-F]{3})$/i.test(e)||"transparent"===e))}function colorToHex(e,n){return(n=n.trim())in e?e[n]:n}function generateSpriteMatrix(e){for(var n=[],t=0;t<e.length;t++){for(var r=[],o=0;o<e.length;o++){var a=e[t].charAt(o);"."==a?r.push(-1):r.push(a)}n.push(r)}return n}function generateExtraMembers(e){0===e.collisionLayers.length&&logError("No collision layers defined.  All objects need to be in collision layers."),e.idDict=[];for(var n=0,t=0;t<e.collisionLayers.length;t++)for(var r=0;r<e.collisionLayers[t].length;r++){if((c=e.collisionLayers[t][r])in e.objects)(f=e.objects[c]).layer=t,f.id=n,e.idDict[n]=c,n++}e.objectCount=n;for(var o=e.collisionLayers.length,a=[],i=0;i<o;i++)a.push(-1);STRIDE_OBJ=0|Math.ceil(e.objectCount/32),STRIDE_MOV=0|Math.ceil(o/5),e.STRIDE_OBJ=STRIDE_OBJ,e.STRIDE_MOV=STRIDE_MOV,debugMode=!1,verbose_logging=!1,throttle_movement=!1,colorPalette=colorPalettes.arnecolors;for(i=0;i<e.metadata.length;i+=2){var l=e.metadata[i],s=e.metadata[i+1];"color_palette"===l?(s in colorPalettesAliases&&(s=colorPalettesAliases[s]),void 0===colorPalettes[s]?logError('Palette "'+s+'" not found, defaulting to arnecolors.',0):colorPalette=colorPalettes[s]):"debug"===l?IDE&&!1===unitTesting&&(debugMode=!0,cache_console_messages=!0):"verbose_logging"===l?IDE&&!1===unitTesting&&(verbose_logging=!0,cache_console_messages=!0):"throttle_movement"===l&&(throttle_movement=!0)}for(var c in e.objects)if(e.objects.hasOwnProperty(c)){(f=e.objects[c]).colors.length>10&&logError("a sprite cannot have more than 10 colors.  Why you would want more than 10 is beyond me.",f.lineNumber+1);for(i=0;i<f.colors.length;i++){var d=f.colors[i];isColor(d)?(d=colorToHex(colorPalette,d),f.colors[i]=d):(logError('Invalid color specified for object "'+c+'", namely "'+f.colors[i]+'".',f.lineNumber+1),f.colors[i]="#ff00ff")}}for(var c in e.objects){if(e.objects.hasOwnProperty(c))if(0==(f=e.objects[c]).colors.length&&(logError('color not specified for object "'+c+'".',f.lineNumber),f.colors=["#ff00ff"]),""!==f.cloneSprite)e.objects.hasOwnProperty(f.cloneSprite)?""===e.objects[f.cloneSprite].cloneSprite?f.spritematrix=deepClone(e.objects[f.cloneSprite].spritematrix):logError("The sprite that "+c+" attempted to clone ("+f.cloneSprite+") clones a sprite itself ("+e.objects[f.cloneSprite].cloneSprite+"), so it can't clone the sprite! You'll need to set up the cloning differently.",f.lineNumber):logError(c+" attempted to clone the sprite matrix of "+f.cloneSprite+", but that object doesn't exist?!",f.lineNumber);else if(0===f.spritematrix.length){f.spritematrix=new Array(e.sprite_size);var u=new Array(e.sprite_size);for(i=0;i<e.sprite_size;i++)u[i]=0;for(i=0;i<e.sprite_size;i++)f.spritematrix[i]=u}else{if(f.spritematrix.length!==e.sprite_size)logWarning("Sprite graphics must be "+e.sprite_size+" wide and "+e.sprite_size+" high exactly.",f.lineNumber);else for(i=0;i<e.sprite_size;i++)if(f.spritematrix[i].length!==e.sprite_size){logWarning("Sprite graphics must be "+e.sprite_size+" wide and "+e.sprite_size+" high exactly.",f.lineNumber);break}f.spritematrix=generateSpriteMatrix(f.spritematrix)}}var h={};for(var c in e.objects)if(e.objects.hasOwnProperty(c)){var f=e.objects[c];(_=a.concat([]))[f.layer]=f.id,h[c]=_}for(var p=!0;p;){p=!1;for(i=0;i<e.legend_synonyms.length;i++){l=(g=e.legend_synonyms[i])[0],s=g[1];l in h&&void 0!==h[l]||void 0===h[s]||(p=!0,h[l]=h[s])}for(i=0;i<e.legend_aggregates.length;i++){l=(g=e.legend_aggregates[i])[0];var g,m=g.slice(1),v=!0;for(r=0;r<m.length;r++){if(void 0===h[m[r]]){v=!1;break}}if((!(l in h)||void 0===h[l])&&v){var _=a.concat([]);for(r=1;r<g.length;r++){c=g[r];if(null==(f=e.objects[c])&&logError("Object not found with name "+c,e.lineNumber),-1==_[f.layer])_[f.layer]=f.id;else if(void 0===f.layer)logError('Object "'+c.toUpperCase()+'" has been defined, but not assigned to a layer.',g.lineNumber);else{var y=c.toUpperCase(),b=e.idDict[_[f.layer]].toUpperCase();y!==b&&logError('Trying to create an aggregate object (defined in the legend) with both "'+y+'" and "'+b+"\", which are on the same layer and therefore can't coexist.",g.lineNumber)}}p=!0,h[g[0]]=_}}}e.glyphDict=h;var w={};for(i=0;i<e.legend_aggregates.length;i++){w[(x=e.legend_aggregates[i])[0]]=x.slice(1)}e.aggregatesDict=w;var S={};for(i=0;i<e.legend_properties.length;i++){S[(x=e.legend_properties[i])[0]]=x.slice(1)}e.propertiesDict=S;var k={};for(i=0;i<e.legend_synonyms.length;i++){var x;l=(x=e.legend_synonyms[i])[0];(R=x[1])in w?w[l]=w[R]:R in S?S[l]=S[R]:l!==R&&(k[l]=R)}e.synonymsDict=k;for(var M,C,I=!0;I;){for(var c in I=!1,k){if(k.hasOwnProperty(c))(R=k[c])in S?(delete k[c],S[c]=S[R],I=!0):R in w?(delete w[c],w[c]=w[R],I=!0):R in k&&(k[c]=k[R])}for(var c in S)if(S.hasOwnProperty(c)){var E=S[c];for(i=0;i<E.length;i++){if((R=E[i])in k)E[i]=k[R],I=!0;else if(R in S){E.splice(i,1);var T=S[R];for(r=0;r<T.length;r++){var A=T[r];-1===E.indexOf(A)&&E.push(A)}I=!0}R in w&&logError('Trying to define property "'+c.toUpperCase()+'" in terms of aggregate "'+R.toUpperCase()+'".')}}for(var c in w)if(w.hasOwnProperty(c))for(E=w[c],i=0;i<E.length;i++){var R;if((R=E[i])in k)E[i]=k[R],I=!0;else if(R in w){E.splice(i,1);for(T=w[R],r=0;r<T.length;r++){A=T[r];-1===E.indexOf(A)&&E.push(A)}I=!0}R in S&&logError('Trying to define aggregate "'+c.toUpperCase()+'" in terms of property "'+R.toUpperCase()+'".')}}for(var l in e.propertiesSingleLayer={},S)if(S.hasOwnProperty(l)){E=S[l];var F=!0;for(i=1;i<E.length;i++)if(e.objects[E[i-1]].layer!==e.objects[E[i]].layer){F=!1;break}F&&(e.propertiesSingleLayer[l]=e.objects[E[0]].layer)}if(void 0===e.idDict[0]&&e.collisionLayers.length>0&&logError("You need to have some objects defined"),void 0===e.objects.background)if("background"in e.synonymsDict){c=e.synonymsDict.background;M=(f=e.objects[c]).id,C=f.layer}else if("background"in e.propertiesDict){c=e.propertiesDict.background[0];M=(f=e.objects[c]).id,C=f.layer}else if("background"in e.aggregatesDict){M=(f=e.objects[e.idDict[0]]).id,C=f.layer,logError("background cannot be an aggregate (declared with 'and'), it has to be a simple type, or property (declared in terms of others using 'or').")}else{null!=(f=e.objects[e.idDict[0]])&&(M=f.id,C=f.layer),logError("you have to define something to be the background")}else M=e.objects.background.id,C=e.objects.background.layer;e.backgroundid=M,e.backgroundlayer=C}function generateExtraMembersPart2(e){function n(n,t){if(n in e.metadata){var r=e.metadata[n]||t,o=null;if(e.objects[r])o=e.objects[r].id;else if(r in e.synonymsDict){var a=e.synonymsDict[r];o=e.objects[a].id}else{o=e.objects[e.idDict[1]].id,logError(r+" object/alias has to be defined")}return o}}if(e.lmbID=n("mouse_left","lmb"),e.rmbID=n("mouse_right","rmb"),e.dragID=n("mouse_drag","drag"),e.rdragID=n("mouse_rdrag","rdrag"),e.lmbupID=n("mouse_up","lmbup"),e.rmbupID=n("mouse_rup","rmbup"),"mouse_obstacle"in e.metadata){var t=e.metadata.mouse_obstacle;t&&(e.obstacleMask=e.objectMasks[t],e.obstacleMask||(logError(t+" object/alias has to be defined."),e.obstacleMask=e.objectMasks.background))}}function levelFromString(e,n){var t=e.backgroundlayer,r=(e.backgroundid,e.layerMasks[t]),o=new Level(n[0],n[2].length,n.length-2,e.collisionLayers.length,null,n[1]);o.objects=new Int32Array(o.width*o.height*STRIDE_OBJ);for(var a=0;a<o.width;a++)for(var i=0;i<o.height;i++){var l=n[i+2].charAt(a);0==l.length&&(l=n[i+2].charAt(n[i+2].length-1));var s=e.glyphDict[l];null==s&&(void 0===e.propertiesDict[l]?logError('Error, symbol "'+l+'", used in map, not found.',n[0]+i):logError('Error, symbol "'+l+"\" is defined using 'or', and therefore ambiguous - it cannot be used in a map. Did you mean to define it in terms of 'and'?",n[0]+i));var c=new BitVec(STRIDE_OBJ);s=s.concat([]);for(var d=0;d<o.layerCount;d++)s[d]>=0&&c.ibitset(s[d]);for(var u=0;u<STRIDE_OBJ;++u)o.objects[STRIDE_OBJ*(a*o.height+i)+u]=c.data[u]}var h=o.calcBackgroundMask(e);for(a=0;a<o.n_tiles;a++){var f=o.getCell(a);r.anyBitsInCommon(f)||(f.ior(h),o.setCell(a,f))}return o}function levelsToArray(e){for(var n=e.levels,t=[],r=!1,o=null,a=0;a<n.length;a++){var i,l=n[a];if(0!=l.length)"message"==l[0]?(i={message:l[1],section:l[3]},(splitMessage=wordwrap(i.message,intro_template[0].length)).length>12&&logWarning("Message too long to fit on screen.",l[2]),i.section!=o&&(r=!1,o=i.section),r&&logWarning("Message unreachable due to previous GOTO.",l[2])):"goto"==l[0]?((i={target:l[1],lineNumber:l[2],section:l[3]}).section!=o&&(r=!1,o=i.section),r&&logWarning("GOTO unreachable due to previous GOTO.",i.lineNumber),r=!0):((i=levelFromString(e,l)).section!=o&&(r=!1,o=i.section),r&&logWarning("Level unreachable due to previous GOTO.",i.lineNumber)),t.push(i)}e.levels=t}function extractSections(e){for(var n=[],t=null,r=0;r<e.levels.length;r++){var o=e.levels[r];if(o.section!=t){var a={name:o.section,firstLevel:r};"__WIN__"==a.name?e.winSection=a:n.push(a),t=o.section}}e.sections=n}function convertSectionNamesToIndices(e){for(var n={},t={},r=0;r<e.sections.length;r++){void 0===n[s=e.sections[r].name.toLowerCase()]?n[s]=r:t[s]=!0}for(var o=0;o<e.rules.length;o++)for(var a=e.rules[o],i=0;i<a.commands.length;i++){var l=a.commands[i];if("goto"==l[0]){var s,c=n[s=l[1].toLowerCase()];void 0===c?(logError('Invalid GOTO command - There is no section named "'+l[1]+'". Either it does not exist, or it has zero levels.',a.lineNumber),c=-1):void 0!==t[s]&&(logError('Invalid GOTO command - There are multiple sections named "'+l[1]+'". Section names must be unique for GOTO to work.',a.lineNumber),c=-1),l[1]=c}}for(var d=0;d<e.levels.length;d++){var u=e.levels[d];if(void 0!==u.target){var h=u.target.toLowerCase(),f=n[h];void 0===f?(logError('Invalid GOTO command - There is no section named "'+l[1]+'".',u.lineNumber),f=0):void 0!==t[h]&&(logError('Invalid GOTO command - There are multiple sections named "'+l[1]+'".',u.lineNumber),f=0),u.target=f}}}Level.prototype.calcBackgroundMask=function(e){void 0===e.backgroundlayer&&logError("you have to have a background layer");for(var n=e.layerMasks[e.backgroundlayer],t=0;t<this.n_tiles;t++){var r=this.getCell(t);if(r.iand(n),!r.iszero())return r}return(r=new BitVec(STRIDE_OBJ)).ibitset(e.backgroundid),r};var directionaggregates={horizontal:["left","right"],horizontal_par:["left","right"],horizontal_perp:["left","right"],vertical:["up","down"],vertical_par:["up","down"],vertical_perp:["up","down"],moving:["up","down","left","right","action"],orthogonal:["up","down","left","right"],perpendicular:["^","v"],parallel:["<",">"]},relativeDirections=["^","v","<",">","perpendicular","parallel"],simpleAbsoluteDirections=["up","down","left","right"],simpleRelativeDirections=["^","v","<",">"],reg_directions_only=/^(\>|\<|\^|v|up|down|left|right|moving|stationary|no|randomdir|random|horizontal|vertical|orthogonal|perpendicular|parallel|action)$/i,commandwords=["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","sfx11","sfx12","sfx13","cancel","checkpoint","restart","win","message","again","undo","nosave","quit","zoomscreen","flickscreen","smoothscreen","again_interval","realtime_interval","key_repeat_interval","noundo","norestart","background_color","text_color","goto","message_text_align"];function directionalRule(e){for(var n=0;n<e.lhs.length;n++){if((a=e.lhs[n]).length>1)return!0;for(var t=0;t<a.length;t++)for(var r=a[t],o=0;o<r.length;o+=2)if(relativeDirections.indexOf(r[o])>=0)return!0}for(n=0;n<e.rhs.length;n++){var a;if((a=e.rhs[n]).length>1)return!0;for(t=0;t<a.length;t++)for(r=a[t],o=0;o<r.length;o+=2)if(relativeDirections.indexOf(r[o])>=0)return!0}return!1}function findIndexAfterToken(e,n,t){e=e.toLowerCase();for(var r=0,o=0;o<=t;o++){var a=n[o];r=e.indexOf(a,r)+a.length}return r}function rightBracketToRightOf(e,n){for(;n<e.length;n++)if("]"===e[n])return!0;return!1}function processRuleString(e,n,t){var r=e[0],o=e[1],a=e[2];"+"===(r=(r=r.replace(/\[/g," [ ").replace(/\]/g," ] ").replace(/\|/g," | ").replace(/\-\>/g," -> ")).trim())[0]&&(r=r.substring(0,1)+" "+r.substring(1,r.length));var i=r.split(/\s/).filter((function(e){return""!==e}));0==i.length&&logError("Spooky error!  Empty line passed to rule function.",o);var l=0,s=[],c=null,d=[],u=!1,h=!1,f=[],p=[],g=!1,m=!1,v=o,_=[],y=!1,b=!1,w=!1;if(1===i.length){if("startloop"===i[0])return I={bracket:1};if("endloop"===i[0])return I={bracket:-1}}-1==i.indexOf("->")&&logError("A rule has to have an arrow in it.  There's no arrow here! Consider reading up about rules - you're clearly doing something weird",o);c=[];for(var S=0,k=0;k<i.length;k++){var x=i[k];switch(l){case 0:"+"===x?(b=!0,v===o?(0==t.length&&logError('The "+" symbol, for joining a rule with the group of the previous rule, needs a previous rule to be applied to.'),0!==k&&logError('The "+" symbol, for joining a rule with the group of the previous rule, must be the first symbol on the line '),v=t[t.length-1].groupNumber):logError('Two "+"s ("append to previous rule group" symbol) applied to the same rule.',o)):x in directionaggregates?s=s.concat(directionaggregates[x]):"late"===x?g=!0:"rigid"===x?m=!0:"random"===x?(y=!0,b&&logError("A rule-group can only be marked random by the opening rule in the group (aka, a '+' and 'random' can't appear as rule modifiers on the same line).  Why? Well, you see \"random\" isn't a property of individual rules, but of whole rule groups.  It indicates that a single possible application of some rule from the whole group should be applied at random.",o)):"global"===x?w=!0:simpleAbsoluteDirections.indexOf(x)>=0?s.push(x):simpleRelativeDirections.indexOf(x)>=0?logError('You cannot use relative directions ("^v<>") to indicate in which direction(s) a rule applies.  Use absolute directions indicators (Up, Down, Left, Right, Horizontal, or Vertical, for instance), or, if you want the rule to apply in all four directions, do not specify directions',o):"["==x?(0==s.length&&(s=s.concat(directionaggregates.orthogonal)),l=1,k--):logError("The start of a rule must consist of some number of directions (possibly 0), before the first bracket, specifying in what directions to look (with no direction specified, it applies in all four directions).  It seems you've just entered \""+x.toUpperCase()+'".',o);break;case 1:if("["==x)++S>1&&logWarning("Multiple opening brackets without closing brackets.  Something fishy here.  Every '[' has to be closed by a ']', and you can't nest them.",o),c.length>0&&logError('Error, malformed cell rule - encountered a "["" before previous bracket was closed',o),u=!0,c=[];else if(reg_directions_only.exec(x))c.length%2==1?logError("Error, an item can only have one direction/action at a time, but you're looking for several at once!",o):u?g&&"no"!==x&&"random"!==x&&"randomdir"!==x?logError("Movements cannot appear in late rules.",o):c.push(x):logWarning("Invalid syntax. Directions should be placed at the start of a rule.",o);else if("|"==x)u?c.length%2==1?logError("In a rule, if you specify a force, it has to act on an object.",o):(d.push(c),c=[]):logWarning('Janky syntax.  "|" should only be used inside cell rows (the square brackety bits).',o);else if("]"===x)--S<0&&logWarning("Multiple closing brackets without corresponding opening brackets.  Something fishy here.  Every '[' has to be closed by a ']', and you can't nest them.",o),c.length%2==1?"..."===c[0]?logError("Cannot end a rule with ellipses.",o):logError("In a rule, if you specify a force, it has to act on an object.",o):(d.push(c),c=[]),h?p.push(d):f.push(d),d=[],u=!1;else if("->"===x)u?logError('Encountered an unexpected "->" inside square brackets.  It\'s used to separate states, it has no place inside them >:| .',o):h?logError('Error, you can only use "->" once in a rule; it\'s used to separate before and after states.',o):h=!0;else if(n.names.indexOf(x)>=0)u?c.length%2==0?(c.push(""),c.push(x)):c.length%2==1&&c.push(x):logWarning("Invalid token "+x.toUpperCase()+". Object names should only be used within cells (square brackets).",o);else if("..."===x)u?(c.push(x),c.push(x)):logWarning("Invalid syntax, ellipses should only be used within cells (square brackets).",o);else if(commandwords.indexOf(x.toLowerCase())>=0)if(!1===h?logError("Commands should only appear at the end of rules, not in or before the pattern-detection/-replacement sections.",o):(u||rightBracketToRightOf(i,k))&&logWarning("Commands should only appear at the end of rules, not in or before the pattern-detection/-replacement sections.",o),"message"===x.toLowerCase()){var M=findIndexAfterToken(a,i,k);""===(C=a.substring(M).trim())&&(C=" "),_.push([x.toLowerCase(),C]),k=i.length}else if("goto"===x.toLowerCase()){M=findIndexAfterToken(a,i,k);""===(C=a.substring(M).trim())&&(C=" "),_.push([x.toLowerCase(),C]),k=i.length}else if(twiddleable_params.includes(x.toLowerCase())){if(n.metadata.includes("runtime_metadata_twiddling")){var C;M=findIndexAfterToken(a,i,k);""===(C=a.substring(M).trim())&&(C=" "),_.push([x.toLowerCase(),C])}else logError("You can only change a flag at runtime if you have the 'runtime_metadata_twiddling' prelude flag defined!",o);k=i.length}else _.push([x.toLowerCase()]);else logError('Error, malformed cell rule - was looking for cell contents, but found "'+x+'".  What am I supposed to do with this, eh, please tell me that.',o)}}if(f.length!=p.length)_.length>0&&0==p.length||logError("Error, when specifying a rule, the number of matches (square bracketed bits) on the left hand side of the arrow must equal the number on the right",o);else for(k=0;k<f.length;k++)f[k].length!=p[k].length&&(logError("In a rule, each pattern to match on the left must have a corresponding pattern on the right of equal length (number of cells).",o),n.invalid=!0),0==f[k].length&&logError("You have an totally empty pattern on the left-hand side.  This will match *everything*.  You certainly don't want this.");0==f.length&&logError("This rule refers to nothing.  What the heck? :O",o);var I={directions:s,lhs:f,rhs:p,lineNumber:o,late:g,rigid:m,groupNumber:v,commands:_,randomRule:y,globalRule:w};return!1===directionalRule(I)&&I.directions.length>1&&I.directions.splice(1),I}function deepCloneHS(e){return e.map((function(e){return e.map((function(e){return e.slice()}))}))}function deepCloneRule(e){return{direction:e.direction,lhs:deepCloneHS(e.lhs),rhs:deepCloneHS(e.rhs),lineNumber:e.lineNumber,late:e.late,rigid:e.rigid,groupNumber:e.groupNumber,commands:e.commands,randomRule:e.randomRule,globalRule:e.globalRule}}function rulesToArray(e){for(var n=e.rules,t=[],r=[],o=0;o<n.length;o++){var a=n[o][1],i=processRuleString(n[o],e,t);void 0===i.bracket?t.push(i):r.push([a,i.bracket])}e.loops=r;var l=[];for(o=0;o<t.length;o++)for(var s=(g=t[o]).directions,c=0;c<s.length;c++){var d=s[c];if(d in directionaggregates&&directionalRule(g))for(var u=directionaggregates[d],h=0;h<u.length;h++){var f;(f=deepCloneRule(g)).direction=u[h],l.push(f)}else(f=deepCloneRule(g)).direction=d,l.push(f)}for(o=0;o<l.length;o++){if(convertRelativeDirsToAbsolute(g=l[o]),rewriteUpLeftRules(g),atomizeAggregates(e,g),e.invalid)return;rephraseSynonyms(e,g)}var p=[];for(o=0;o<l.length;o++){var g=l[o];p=p.concat(concretizeMovingRule(e,g,g.lineNumber))}var m=[];for(o=0;o<p.length;o++){g=p[o];m=m.concat(concretizePropertyRule(e,g,g.lineNumber))}for(o=0;o<m.length;o++)makeSpawnedObjectsStationary(e,m[o],g.lineNumber);e.rules=m}function containsEllipsis(e){for(var n=0;n<e.lhs.length;n++)for(var t=0;t<e.lhs[n].length;t++)if("..."===e.lhs[n][t][1])return!0;return!1}function rewriteUpLeftRules(e){if(!containsEllipsis(e)){if("up"==e.direction)e.direction="down";else{if("left"!=e.direction)return;e.direction="right"}for(var n=0;n<e.lhs.length;n++)e.lhs[n].reverse(),e.rhs.length>0&&e.rhs[n].reverse()}}function getPossibleObjectsFromCell(e,n){for(var t=[],r=0;r<n.length;r+=2){n[r];var o=n[r+1];if(o in e.objects)t.push(o);else if(o in e.propertiesDict)for(var a=e.propertiesDict[o],i=0;i<a.length;i++){var l=a[i];t.push(l)}}return t}function getPropertiesFromCell(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];"random"!=o&&(a in e.propertiesDict&&t.push(a))}return t}function getMovings(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];o in directionaggregates&&t.push([a,o])}return t}function concretizePropertyInCell(e,n,t){for(var r=0;r<e.length;r+=2)e[r+1]===n&&"random"!==e[r]&&(e[r+1]=t)}function concretizeMovingInCell(e,n,t,r){for(var o=0;o<e.length;o+=2)e[o]===n&&e[o+1]===t&&(e[o]=r)}function concretizeMovingInCellByAmbiguousMovementName(e,n,t){for(var r=0;r<e.length;r+=2)e[r]===n&&(e[r]=t)}function expandNoPrefixedProperties(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];if("no"===o&&a in e.propertiesDict)for(var i=e.propertiesDict[a],l=0;l<i.length;l++){var s=i[l];t.push(o),t.push(s)}else t.push(o),t.push(a)}return t}function concretizePropertyRule(e,n,t){for(var r=0;r<n.lhs.length;r++)for(var o=n.lhs[r],a=0;a<o.length;a++)o[a]=expandNoPrefixedProperties(e,o[a]),n.rhs.length>0&&(n.rhs[r][a]=expandNoPrefixedProperties(e,n.rhs[r][a]));var i,l={};for(a=0;a<n.rhs.length;a++)for(var s=n.lhs[a],c=n.rhs[a],d=0;d<c.length;d++)for(var u=getPropertiesFromCell(e,s[d]),h=getPropertiesFromCell(e,c[d]),f=0;f<h.length;f++){var p=h[f];-1==u.indexOf(p)&&(l[p]=!0)}for(var g=[n],m=!0;m;){m=!1;for(r=0;r<g.length;r++){var v=g[r];i=!1;for(a=0;a<v.lhs.length&&!i;a++){var _=v.lhs[a];for(d=0;d<_.length&&!i;d++){var y=getPropertiesFromCell(e,_[d]);for(f=0;f<y.length;++f){p=y[f];if(!e.propertiesSingleLayer.hasOwnProperty(p)||!0===l[p]){var b=e.propertiesDict[p];i=!0,m=!0;for(var w=0;w<b.length;w++){var S=b[w],k=deepCloneRule(v);for(var x in k.propertyReplacement={},v.propertyReplacement)if(v.propertyReplacement.hasOwnProperty(x)){var M=v.propertyReplacement[x];k.propertyReplacement[x]=[M[0],M[1]]}concretizePropertyInCell(k.lhs[a][d],p,S),k.rhs.length>0&&concretizePropertyInCell(k.rhs[a][d],p,S),void 0===k.propertyReplacement[p]?k.propertyReplacement[p]=[S,1]:k.propertyReplacement[p][1]=k.propertyReplacement[p][1]+1,g.push(k)}break}}}}i&&(g.splice(r,1),r--)}}for(r=0;r<g.length;r++){if(void 0!==(v=g[r]).propertyReplacement)for(var p in v.propertyReplacement)if(v.propertyReplacement.hasOwnProperty(p)){var C=v.propertyReplacement[p];S=C[0];if(1===C[1])for(a=0;a<v.rhs.length;a++){var I=v.rhs[a];for(d=0;d<I.length;d++){concretizePropertyInCell(I[d],p,S)}}}}var E="";for(r=0;r<g.length;r++){v=g[r];delete g.propertyReplacement;for(a=0;a<v.rhs.length;a++)for(_=v.rhs[a],d=0;d<_.length;d++)for(y=getPropertiesFromCell(e,_[d]),f=0;f<y.length;f++)l.hasOwnProperty(y[f])&&(E=y[f])}return E.length>0&&logError('This rule has a property on the right-hand side, "'+E.toUpperCase()+"\", that can't be inferred from the left-hand side.  (either for every property on the right there has to be a corresponding one on the left in the same cell, OR, if there's a single occurrence of a particular property name on the left, all properties of the same name on the right are assumed to be the same).",t),g}function makeSpawnedObjectsStationary(e,n,t){if(!n.late)for(var r=0;r<n.rhs.length;r++)for(var o=n.lhs[r],a=n.rhs[r],i=0;i<a.length;i++)for(var l=a[i],s=getPossibleObjectsFromCell(e,o[i]),c=s.map((n=>e.objects[n].layer)),d=0;d<l.length;d+=2){if(""===l[d]){var u=l[d+1];if(!(u in e.propertiesDict||s.indexOf(u)>=0)){var h=e.objects[u].layer;-1===c.indexOf(h)&&(l[d]="stationary")}}}}function concretizeMovingRule(e,n,t){for(var r,o=[n],a=!0;a;){a=!1;for(var i=0;i<o.length;i++){var l=o[i];r=!1;for(var s=0;s<l.lhs.length;s++)for(var c=l.lhs[s],d=0;d<c.length;d++){if((T=getMovings(e,c[d])).length>0){r=!0,a=!0;for(var u=T[0][0],h=T[0][1],f=directionaggregates[h],p=0;p<f.length;p++){var g=f[p],m=deepCloneRule(l);for(var v in m.movingReplacement={},l.movingReplacement)if(l.movingReplacement.hasOwnProperty(v)){var _=l.movingReplacement[v];m.movingReplacement[v]=[_[0],_[1],_[2],_[3],_[4],_[5]]}for(var v in m.aggregateDirReplacement={},l.aggregateDirReplacement)if(l.aggregateDirReplacement.hasOwnProperty(v)){_=l.aggregateDirReplacement[v];m.aggregateDirReplacement[v]=[_[0],_[1],_[2]]}if(concretizeMovingInCell(m.lhs[s][d],h,u,g),m.rhs.length>0&&concretizeMovingInCell(m.rhs[s][d],h,u,g),void 0===m.movingReplacement[u+h])m.movingReplacement[u+h]=[g,1,h,u,s,d];else{var y=m.movingReplacement[u+h];s===y[4]&&d===y[5]||(y[1]=y[1]+1)}void 0===m.aggregateDirReplacement[h]?m.aggregateDirReplacement[h]=[g,1,h]:m.aggregateDirReplacement[h][1]=m.aggregateDirReplacement[h][1]+1,o.push(m)}}}r&&(o.splice(i,1),i--)}}for(i=0;i<o.length;i++){if(void 0!==(l=o[i]).movingReplacement){var b={};for(var u in l.movingReplacement)if(l.movingReplacement.hasOwnProperty(u)){var w=(I=l.movingReplacement[u])[0],S=I[1],k=I[2],x=I[3];if(1===S)for(s=0;s<l.rhs.length;s++){var M=l.rhs[s];for(d=0;d<M.length;d++){concretizeMovingInCell(M[d],k,x,w)}}}var C={};for(var u in l.aggregateDirReplacement)if(l.aggregateDirReplacement.hasOwnProperty(u)){var I;w=(I=l.aggregateDirReplacement[u])[0],S=I[1];C[k=I[2]]=k in C||1!==S?"INVALID":w}for(var k in b)if(b.hasOwnProperty(k)&&"INVALID"!==k){if("INVALID"===(w=b[k]))continue;for(s=0;s<l.rhs.length;s++)for(M=l.rhs[s],d=0;d<M.length;d++){concretizeMovingInCellByAmbiguousMovementName(M[d],k,w)}}for(var k in C)if(C.hasOwnProperty(k)&&"INVALID"!==k){if("INVALID"===(w=C[k]))continue;for(s=0;s<l.rhs.length;s++)for(M=l.rhs[s],d=0;d<M.length;d++){concretizeMovingInCellByAmbiguousMovementName(M[d],k,w)}}}}var E="";for(i=0;i<o.length;i++){l=o[i];delete o.movingReplacement;for(s=0;s<l.rhs.length;s++)for(c=l.rhs[s],d=0;d<c.length;d++){var T;(T=getMovings(e,c[d])).length>0&&(E=T[0][1])}}return E.length>0&&(logError('This rule has an ambiguous movement on the right-hand side, "'+E+"\", that can't be inferred from the left-hand side.  (either for every ambiguous movement associated to an entity on the right there has to be a corresponding one on the left attached to the same entity, OR, if there's a single occurrence of a particular ambiguous movement on the left, all properties of the same movement attached to the same object on the right are assumed to be the same (or something like that)).",t),e.invalid=!0),o}function rephraseSynonyms(e,n){for(var t=0;t<n.lhs.length;t++)for(var r=n.lhs[t],o=n.rhs[t],a=0;a<r.length;a++){for(var i=r[a],l=1;l<i.length;l+=2){i[l]in e.synonymsDict&&(i[l]=e.synonymsDict[i[l]])}if(n.rhs.length>0){var s=o[a];for(l=1;l<s.length;l+=2){s[l]in e.synonymsDict&&(s[l]=e.synonymsDict[s[l]])}}}}function atomizeAggregates(e,n){for(var t=0;t<n.lhs.length;t++)for(var r=n.lhs[t],o=0;o<r.length;o++){atomizeCellAggregates(e,r[o],n.lineNumber)}for(t=0;t<n.rhs.length;t++)for(r=n.rhs[t],o=0;o<r.length;o++){atomizeCellAggregates(e,r[o],n.lineNumber)}}function atomizeCellAggregates(e,n,t){for(var r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];if(a in e.aggregatesDict){"no"===o&&logError("You cannot use 'no' to exclude the aggregate object "+a.toUpperCase()+" (defined using 'AND'), only regular objects, or properties (objects defined using 'OR').  If you want to do this, you'll have to write it out yourself the long way.",t);var i=e.aggregatesDict[a];n[r+1]=i[0];for(var l=1;l<i.length;l++)n.push(n[r]),n.push(i[l])}}}function convertRelativeDirsToAbsolute(e){for(var n=e.direction,t=0;t<e.lhs.length;t++)for(var r=e.lhs[t],o=0;o<r.length;o++){absolutifyRuleCell(n,r[o])}for(t=0;t<e.rhs.length;t++)for(r=e.rhs[t],o=0;o<r.length;o++){absolutifyRuleCell(n,r[o])}}var relativeDirs=["^","v","<",">","parallel","perpendicular"],relativeDict={right:["up","down","left","right","horizontal_par","vertical_perp"],up:["left","right","down","up","vertical_par","horizontal_perp"],down:["right","left","up","down","vertical_par","horizontal_perp"],left:["down","up","right","left","horizontal_par","vertical_perp"]};function absolutifyRuleCell(e,n){for(var t=0;t<n.length;t+=2){var r=n[t],o=relativeDirs.indexOf(r);o>=0&&(n[t]=relativeDict[e][o])}}var dirMasks={up:parseInt("00001",2),down:parseInt("00010",2),left:parseInt("00100",2),right:parseInt("01000",2),moving:parseInt("01111",2),no:parseInt("00011",2),randomdir:parseInt("00101",2),random:parseInt("10010",2),action:parseInt("10000",2),"":parseInt("00000",2)};function rulesToMask(e){for(var n=e.collisionLayers.length,t=[],r=0;r<n;r++)t.push(null);for(r=0;r<e.rules.length;r++)for(var o=e.rules[r],a=0;a<o.lhs.length;a++)for(var i=o.lhs[a],l=o.rhs[a],s=0;s<i.length;s++){for(var c=i[s],d=t.concat([]),u=new BitVec(STRIDE_OBJ),h=new BitVec(STRIDE_OBJ),f=[],p=new BitVec(STRIDE_MOV),g=new BitVec(STRIDE_MOV),m=new BitVec(STRIDE_MOV),v=0;v<c.length;v+=2){if("..."===(L=c[v])){if(u=ellipsisPattern,2!==c.length)logError("You can't have anything in with an ellipsis. Sorry.",o.lineNumber);else if(0===s||s===i.length-1)logError("There's no point in putting an ellipsis at the very start or the end of a rule",o.lineNumber);else if(o.rhs.length>0){2===(S=l[s]).length&&"..."===S[0]||logError("An ellipsis on the left must be matched by one in the corresponding place on the right.",o.lineNumber)}break}if("random"!==L){var _=c[v+1],y=e.objects[_],b=e.objectMasks[_];if(y)var w=0|y.layer;else w=e.propertiesSingleLayer[_];if(void 0===w&&logError("Oops!  "+_.toUpperCase()+" not assigned to a layer.",o.lineNumber),"no"===L)h.ior(b);else null!==(V=d[w])&&(o.discard=[_.toUpperCase(),V.toUpperCase()]),d[w]=_,y?(u.ior(b),m.ishiftor(31,5*w)):f.push(b),"stationary"===L?g.ishiftor(31,5*w):p.ishiftor(dirMasks[L],5*w)}else logError("'random' cannot be matched on the left-hand side, it can only appear on the right",o.lineNumber)}if(o.rhs.length>0){var S=l[s],k=i[s];"..."===S[0]&&"..."!==k[0]&&logError("An ellipsis on the right must be matched by one in the corresponding place on the left.",o.lineNumber);for(v=0;v<S.length;v+=2){"..."===S[v]&&2!==S.length&&logError("You can't have anything in with an ellipsis. Sorry.",o.lineNumber)}}if(u!==ellipsisPattern){if(i[s]=new CellPattern([u,h,f,p,g,null]),u.anyBitsInCommon(h)){var x=o.lineNumber;r>0&&e.rules[r-1].lineNumber===x||r+1<e.rules.length&&e.rules[r+1].lineNumber===x||logError('This rule has some content of the form "X no X" which can never match and so the rule is getting removed during compilation.',o.lineNumber),e.rules.splice(r,1),r--}else if(0!==o.rhs.length){var M=l[s],C=t.concat([]),I=t.concat([]),E=new BitVec(STRIDE_OBJ),T=new BitVec(STRIDE_OBJ),A=new BitVec(STRIDE_MOV),R=new BitVec(STRIDE_MOV),F=new BitVec(STRIDE_MOV),O=new BitVec(STRIDE_OBJ),D=new BitVec(STRIDE_MOV),P=new BitVec(STRIDE_MOV);for(v=0;v<M.length;v+=2){var L=M[v];_=M[v+1];if("..."===L)break;if("random"!==L){y=e.objects[_],b=e.objectMasks[_];if(y)w=0|y.layer;else w=e.propertiesSingleLayer[_];if("no"==L)E.ior(b);else{null===(V=C[w])&&(V=I[w]),null!==V&&(o.hasOwnProperty("discard")||logError("Rule matches object types that can't overlap: \""+_.toUpperCase()+'" and "'+V.toUpperCase()+'".',o.lineNumber)),C[w]=_,L.length>0&&D.ishiftor(31,5*w);var N=e.layerMasks[w];y&&(T.ibitset(y.id),E.ior(N),F.ishiftor(31,5*w)),"stationary"===L&&A.ishiftor(31,5*w),"randomdir"===L?P.ishiftor(dirMasks[L],5*w):R.ishiftor(dirMasks[L],5*w)}}else if(_ in e.objectMasks){var B,j=e.objectMasks[_];O.ior(j),B=e.propertiesDict.hasOwnProperty(_)?e.propertiesDict[_]:[_];for(var q=0;q<B.length;q++){var V,z=B[q];if(null!==(V=C[w=0|e.objects[z].layer])){var G=z.toUpperCase(),U=V.toUpperCase();G!==U&&logWarning("This rule may try to spawn a "+G+" with random, but also requires a "+U+" be here, which is on the same layer - they shouldn't be able to coexist!",o.lineNumber)}I[w]=z}}else logError('You want to spawn a random "'+_.toUpperCase()+"\", but I don't know how to do that",o.lineNumber)}u.bitsSetInArray(T.data)||E.ior(u),p.bitsSetInArray(R.data)||A.ior(p);for(v=0;v<n;v++)null!==d[v]&&null===C[v]&&(E.ior(e.layerMasks[v]),D.ishiftor(31,5*v));m.iclear(F),D.ior(m),E.iszero()&&T.iszero()&&A.iszero()&&R.iszero()&&D.iszero()&&O.iszero()&&P.iszero()||(i[s].replacement=new CellReplacement([E,T,A,R,D,O,P]))}}else i[s]=ellipsisPattern}}function cellRowMasks(e){for(var n=[],t=e[1],r=0;r<t.length;r++){for(var o=t[r],a=new BitVec(STRIDE_OBJ),i=0;i<o.length;i++)o[i]!==ellipsisPattern&&a.ior(o[i].objectsPresent);n.push(a)}return n}function cellRowMasks_Movements(e){for(var n=[],t=e[1],r=0;r<t.length;r++){for(var o=t[r],a=new BitVec(STRIDE_MOV),i=0;i<o.length;i++)o[i]!==ellipsisPattern&&a.ior(o[i].movementsPresent);n.push(a)}return n}function collapseRules(e){for(var n=0;n<e.length;n++)for(var t=e[n],r=0;r<t.length;r++){for(var o=t[r],a=[0,[],o.rhs.length>0,o.lineNumber],i=[],l=0;l<o.lhs.length;l++)i.push(!1);a[0]=dirMasks[o.direction];for(l=0;l<o.lhs.length;l++){for(var s=o.lhs[l],c=0;c<s.length;c++)s[c]===ellipsisPattern&&(i[l]&&logError("You can't use two ellipses in a single cell match pattern.  If you really want to, please implement it yourself and send me a patch :) ",o.lineNumber),i[l]=!0);a[1][l]=s}a.push(i),a.push(o.groupNumber),a.push(o.rigid),a.push(o.commands),a.push(o.randomRule),a.push(cellRowMasks(a)),a.push(cellRowMasks_Movements(a)),a.push(o.globalRule),t[r]=new Rule(a)}matchCache={}}function ruleGroupDiscardOverlappingTest(e){if(0!==e.length)for(var n=0;n<e.length;n++){var t=e[n];if(t.hasOwnProperty("discard")){if(e.splice(n,1),(0===n||e[n-1].lineNumber!==t.lineNumber)&&n<e.length-1&&e[n+1].lineNumber!==t.lineNumber||0===e.length){var r=t.discard;logError(r[0]+" and "+r[1]+" can never overlap, but this rule requires that to happen.",t.lineNumber)}n--}}}function arrangeRulesByGroupNumber(e){for(var n={},t={},r=0;r<e.rules.length;r++){var o=e.rules[r],a=n;o.late&&(a=t),null==a[o.groupNumber]&&(a[o.groupNumber]=[]),a[o.groupNumber].push(o)}var i=[];for(var l in n){if(n.hasOwnProperty(l))ruleGroupDiscardOverlappingTest(c=n[l]),c.length>0&&i.push(c)}var s=[];for(var l in t){var c;if(t.hasOwnProperty(l))ruleGroupDiscardOverlappingTest(c=t[l]),c.length>0&&s.push(c)}e.rules=i,e.lateRules=s}function generateRigidGroupList(e){for(var n=[],t=[],r=[],o=[],a=[],i=0;i<e.rules.length;i++){for(var l=e.rules[i],s=!1,c=0;c<l.length;c++){l[c].isRigid&&(s=!0)}if(a[i]=s,s){var d=l[0].groupNumber;r[d]=i;var u=n.length;t[i]=u,o[d]=u,n.push(i)}}n.length>60&&logError("There can't be more than 60 rigid groups (rule groups containing rigid members).",rules[0][0][3]),e.rigidGroups=a,e.rigidGroupIndex_to_GroupIndex=n,e.groupNumber_to_RigidGroupIndex=o,e.groupIndex_to_RigidGroupIndex=t}function getMaskFromName(e,n){var t=new BitVec(STRIDE_OBJ);if(n in e.objects){var r=e.objects[n];t.ibitset(r.id)}if(n in e.aggregatesDict)for(var o=e.aggregatesDict[n],a=0;a<o.length;a++){var i=o[a];r=e.objects[i];t.ibitset(r.id)}if(n in e.propertiesDict)for(o=e.propertiesDict[n],a=0;a<o.length;a++){i=o[a],r=e.objects[i];t.ibitset(r.id)}if(n in e.synonymsDict){i=e.synonymsDict[n],r=e.objects[i];t.ibitset(r.id)}return!e.metadata.includes("nokeyboard")&&t.iszero()&&logErrorNoLine("error, didn't find any object called player, either in the objects section, or the legends section. there must be a player!"),t}function generateMasks(e){e.playerMask=getMaskFromName(e,"player");for(var n=[],t=e.collisionLayers.length,r=0;r<t;r++){for(var o=new BitVec(STRIDE_OBJ),a=0;a<e.objectCount;a++){var i=e.idDict[a];(s=e.objects[i]).layer==r&&o.ibitset(s.id)}n.push(o)}e.layerMasks=n;var l={};for(var i in e.objects)if(e.objects.hasOwnProperty(i)){var s=e.objects[i];l[i]=new BitVec(STRIDE_OBJ),l[i].ibitset(s.id)}var c=e.legend_synonyms.concat(e.legend_properties);c.sort((function(e,n){return e.lineNumber-n.lineNumber}));for(var d=0;d<c.length;d++){var u=c[d];if(2==u.length)l[u[0]]=l[u[1]];else{var h=new BitVec(STRIDE_OBJ);for(a=1;a<u.length;a++){i=u[a];h.ior(l[i])}l[u[0]]=h}}var f=new BitVec(STRIDE_OBJ);f.inot(),l["\nall\n"]=f,e.objectMasks=l}function checkObjectsAreLayered(e){for(var n in e.objects)if(e.objects.hasOwnProperty(n)){for(var t=!1,r=0;r<e.collisionLayers.length;r++){for(var o=e.collisionLayers[r],a=0;a<o.length;a++)if(o[a]===n){t=!0;break}if(t)break}if(!1===t){var i=e.objects[n];logError('Object "'+n.toUpperCase()+'" has been defined, but not assigned to a layer.',i.lineNumber)}}}function twiddleMetaData(e,n=!1){var t;if(n)t=e.metadata;else{t={};for(var r=0;r<e.metadata.length;r+=2){var o=e.metadata[r],a=e.metadata[r+1];t[o]=a}}if(void 0!==t.flickscreen){var i=(a=t.flickscreen).split("x"),l=[parseInt(i[0]),parseInt(i[1])];t.flickscreen=l}if(void 0!==t.zoomscreen){i=(a=t.zoomscreen).split("x"),l=[parseInt(i[0]),parseInt(i[1])];t.zoomscreen=l}if(void 0!==t.smoothscreen){var s=(a=t.smoothscreen).split(/\s+/),c=!0;s.length<1?(logErrorNoLine("smoothscreen given no arguments but expects at least 1: smoothscreen [flick] WxH [IxJ] [S]"),c=!1):s.length>4&&(logErrorNoLine("smoothscreen given "+s.length+" arguments but expects at most 4: smoothscreen [flick] WxH [IxJ] [S]"),c=!1);const e={screenSize:{width:0,height:0},boundarySize:{width:1,height:1},cameraSpeed:.125,flick:!1,debug:!!t.smoothscreen_debug};"flick"===s[0]&&(e.flick=!0,s.shift());const n=s[0].match(/^(?<width>\d+)x(?<height>\d+)$/);if(n?(e.screenSize.width=parseInt(n.groups.width),e.screenSize.height=parseInt(n.groups.height),e.flick&&(e.boundarySize.width=e.screenSize.width,e.boundarySize.height=e.screenSize.height)):(logErrorNoLine("smoothscreen given first argument "+s[0]+" but must be formatted WxH where W and H are integers"),c=!1),s.length>1){const n=s[1].match(/^(?<width>\d+)x(?<height>\d+)$/);n?(e.boundarySize.width=parseInt(n.groups.width),e.boundarySize.height=parseInt(n.groups.height)):(logErrorNoLine("smoothscreen given second argument "+s[1]+" but must be formatted IxJ where I and J are integers"),c=!1)}if(s.length>2){const n=s[2].match(/^(?<speed>\d+(\.\d+)?)$/);n?e.cameraSpeed=clamp(parseFloat(n.groups.speed),0,1):(logErrorNoLine("smoothscreen given third argument "+s[2]+" but must be a number"),c=!1)}c?t.smoothscreen=e:delete t.smoothscreen}e.metadata=t,n||(e.default_metadata=deepClone(t))}function processWinConditions(e){for(var n=[],t=0;t<e.winconditions.length;t++){var r=e.winconditions[t];if(0==r.length)return;var o=0;switch(r[0]){case"no":o=-1;break;case"all":o=1}var a,i=r[r.length-1],l=r[1];a=5==r.length?r[3]:"\nall\n";var s=0,c=0;l in e.objectMasks?s=e.objectMasks[l]:logError('Unwelcome term "'+l+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',i),a in e.objectMasks?c=e.objectMasks[a]:logError('Unwelcome term "'+a+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',i);var d=[o,s,c,i];n.push(d)}e.winconditions=n}function printCellRow(e){for(var n="[ ",t=0;t<e.length;t++){t>0&&(n+="| ");for(var r=e[t],o=0;o<r.length;o+=2){var a=r[o],i=r[o+1];n+="..."===a?a+" ":a+" "+i+" "}}return n+="] "}function cacheRuleStringRep(e){var n="(<a onclick=\"jumpToLine('"+e.lineNumber.toString()+'\');"  href="javascript:void(0);">'+e.lineNumber+"</a>) "+e.direction.toString().toUpperCase()+" ";e.rigid&&(n="RIGID "+n+" "),e.randomRule&&(n="RANDOM "+n+" "),e.globalRule&&(n="GLOBAL "+n+" "),e.late&&(n="LATE "+n+" ");for(var t=0;t<e.lhs.length;t++){n+=printCellRow(e.lhs[t])}n+="-> ";for(t=0;t<e.rhs.length;t++){n+=printCellRow(e.rhs[t])}for(t=0;t<e.commands.length;t++){var r=e.commands[t];1===r.length?n+=r[0].toString():n=n+"("+r[0].toString()+", "+r[1].toString()+") "}e.stringRep=n}function cacheAllRuleNames(e){for(var n=0;n<e.rules.length;n++){cacheRuleStringRep(e.rules[n])}}function printRules(e){for(var n="",t=0,r=-1,o=0,a=0;a<e.rules.length;a++){var i=e.rules[a];t<e.loops.length&&e.loops[t][0]<i.lineNumber&&(n+="STARTLOOP<br>",++t<e.loops.length&&(r=e.loops[t][0],t++)),-1!==r&&r<i.lineNumber&&(n+="ENDLOOP<br>",r=-1),i.hasOwnProperty("discard")?o++:n+=i.stringRep+"<br>"}-1!==r&&(n+="ENDLOOP<br>"),n+="===========<br>",consolePrint(n="<br>Rule Assembly : ("+(e.rules.length-o)+" rules)<br>===========<br>"+n)}function removeDuplicateRules(e){for(var n={},t=-1,r=e.rules.length-1;r>=0;r--){var o=e.rules[r],a=o.groupNumber;a!==t&&(n={});var i=o.stringRep;n.hasOwnProperty(i)?e.rules.splice(r,1):n[i]=!0,t=a}}function generateLoopPoints(e){var n={},t=!0,r=0;e.loops.length%2==1&&logErrorNoLine("have to have matching number of  'startLoop' and 'endLoop' loop points.");for(var o=0;o<e.loops.length;o++)for(var a=e.loops[o],i=0;i<e.rules.length;i++){var l=(d=e.rules[i])[0],s=d[d.length-1],c=l.lineNumber;s.lineNumber;if(t){if(c>=a[0]){r=i,t=!1,-1===a[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(c>=a[0]){n[i-1]=r,t=!0,1===a[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}!1===t&&(n[e.rules.length]=r);e.loopPoint=n,n={},t=!0;for(o=0;o<e.loops.length;o++)for(a=e.loops[o],i=0;i<e.lateRules.length;i++){var d;l=(d=e.lateRules[i])[0],s=d[d.length-1],c=l.lineNumber,s.lineNumber;if(t){if(c>=a[0]){r=i,t=!1,-1===a[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(c>=a[0]){n[i-1]=r,t=!0,1===a[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}!1===t&&(n[e.lateRules.length]=r);e.lateLoopPoint=n}var soundEvents=["titlescreen","startgame","cancel","endgame","startlevel","undo","restart","endlevel","enterlevelselect","showmessage","closemessage","sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","sfx11","sfx12","sfx13"],soundMaskedEvents=["create","destroy","move","cantmove","action"],soundVerbs=soundEvents.concat(soundMaskedEvents);function validSeed(e){return null!==/^\s*\d+\s*$/.exec(e)}var soundDirectionIndicatorMasks={up:parseInt("00001",2),down:parseInt("00010",2),left:parseInt("00100",2),right:parseInt("01000",2),horizontal:parseInt("01100",2),vertical:parseInt("00011",2),orthogonal:parseInt("01111",2),___action____:parseInt("10000",2)},soundDirectionIndicators=["up","down","left","right","horizontal","vertical","orthogonal","___action____"];function generateSoundData(e){for(var n={},t=[],r=[],o=[],a=[],i=0;i<e.sounds.length;i++){var l=e.sounds[i];if(!(l.length<=1)){var s=l[l.length-1];if(2!==l.length)if(soundEvents.indexOf(l[0])>=0){l.length>4&&logError("too much stuff to define a sound event.",s),validSeed(h=l[1])?(void 0!==n[l[0]]&&logWarning(l[0].toUpperCase()+" already declared.",s),n[l[0]]=l[1]):logError('Expecting sfx data, instead found "'+l[1]+'".',s)}else{var c=l[0].trim(),d=l[1].trim(),u=l.slice(2,l.length-2);u.length>0&&"move"!==d&&"cantmove"!==d&&logError("incorrect sound declaration.",s),"action"===d&&(d="move",u=["___action____"]),0==u.length&&(u=["orthogonal"]);var h=l[l.length-2];c in e.aggregatesDict?logError('cannot assign sound events to aggregate objects (declared with "and"), only to regular objects, or properties, things defined in terms of "or" ("'+c+'").',s):c in e.objectMasks||logError('Object "'+c+'" not found.',s);for(var f=e.objectMasks[c],p=0,g=0;g<u.length;g++){u[g]=u[g].trim();var m=u[g];if(-1===soundDirectionIndicators.indexOf(m))logError('Was expecting a direction, instead found "'+m+'".',s);else p|=soundDirectionIndicatorMasks[m]}for(var v=[c],_=!0;_;){_=!1;for(var y=0;y<v.length;y++){var b=v[y];if(b in e.synonymsDict)v[y]=e.synonymsDict[b],_=!0;else if(b in e.propertiesDict){_=!0;var w=e.propertiesDict[b];v.splice(y,1),y--;for(var S=0;S<w.length;S++)v.push(w[S])}}}if("move"===d||"cantmove"===d)for(g=0;g<v.length;g++){var k=v[g],x=e.objects[k].layer,M=new BitVec(STRIDE_MOV);M.ishiftor(p,5*x);var C={objectMask:f,directionMask:M,seed:h};"move"===d?o.push(C):a.push(C)}switch(validSeed(h)||logError('Expecting sfx data, instead found "'+h+'".',s),d){case"create":C={objectMask:f,seed:h};t.push(C);break;case"destroy":C={objectMask:f,seed:h};r.push(C)}}else logError("incorrect sound declaration.",s)}}e.sfx_Events=n,e.sfx_CreationMasks=t,e.sfx_DestructionMasks=r,e.sfx_MovementMasks=o,e.sfx_MovementFailureMasks=a}function formatHomePage(e){if("background_color"in e.metadata?e.bgcolor=colorToHex(colorPalette,e.metadata.background_color):e.bgcolor="#000000","text_color"in e.metadata?e.fgcolor=colorToHex(colorPalette,e.metadata.text_color):e.fgcolor="#FFFFFF",!1===isColor(e.fgcolor)&&(logError("text_color in incorrect format - found "+e.fgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA').  Defaulting to white."),e.fgcolor="#FFFFFF"),!1===isColor(e.bgcolor)&&(logError("background_color in incorrect format - found "+e.bgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA').  Defaulting to black."),e.bgcolor="#000000"),canSetHTMLColors&&("background_color"in e.metadata&&(document.body.style.backgroundColor=e.bgcolor),"text_color"in e.metadata)){var n=document.getElementById("separator");null!=n&&(n.style.color=e.fgcolor);for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)t[r].style.color=e.fgcolor;for(t=document.getElementsByTagName("h1"),r=0;r<t.length;r++)t[r].style.color=e.fgcolor}if("homepage"in e.metadata){var o=e.metadata.homepage;o=(o=o.replace("http://","")).replace("https://",""),e.metadata.homepage=o}}var ifrm,MAX_ERRORS=5;function loadFile(e){for(var n=new codeMirrorFn,t=n.startState(),r=e.split("\n"),o=0;o<r.length;o++){var a=r[o];t.lineNumber=o+1;var i=new CodeMirror.StringStream(a,4);do{if(n.token(i,t),errorCount>MAX_ERRORS)return void consolePrint("too many errors, aborting compilation")}while(!1===i.eol())}return generateExtraMembers(t),generateMasks(t),levelsToArray(t),extractSections(t),rulesToArray(t),t.invalid>0?null:(cacheAllRuleNames(t),removeDuplicateRules(t),t.invalid>0?null:(convertSectionNamesToIndices(t),rulesToMask(t),debugMode&&printRules(t),arrangeRulesByGroupNumber(t),collapseRules(t.rules),collapseRules(t.lateRules),generateRigidGroupList(t),processWinConditions(t),checkObjectsAreLayered(t),twiddleMetaData(t),generateExtraMembersPart2(t),generateLoopPoints(t),generateSoundData(t),formatHomePage(t),IDE&&(t.metadata.tween_length&&t.lateRules.length>=1&&logWarning("[PS+] Using tweens in a game that also has LATE rules is currently experimental! If you change objects that moved with LATE then tweens might not play!",void 0,!1),void 0!==t.metadata.level_select_unlocked_ahead&&void 0!==t.metadata.level_select_unlocked_rollover&&logWarning("[PS+] You can't use both level_select_unlocked_ahead and level_select_unlocked_rollover at the same time, so please choose only one!",void 0,!1)),delete t.commentLevel,delete t.names,delete t.abbrevNames,delete t.objects_candname,delete t.objects_section,delete t.objects_spritematrix,delete t.section,delete t.subsection,delete t.tokenIndex,delete t.visitedSections,delete t.loops,t))}function compile(e,n,t){(matchCache={},forceRegenImages=!0,void 0===e&&(e=["restart"]),void 0===t&&(t=null),lastDownTarget=canvas,void 0===n)&&(n=window.form1.code.editorreference.getValue()+"\n");!0===canDump&&(compiledText=n),errorCount=0,compiling=!0,errorStrings=[],consolePrint("=================================");try{var r=loadFile(n)}finally{compiling=!1}if(r&&r.levels&&0===r.levels.length&&logError("No levels found.  Add some levels!",void 0,!0),!(errorCount>MAX_ERRORS)){if(errorCount>0)consoleError(!1===IDE?'<span class="systemMessage">Errors detected during compilation; the game may not work correctly.  If this is an older game, and you think it just broke because of recent changes in the puzzlescript plus engine, consider letting me know via the issue tracker.</span>':'<span class="systemMessage">Errors detected during compilation; the game may not work correctly.</span>');else{for(var o=0,a=0;a<r.rules.length;a++)o+=r.rules[a].length;for(a=0;a<r.lateRules.length;a++)o+=r.lateRules[a].length;"restart"==e[0]?consolePrint('<span class="systemMessage">Successful Compilation, generated '+o+" instructions.</span>"):consolePrint('<span class="systemMessage">Successful live recompilation, generated '+o+" instructions.</span>"),IDE&&void 0!==r.metadata.title&&(document.title="PS Plus - "+r.metadata.title)}null!==r&&setGameState(r,e,t),clearInputHistory(),isSitelocked()&&IDE&&logError("The game is sitelocked. To continue testing, add the current domain '"+window.location.origin+"' to the list.",void 0,!0),consoleCacheDump()}}function qualifyURL(e){var n=document.createElement("a");return n.href=e,n.href}function isSitelocked(){if(void 0===state.metadata.sitelock_origin_whitelist&&void 0===state.metadata.sitelock_hostname_whitelist)return!1;if(1==IDE)return!1;if(void 0===state.metadata.sitelock_origin_whitelist)for(var e=state.metadata.sitelock_origin_whitelist.split(" "),n=window.location.origin,t=0;t<e.length;t+=1)if(n==e[t])return!1;if(null==state.metadata.sitelock_hostname_whitelist){var r=state.metadata.sitelock_hostname_whitelist.split(" "),o=window.location.hostname;for(t=0;t<r.length;t+=1)if(o==r[t])return!1}return!0}var keyRepeatTimer=0,keyRepeatIndex=0,input_throttle_timer=0,lastinput=-100,dragging=!1,rightdragging=!1,columnAdded=!1;function selectText(e,n){n=n||window.event;var t=document.getElementById(e);if(n&&(n.ctrlKey||n.metaKey)){if(solving)return;var r=["console"].concat(t.innerHTML.split("<br>")),o=levelFromString(state,r);loadLevelFromLevelDat(state,o,null),canvasResize()}else{if(document.selection)(a=document.body.createTextRange()).moveToElementText(t),a.select();else if(window.getSelection){var a;(a=document.createRange()).selectNode(t);var i=window.getSelection();i.removeAllRanges(),i.addRange(a)}}}function recalcLevelBounds(){}function arrCopy(e,n,t,r,o){for(;o--;)t[r++]=e[n]++}function adjustLevel(e,n,t){backups.push(backupLevel());var r=e.clone();e.width+=n,e.height+=t,e.n_tiles=e.width*e.height,e.objects=new Int32Array(e.n_tiles*STRIDE_OBJ);var o=new BitVec(STRIDE_OBJ);o.ibitset(state.backgroundid);for(var a=0;a<e.n_tiles;++a)e.setCell(a,o);return e.movements=new Int32Array(e.objects.length),columnAdded=!0,RebuildLevelArrays(),r}function addLeftColumn(){for(var e=adjustLevel(level,1,0),n=1;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r-level.height))}}function addRightColumn(){for(var e=adjustLevel(level,1,0),n=0;n<level.width-1;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r))}}function addTopRow(){for(var e=adjustLevel(level,0,1),n=0;n<level.width;++n)for(var t=1;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r-n-1))}}function addBottomRow(){for(var e=adjustLevel(level,0,1),n=0;n<level.width;++n)for(var t=0;t<level.height-1;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r-n))}}function removeLeftColumn(){if(!(level.width<=1))for(var e=adjustLevel(level,-1,0),n=0;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r+level.height))}}function removeRightColumn(){if(!(level.width<=1))for(var e=adjustLevel(level,-1,0),n=0;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r))}}function removeTopRow(){if(!(level.height<=1))for(var e=adjustLevel(level,0,-1),n=0;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r+n+1))}}function removeBottomRow(){if(!(level.height<=1))for(var e=adjustLevel(level,0,-1),n=0;n<level.width;++n)for(var t=0;t<level.height;++t){var r=n*level.height+t;level.setCell(r,e.getCell(r+n))}}function matchGlyph(e,n){for(var t,r=-1,o=0;o<n.length;++o){var a=n[o][0],i=n[o][1],l=n[o][2];if(i.bitsSetInArray(e.data)){for(var s=0,c=0;c<32*STRIDE_OBJ;++c)l.get(c)&&e.get(c)&&s++,i.get(c)&&e.get(c)&&s++;s>r&&(r=s,t=a)}}return r>0?t:(logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0),".")}var lastCoord,htmlEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},selectableint=0;function printLevel(){var e=[];for(var n in state.glyphDict)if(state.glyphDict.hasOwnProperty(n)&&1===n.length){for(var t=state.glyphDict[n],r=new BitVec(STRIDE_OBJ),o=0;o<t.length;o++){var a=t[o];a>=0&&r.ibitset(a)}var i=r.clone(),l=state.layerMasks[state.backgroundlayer];r.iclear(l),e.push([n,r,i])}var s="selectable"+ ++selectableint,c='Printing level contents:<br><br><span id="'+s+'" onclick="selectText(\''+s+"',event)\"><br>";cache_console_messages=!1;for(var d=0;d<level.height;d++){for(o=0;o<level.width;o++){var u=d+o*level.height;(t=matchGlyph(level.getCell(u),e))in htmlEntityMap&&(t=htmlEntityMap[t]),c+=t}d<level.height-1&&(c+="<br>")}consolePrint(c+="</span><br><br>",!0)}function levelEditorClick(e,n){if(mouseCoordY<=-2){var t=mouseCoordX+(screenwidth-1)*(editorRowCount-(-mouseCoordY-2)-1);-1===mouseCoordX?printLevel():mouseCoordX>=0&&t<glyphImages.length&&(glyphSelectedIndex=t,redraw())}else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){for(var r=glyphImagesCorrespondance[glyphSelectedIndex],o=state.glyphDict[r],a=new BitVec(STRIDE_OBJ),i=0;i<o.length;i++){var l=o[i];l>=0&&a.ibitset(l)}var s=state.layerMasks[state.backgroundlayer];a.bitsClearInArray(s.data)&&a.ibitset(state.backgroundid);var c=mouseCoordY+mouseCoordX*level.height;if(level.getCell(c).equals(a))return;!1===anyEditsSinceMouseDown&&(anyEditsSinceMouseDown=!0,backups.push(backupLevel())),level.setCell(c,a),redraw()}else n&&(-1===mouseCoordX?(addLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(addRightColumn(),canvasResize()),-1===mouseCoordY?(addTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(addBottomRow(),canvasResize()))}function levelEditorRightClick(e,n){if(-2===mouseCoordY)mouseCoordX<=glyphImages.length&&(glyphSelectedIndex=mouseCoordX,redraw());else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var t=mouseCoordY+mouseCoordX*level.height,r=new BitVec(STRIDE_OBJ);r.ibitset(state.backgroundid),level.setCell(t,r),redraw()}else n&&(-1===mouseCoordX?(removeLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(removeRightColumn(),canvasResize()),-1===mouseCoordY?(removeTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(removeBottomRow(),canvasResize()))}function getTilesTraversingPoints(e,n,t,r){if(cellwidth!==cellheight)throw"Error: Cell is not square.";var o=t-e,a=r-n,i=e*a-n*o,l=cellwidth*(Math.abs(o)+Math.abs(a)),s=2*i-l,c=2*i+l;for(var d=Math.floor(e/cellwidth),u=Math.floor(n/cellheight),h=Math.floor(t/cellwidth),f=Math.floor(r/cellheight),p=cellwidth-1,g=h-d>=0?1:-1,m=f-u>=0?1:-1,v=u,_=[],y=[],b=d;b!=h+g;b+=g)for(var w=!1,S=v;S!=f+m;S+=m){if(S>=level.height||S<0||b>=level.width||b<0)throw error="Mouse input loop failed; it:"+b+" "+S+" cell1:"+d+" "+u+" cell2:"+h+" "+f,console.log(error),error;if(fOfPointTimesTwo=a*(2*b*cellwidth+p)-o*(2*S*cellwidth+p),s<fOfPointTimesTwo==fOfPointTimesTwo<=c)_.push(b),y.push(S),w=!0,v=S;else if(w)break}for(var k=("mouse_obstacle"in state.metadata),x=[d],M=[u];d!==h||u!==f;){if(u>=level.height||u<0||d>=level.width||d<0)throw error="Mouse input loop failed; cell1:"+d+" "+u+" cell2:"+h+" "+f,console.log(error),error;if(hitObstacle=function(){var e=screenOffsetY+u+(screenOffsetX+d)*level.height,n=level.getCell(e);return!!state.obstacleMask.anyBitsInCommon(n)},cellCornerXTimesTwo=2*d*cellwidth+p+g*cellwidth,cellCornerYTimesTwo=2*u*cellwidth+p+m*cellwidth,fOfPointTimesTwo=a*cellCornerXTimesTwo-o*cellCornerYTimesTwo,fOfPointTimesTwo>2*i==m>0!=g>0?(d+=g,k&&hitObstacle()&&(d-=g,u+=m)):(u+=m,k&&hitObstacle()&&(u-=m,d+=g)),k&&hitObstacle())break;x.push(d),M.push(u)}if(k)_=x,y=M;else for(b=0;b<_.length;b++)if(_[b]!==x[b]||y[b]!==M[b]){try{displayError("line tile placement algorithm discrepancies detected")}catch(e){}throw consolePrint("line tile placement algorithm discrepancies detected",!0),"line tile placement algorithm discrepancies detected"}return{tileListX:_,tileListY:y}}var x1=5,y1=5,x2=5,y2=5;function mouseAction(e,n,t){if(textMode){if(!n){if(quittingTitleScreen)return;return void(hoverSelection=!mouseInCanvas||mouseCoordY<0||mouseCoordY>15?-1:mouseCoordY)}if(titleScreen){if(quittingTitleScreen||titleSelected)return;if(0===titleMode)titleButtonSelected();else if(1===titleMode)8===mouseCoordY&&titleSelectOptions>=1?(titleSelection=0,titleButtonSelected()):9===mouseCoordY&&titleSelectOptions>=3?(titleSelection=1,titleButtonSelected()):10===mouseCoordY&&titleSelectOptions>=2?(titleSelection=2===titleSelectOptions?1:2,titleButtonSelected()):11===mouseCoordY&&titleSelectOptions>=4&&(titleSelection=3,titleButtonSelected());else if(2===titleMode){if(quittingTitleScreen||titleSelected)return;if(0===mouseCoordY)titleSelection=0,goToTitleScreen(),tryPlayTitleSound(),canvasResize();else if(2===mouseCoordY)0!=levelSelectScrollPos&&levelSelectScroll(-3);else if(12===mouseCoordY)titleSelectOptions-amountOfLevelsOnScreen>levelSelectScrollPos&&levelSelectScroll(3);else{var r=-1;switch(mouseCoordY){case 3:r=0;break;case 4:r=1;break;case 5:r=2;break;case 6:r=3;break;case 7:r=4;break;case 8:r=5;break;case 9:r=6;break;case 10:r=7;break;case 11:r=8}-1!=r&&(r+=levelSelectScrollPos)<titleSelectOptions&&(titleSelection=r,titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateLevelSelectScreen())}}else if(3===titleMode){if(quittingTitleScreen||titleSelected)return;0===mouseCoordY&&(titleSelection=0,goToTitleScreen(),tryPlayTitleSound(),canvasResize())}else 4===titleMode&&generateTitleScreen()}else!1===messageselected&&state.levels[curlevel].message&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen())}else{if(winning)return;if(x1=x2,y1=y2,x2=mousePixelX,y2=mousePixelY,x2=Math.max(0,Math.min(cellwidth*screenwidth-1,mousePixelX)),y2=Math.max(0,Math.min(cellheight*screenheight-1,mousePixelY)),n){if(mouseCoordX>=0&&mouseCoordY>=0&&mouseCoordX<screenwidth&&mouseCoordY<screenheight){s=screenOffsetY+mouseCoordY+(screenOffsetX+mouseCoordX)*level.height;if(lastCoord=s,againing);else try{u=backupLevel();(c=level.getCell(s)).ibitset(t),level.setCell(s,c),pushInput(d=5),processInput(d,!1,!1,u)&&redraw()}catch(e){console.log(e),consolePrint(e,!0)}}}else for(var o=getTilesTraversingPoints(x1,y1,x2,y2),a=o.tileListX,i=o.tileListY,l=0;l<a.length;l++){var s=screenOffsetY+i[l]+(screenOffsetX+a[l])*level.height;if(lastCoord!==s)if(lastCoord=s,againing);else try{var c,d,u=backupLevel();(c=level.getCell(s)).ibitset(t),level.setCell(s,c),pushInput(d=5),processInput(d,!1,!1,u)&&redraw()}catch(e){console.log(e),consolePrint(e,!0)}}}}var anyEditsSinceMouseDown=!1;function onMouseDown(e,n=!1){if(!e.handled){ULBS();var t=0===e.button;e.button;if("touchstart"==e.type&&(t=!0),t&&(e.ctrlKey||e.metaKey)&&(t=!1,!0),t){if(lastDownTarget=e.target,keybuffer=[],e.target===canvas||"tapFocusIndicator"===e.target.className){if(setMouseCoord(e),dragging=!0,rightdragging=!1,anyEditsSinceMouseDown=!1,levelEditorOpened&&!textMode)return levelEditorClick(e,!0);if("mouse_left"in state.metadata)return n&&prevent(e),mouseAction(e,!0,state.lmbID)}dragging=!1,rightdragging=!1}else if(2===e.button||0===e.button&&(e.ctrlKey||e.metaKey))if("gameCanvas"===e.target.id){if(setMouseCoord(e),dragging=!1,rightdragging=!0,levelEditorOpened)return levelEditorRightClick(e,!0);if("mouse_right"in state.metadata)return mouseAction(e,!0,state.rmbID)}else dragging=!1,rightdragging=!1;else 1===e.button&&!1===textMode&&levelEditorOpened&&(pushInput("undo"),DoUndo(!1,!0),canvasResize());e.handled=!0}}function rightClickCanvas(e){return"mouse_right"in state.metadata||levelEditorOpened?prevent(e):void 0}function onMouseUp(e,n=!1){if(!e.handled){if(dragging=!1,rightdragging=!1,0===e.button){if(e.target===canvas&&(setMouseCoord(e),"mouse_up"in state.metadata))return n&&prevent(e),mouseAction(e,!0,state.lmbupID)}else if(2===e.button&&"gameCanvas"===e.target.id&&(setMouseCoord(e),"mouse_rup"in state.metadata))return mouseAction(e,!0,state.rmbupID);e.handled=!0}}function onKeyDown(e){ULBS(),e=e||window.event,!IDE&&[32,37,38,39,40].indexOf(e.keyCode)>-1&&(e&&(e.ctrlKey||e.metaKey)||prevent(e)),IDE||77!==e.keyCode||toggleMute(),keybuffer.indexOf(e.keyCode)>=0||((lastDownTarget===canvas||window.Mobile&&lastDownTarget===window.Mobile.focusIndicator)&&-1===keybuffer.indexOf(e.keyCode)&&(e&&(e.ctrlKey||e.metaKey)||(keybuffer.splice(keyRepeatIndex,0,e.keyCode),keyRepeatTimer=0,checkKey(e,!e.repeat))),!0===canDump&&(74===e.keyCode&&(e.ctrlKey||e.metaKey)?(dumpTestCase(),prevent(e)):75===e.keyCode&&(e.ctrlKey||e.metaKey)?(makeGIF(),prevent(e)):83===e.keyCode&&(e.ctrlKey||e.metaKey)?(saveClick(),prevent(e)):66===e.keyCode&&(e.ctrlKey||e.metaKey)?(rebuildClick(),prevent(e),e.target.blur(),canvas.focus()):82===e.keyCode&&(e.ctrlKey||e.metaKey)?(runClick(),prevent(e),e.target.blur(),canvas.focus()):120===e.keyCode?(prevent(e),solve()):119===e.keyCode?(prevent(e),stopSolving()):13===e.keyCode&&(e.ctrlKey||e.metaKey)&&(canvas.focus(),editor.display.input.blur(),e.shiftKey?runClick():rebuildClick(),prevent(e))))}function relMouseCoords(e){var n=0,t=0,r=0,o=0,a=this;do{n+=a.offsetLeft-a.scrollLeft,t+=a.offsetTop-a.scrollTop}while(a=a.offsetParent);return null==e.touches?(r=e.pageX-n,o=e.pageY-t):(r=e.touches[0].pageX-n,o=e.touches[0].pageY-t),{x:r,y:o}}function onKeyUp(e){e=e||window.event;var n=keybuffer.indexOf(e.keyCode);n>=0&&(keybuffer.splice(n,1),keyRepeatIndex>=n&&keyRepeatIndex--)}function onMyFocus(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function onMyBlur(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;var mouseCoordX=0,mouseCoordY=0,mousePixelX=0,mousePixelY=0;function setMouseCoord(e){var n=canvas.relMouseCoords(e);(isNaN(n.x)||isNaN(n.y))&&console.warn("[SetMouseCoord] Did not recieve valid mouse coords from event. Ignoring it (since I'm assuming this is a faked keypress that was generated on mobile)."),mousePixelX=n.x-xoffset,mousePixelY=n.y-yoffset,mouseCoordX=Math.floor(mousePixelX/cellwidth),mouseCoordY=Math.floor(mousePixelY/cellheight)}function mouseMove(e){if(!e.handled){if(levelEditorOpened)setMouseCoord(e),dragging?levelEditorClick(e,!1):rightdragging&&levelEditorRightClick(e,!1),redraw();else if(titleScreen&&IsMouseGameInputEnabled()){var n=hoverSelection;setMouseCoord(e),mouseAction(e,!1,null),n!=hoverSelection&&(1==titleMode?(generateTitleScreen(),redraw()):2==titleMode?(generateLevelSelectScreen(),redraw()):3==titleMode&&(generateCreditsScreen(),redraw()))}else dragging&&"mouse_drag"in state.metadata?(setMouseCoord(e),mouseAction(e,!1,state.dragID),redraw()):rightdragging&&"mouse_rdrag"in state.metadata&&(setMouseCoord(e),mouseAction(e,!1,state.rdragID),redraw());e.handled=!0}}function onMouseIn(){mouseInCanvas=!0}function onMouseOut(){mouseInCanvas=!1}function onTouchDown(e){onMouseDown(e,!0)}function onTouchUp(e){onMouseUp(e,!0)}function onMouseWheel(e){mouseInCanvas&&!e.ctrlKey&&(normalizedDelta=Math.sign(e.deltaY),titleScreen&&2==titleMode&&IsMouseGameInputEnabled()&&(levelSelectScroll(normalizedDelta),redraw(),prevent(e)),levelEditorOpened&&(glyphSelectedIndex=clamp(glyphSelectedIndex+normalizedDelta,0,glyphCount()-1),redraw(),prevent(e)))}function levelSelectScroll(e){levelSelectScrollPos=clamp(levelSelectScrollPos+e,0,Math.max(state.sections.length-amountOfLevelsOnScreen,0)),titleSelection=clamp(titleSelection+e,0,state.sections.length-1),generateLevelSelectScreen()}function clamp(e,n,t){return Math.min(Math.max(e,n),t)}function prevent(e){return e.preventDefault&&e.preventDefault(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,!1}function titleButtonSelected(){!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),canvasResize(),document.dispatchEvent(new Event("psplusGameStarted")))}mouseInCanvas=!1,document.addEventListener("touchstart",onTouchDown,{passive:!1}),document.addEventListener("touchmove",mouseMove,!1),document.addEventListener("touchend",onTouchUp,{passive:!1}),document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mouseup",onMouseUp,!1),document.addEventListener("mousemove",mouseMove,!1),document.addEventListener("contextmenu",rightClickCanvas,!1),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),document.addEventListener("wheel",onMouseWheel,{passive:!1}),window.addEventListener("focus",onMyFocus,!1),window.addEventListener("blur",onMyBlur,!1),canvas.addEventListener("mouseenter",onMouseIn,!1),canvas.addEventListener("mouseleave",onMouseOut,!1);var gamepadKeys=[];function pollGamepads(){function e(e,n){return!(e.length<n)&&("object"==typeof e[n]?e[n].pressed:1==e[n])}function n(e,n,t){return!(e.length<n)&&e[n]*t>.5}var t=[];function r(e){-1===keybuffer.indexOf(e)&&(keybuffer.splice(keyRepeatIndex,0,e),keyRepeatTimer=0,checkKey({keyCode:e},!0)),t.splice(0,0,e)}function o(){for(var e=0;e<gamepadKeys.length;e++)if(!(t.indexOf(gamepadKeys[e])>=0)){var n=keybuffer.indexOf(gamepadKeys[e]);n>=0&&(keybuffer.splice(n,1),keyRepeatIndex>=n&&keyRepeatIndex--)}gamepadKeys=t}var a=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];if(null!=a&&0!=a.length){for(var i=0;i<a.length;i++){var l=a[i];null!=l&&l.connected&&((e(l.buttons,3)||e(l.buttons,4))&&r(82),(e(l.buttons,1)||n(l.axes,2,1))&&r(90),(e(l.buttons,2)||e(l.buttons,0)||e(l.buttons,5)||n(l.axes,1,1))&&r(88),e(l.buttons,7)&&r(27),e(l.buttons,6)&&r(69),(n(l.axes,0,1)||n(l.axes,6,1))&&r(39),(n(l.axes,0,-1)||n(l.axes,6,-1))&&r(37),(n(l.axes,1,-1)||n(l.axes,7,-1))&&r(38),(n(l.axes,1,1)||n(l.axes,7,1))&&r(40))}o()}else o()}function checkKey(e,n){if(ULBS(),!(winning||e&&(e.ctrlKey||e.metaKey||e.altKey))){var t=-1;switch(e.keyCode){case 65:case 37:t=1;break;case 38:case 87:t=0;break;case 68:case 39:t=3;break;case 83:case 40:t=2;break;case 80:printLevel();break;case 13:case 32:case 67:case 88:if(n&&ignoreNotJustPressedAction&&(ignoreNotJustPressedAction=!1),!1===n&&ignoreNotJustPressedAction)return;if(!1!==norepeat_action&&!n)return;t=4;break;case 85:case 90:if(!1===textMode)return pushInput("undo"),DoUndo(!1,!0),canvasResize(),prevent(e);break;case 82:if(!1===textMode&&n)return pushInput("restart"),DoRestart(),canvasResize(),prevent(e);break;case 27:if(solving){stopSolving();break}if(!1===titleScreen||titleMode>1)return(timer/1e3>.5||titleMode>1)&&!quittingTitleScreen&&(titleSelection=0,timer=0,!1===titleScreen&&void 0!==state.metadata.level_select?gotoLevelSelectScreen():goToTitleScreen(),tryPlayTitleSound(),canvasResize()),prevent(e);break;case 69:if(!solving&&canOpenEditor)return n&&(titleScreen&&("EMPTY GAME"===state.title?compile(["loadFirstNonMessageLevel"]):nextLevel()),!1===(levelEditorOpened=!levelEditorOpened)&&printLevel(),restartTarget=backupLevel(),canvasResize()),prevent(e);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(levelEditorOpened&&n){var r=9;return e.keyCode>=49&&(r=e.keyCode-49),r<glyphImages.length?glyphSelectedIndex=r:consolePrint("Trying to select tile outside of range in level editor.",!0),canvasResize(),prevent(e)}break;case 189:if(levelEditorOpened&&n&&glyphSelectedIndex>0)return glyphSelectedIndex--,canvasResize(),prevent(e);break;case 187:if(levelEditorOpened&&n&&glyphSelectedIndex+1<glyphImages.length)return glyphSelectedIndex++,canvasResize(),prevent(e)}if(throttle_movement&&t>=0&&t<=3){if(lastinput==t&&input_throttle_timer<repeatinterval)return;lastinput=t,input_throttle_timer=0}if(textMode);else if(!againing&&t>=0)return 4===t&&"noaction"in state.metadata||(pushInput(t),processInput(t)&&redraw()),prevent(e)}}function update(){var e=!1;if(timer+=deltatime,tweentimer+=deltatime,input_throttle_timer+=deltatime,quittingTitleScreen&&(2==titleMode?(quittingTitleScreen=!1,gotoLevel(titleSelection)):timer/1e3>.3&&(quittingTitleScreen=!1,titleMode<=1&&nextLevel())),againing&&timer>againinterval&&0==messagetext.length&&processInput(-1)&&(e=!0,keyRepeatTimer=0,autotick=0),quittingMessageScreen&&timer/1e3>.15&&(quittingMessageScreen=!1,""===messagetext?nextLevel():(messagetext="",textMode=!1,titleScreen=!1,titleMode=curlevel>0||null!==curlevelTarget?1:0,titleSelected=!1,ignoreNotJustPressedAction=!0,titleSelection=0,canvasResize(),checkWin())),winning&&timer/1e3>.5&&(winning=!1,nextLevel()),pollGamepads(),keybuffer.length>0){keyRepeatTimer+=deltatime;var n=throttle_movement?repeatinterval:repeatinterval/Math.sqrt(keybuffer.length);if(keyRepeatTimer>n)keyRepeatTimer=0,keyRepeatIndex=(keyRepeatIndex+1)%keybuffer.length,checkKey({keyCode:keybuffer[keyRepeatIndex]},!1)}!(autotickinterval>0)||textMode||levelEditorOpened||againing||winning||(autotick+=deltatime)>autotickinterval&&(autotick=0,pushInput("tick"),processInput(-1)&&(e=!0)),(e||void 0!==state&&(void 0!==state.metadata.smoothscreen||void 0!==state.metadata.tween_length))&&redraw()}var looping=!1,loop=function(){looping=!0;try{update()}catch(e){console.error(e)}"hidden"!==document.visibilityState?setTimeout(loop,deltatime):looping=!1};function Animatable(e,n,t){var r;function o(){var e;return(r+=n)>=1&&(e=!0,r=1),t(r),e}function a(){var e;return(r-=n)<=0&&(e=!0,r=0),t(r),e}return r=0,{animateUp:function(){Animator.getInstance().animate(e,o)},animateDown:function(){Animator.getInstance().animate(e,a)}}}document.addEventListener("visibilitychange",(function(){"visible"===document.visibilityState&&!1===looping&&loop()})),loop(),window.Mobile={},Mobile.hasTouch=function(){var e;return("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)&&(e=!0),e},Mobile.enable=function(e){return(e||Mobile.hasTouch()&&!Mobile._instance)&&(Mobile._instance=new Mobile.GestureHandler,Mobile._instance.bindEvents(),Mobile._instance.bootstrap()),Mobile._instance},window.Mobile.GestureHandler=function(){this.initialize.apply(this,arguments)},Mobile.log=function(e){document.getElementsByTagName("h1")[0].innerHTML=Math.random().toString().substring(4,1)+"-"+e},Mobile.debugDot=function(e){var n,t;t="border-radius: 50px;width: 5px;height: 5px;background: red;position: absolute;left: "+e.touches[0].clientX+"px;top: "+e.touches[0].clientY+"px;",(n=document.createElement("div")).setAttribute("style",t),document.getElementsByTagName("body")[0].appendChild(n)},function(e){var n={action:88,left:37,right:39,up:38,down:40,undo:85,restart:82,quit:27},t=['<div class="tab">','  <div class="tab-affordance"></div>','  <div class="tab-icon">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>","</div>"].join("\n");e.initialize=function(){this.firstPos={x:0,y:0},this.setTabAnimationRatio=this.setTabAnimationRatio.bind(this),this.setMenuAnimationRatio=this.setMenuAnimationRatio.bind(this),this.repeatTick=this.repeatTick.bind(this),this.isFocused=!0},e.setFocusElement=function(e){this.focusElement=e,this.isFocused=!1,this.buildFocusIndicator()},e.bindEvents=function(){window.addEventListener("touchstart",this.onTouchStart.bind(this)),window.addEventListener("touchend",this.onTouchEnd.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this))},e.bootstrap=function(){this.showTab(),this.disableScrolling(),this.isAudioSupported()||this.disableAudio(),this.disableSelection()},e.onTouchStart=function(e){this.isTouching||(this.handleFocusChange(e),this.isFocused&&"A"!==e.target.tagName.toUpperCase()&&(this.isTouching=!0,this.mayBeSwiping=!0,this.gestured=!1,this.swipeDirection=void 0,this.swipeDistance=0,this.startTime=(new Date).getTime(),this.firstPos.x=e.touches[0].clientX,this.firstPos.y=e.touches[0].clientY))},e.onTouchEnd=function(e){this.isFocused&&this.isTouching&&(this.gestured||0===e.touches.length&&"unMuteButton"!==e.target.id&&"muteButton"!==e.target.id&&this.handleTap(),0===e.touches.length&&(this.isTouching=!1,this.endRepeatWatcher()))},e.onTouchMove=function(e){if(this.isFocused&&!levelEditorOpened)return this.isSuccessfulSwipe()?(this.handleSwipe(this.swipeDirection,this.touchCount),this.gestured=!0,this.mayBeSwiping=!1,this.beginRepeatWatcher(e)):this.mayBeSwiping?this.swipeStep(e):this.isRepeating&&this.repeatStep(e),prevent(e),!1},e.handleFocusChange=function(e){this.focusElement&&(this.isFocused=this.isTouchInsideFocusElement(e),this.setFocusIndicatorVisibility(this.isFocused),canvas.focus(),editor.display.input.blur())},e.isTouchInsideFocusElement=function(e){var n;return!(!e.touches||!e.touches[0])&&(n=this.absoluteElementPosition(this.focusElement),!(e.touches[0].clientX<n.left||e.touches[0].clientY<n.top)&&!(e.touches[0].clientX>n.left+this.focusElement.clientWidth||e.touches[0].clientY>n.top+this.focusElement.clientHeight))},e.setFocusIndicatorVisibility=function(e){},e.absoluteElementPosition=function(e){var n,t;for(n={top:e.offsetTop||0,left:e.offsetLeft||0},t=document.getElementsByTagName("body")[0],n.top-=t.scrollTop||0;e=e.offsetParent;)n.top+=e.offsetTop||0,n.left+=e.offsetLeft||0;return n},e.beginRepeatWatcher=function(e){var n;this.repeatInterval||(this.isRepeating=!0,n=1e3*state.metadata.key_repeat_interval,!isNaN(n)&&n||(n=150),this.repeatInterval=setInterval(this.repeatTick,n),this.recenter(e))},e.endRepeatWatcher=function(){this.repeatInterval&&(clearInterval(this.repeatInterval),delete this.repeatInterval,this.isRepeating=!1)},e.repeatTick=function(){this.isTouching&&this.handleSwipe(this.direction,this.touchCount)},e.recenter=function(e){this.firstPos.x=e.touches[0].clientX,this.firstPos.y=e.touches[0].clientY},e.isSuccessfulSwipe=function(){var e;return this.mayBeSwiping&&void 0!==this.swipeDirection&&this.swipeDistance>=50&&(e=!0),e},e.swipeStep=function(e){var n,t,r;this.mayBeSwiping&&(n={x:e.touches[0].clientX,y:e.touches[0].clientY},t=(new Date).getTime(),r=e.touches.length,this.swipeDistance=this.cardinalDistance(this.firstPos,n),this.swipeDirection?t-this.startTime>1e3&&(this.mayBeSwiping=!1):this.swipeDistance>10&&(this.swipeDirection=this.dominantDirection(this.firstPos,n),this.touchCount=r))},e.repeatStep=function(e){var n;n={x:e.touches[0].clientX,y:e.touches[0].clientY},this.cardinalDistance(this.firstPos,n)>=50&&(this.swipeDirection=this.dominantDirection(this.firstPos,n),this.recenter(e))},e.cardinalDistance=function(e,n){var t,r;return t=Math.abs(e.x-n.x),r=Math.abs(e.y-n.y),Math.max(t,r)},e.dominantDirection=function(e,n){var t,r,o;return t=n.x-e.x,r=n.y-e.y,o="x",Math.abs(r)>Math.abs(t)&&(o="y"),"x"===o?t>0?"right":"left":r>0?"down":"up"},e.handleSwipe=function(e,n){IsMouseGameInputEnabled()||(1===n?this.emitKeydown(this.swipeDirection):n>1&&this.toggleMenu())},e.handleTap=function(){IsMouseGameInputEnabled()||this.emitKeydown("action")},e.emitKeydown=function(e){var t;(this.isMenuVisible||"undo"!=e&&"restart"!=e&&"quit"!=e)&&(t={keyCode:n[e]},this.fakeCanvasFocus(),onKeyDown(t),onKeyUp(t))},e.fakeCanvasFocus=function(){onMouseDown({button:0,target:document.getElementById("gameCanvas")})},e.toggleMenu=function(){this.isMenuVisible?this.hideMenu():this.showMenu()},e.showMenu=function(){this.menuElem||this.buildMenu(),this.getAnimatables().menu.animateUp(),this.isMenuVisible=!0,this.hideTab()},e.hideMenu=function(){this.menuElem&&this.getAnimatables().menu.animateDown(),this.isMenuVisible=!1,this.showTab()},e.getAnimatables=function(){return this._animatables||(this._animatables={tab:Animatable("tab",.1,this.setTabAnimationRatio),menu:Animatable("menu",.1,this.setMenuAnimationRatio)}),this._animatables},e.showTab=function(){this.tabElem||this.buildTab(),this.getAnimatables().tab.animateDown()},e.hideTab=function(){this.tabElem&&this.tabElem.setAttribute("style","display: none;"),this.getAnimatables().tab.animateUp()},e.buildTab=function(){var e,n,r,o=this;(e=document.createElement("div")).innerHTML=t,r=e.children[0],n=function(e){e.stopPropagation(),o.showMenu()},this.tabAffordance=r.getElementsByClassName("tab-affordance")[0],this.tabElem=r.getElementsByClassName("tab-icon")[0],this.tabAffordance.addEventListener("touchstart",n),this.tabAffordance.addEventListener("click",(e=>{})),this.tabElem.addEventListener("touchstart",n),this.tabElem.addEventListener("click",(e=>{})),document.getElementsByTagName("body")[0].appendChild(r)},e.buildMenu=function(){var e,n,t,r,o,a,i=this;(e=document.createElement("div")).innerHTML=this.buildMenuString(state),this.menuElem=e.children[0],this.closeElem=this.menuElem.getElementsByClassName("close")[0],a=function(e){e.stopPropagation(),i.hideMenu()},this.closeAffordance=this.menuElem.getElementsByClassName("close-affordance")[0],o=this.menuElem.getElementsByClassName("close")[0],this.closeAffordance.addEventListener("touchstart",a),this.closeAffordance.addEventListener("click",(e=>{})),o.addEventListener("touchstart",a),o.addEventListener("click",(e=>{})),(n=this.menuElem.getElementsByClassName("undo")[0])&&(n.addEventListener("touchstart",(function(e){e.stopPropagation(),i.emitKeydown("undo")})),n.addEventListener("click",(e=>{}))),(t=this.menuElem.getElementsByClassName("restart")[0])&&(t.addEventListener("touchstart",(function(e){e.stopPropagation(),i.emitKeydown("restart")})),t.addEventListener("click",(e=>{}))),(r=this.menuElem.getElementsByClassName("quit")[0]).addEventListener("touchstart",(function(e){e.stopPropagation(),i.emitKeydown("quit")})),r.addEventListener("click",(e=>{})),document.getElementsByTagName("body")[0].appendChild(this.menuElem)},e.buildMenuString=function(e){var n,t,r,o;return n=3,(r=e.metadata.noundo)&&(n-=1),(o=e.metadata.norestart)&&(n-=1),t=['<div class="mobile-menu item-count-'+n+'">','  <div class="close-affordance"></div>','  <div class="close">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>"],r||t.push('  <div class="undo button">Undo</div>'),o||t.push('  <div class="restart button">Restart</div>'),(t=t.concat(['  <div class="quit button">Quit to Menu</div>','  <div class="clear"></div>',"</div>"])).join("\n")},e.buildFocusIndicator=function(){this.focusIndicator=document.createElement("DIV"),this.focusIndicator.setAttribute("class","tapFocusIndicator"),this.focusIndicator.setAttribute("style","visibility: hidden;"),this.focusElement.parentNode.appendChild(this.focusIndicator)},e.setTabAnimationRatio=function(e){var n;(e=Math.round(1e3*e)/1e3)>=.999?this.tabAffordance.setAttribute("style","display: none;"):this.tabAffordance.setAttribute("style","display: block;"),n="opacity: "+(1-e)+";"+" width: "+(66*e+18*(1-e))+"px;",this.tabElem.setAttribute("style",n)},e.setMenuAnimationRatio=function(e){var n,t,r;r="left: "+((n=-18*(e=Math.round(1e3*e)/1e3)+-66*(1-e))-4)+"px; "+(t="opacity: "+e+";")+" width: "+-n+"px;",(e=Math.round(1e3*e)/1e3)<=.001?(this.closeAffordance.setAttribute("style","display: none;"),t="display:none;"):this.closeAffordance.setAttribute("style","display: block;"),this.closeElem.setAttribute("style",r),this.menuElem.setAttribute("style",t)},e.disableScrolling=function(){var e={height:"100%",overflow:"hidden",position:"fixed",width:"100%"},n="";for(var t in e)n+=t+": "+e[t]+"; ";document.body.setAttribute("style",n)},e.disableAudio=function(){window.playSeed=function(){}},e.isAudioSupported=function(){var e=!0;return"undefined"!=typeof webkitAudioContext&&(e=!1),e},e.disableSelection=function(){var e;(e=document.getElementsByTagName("body")[0]).setAttribute("class",e.getAttribute("class")+" disable-select")}}(window.Mobile.GestureHandler.prototype),window.Animator=function(){this.initialize.apply(this,arguments)},function(e){e.initialize=function(){this._animations={},this.tick=this.tick.bind(this)},e.animate=function(e,n){this._animations[e]=n,this.wakeup()},e.wakeup=function(){this._isAnimating||(this._isAnimating=!0,this.tick())},e.tick=function(){var e,n,t;for(e in t=[],n=!0,this._animations){if(!this._animations.hasOwnProperty(e))return;this._animations[e]()?t.push(e):n=!1}if(n){for(0;0<t.length;t++)delete this._isAnimating[t[0]];this._isAnimating=!1}else requestAnimationFrame(this.tick)}}(window.Animator.prototype),window.Animator.getInstance=function(){return window.Animator._instance||(window.Animator._instance=new window.Animator),window.Animator._instance},function(){var e,n,t=["ms","moz","webkit","o"];for(e=0;e<t.length&&!window.requestAnimationFrame;e++)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"],window.cancelAnimationFrame||(window.cancelAnimationFrame=window[t[e]+"CancelRequestAnimationFrame"]);window.requestAnimationFrame||(n=0,window.requestAnimationFrame=function(e,t){var r,o,a;return r=(new Date).getTime(),o=Math.max(0,16-(r-n)),a=window.setTimeout((function(){e(r+o)}),o),n=r+o,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)}),Mobile.enable()}();
//# sourceMappingURL=scripts_play_compiled.js.map